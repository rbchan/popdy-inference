\documentclass[color=usenames,dvipsnames]{beamer}\usepackage[]{graphicx}\usepackage[]{color}
% maxwidth is the original width if it is less than linewidth
% otherwise use linewidth (to make sure the graphics do not exceed the margin)
\makeatletter
\def\maxwidth{ %
  \ifdim\Gin@nat@width>\linewidth
    \linewidth
  \else
    \Gin@nat@width
  \fi
}
\makeatother

\definecolor{fgcolor}{rgb}{0, 0, 0}
\newcommand{\hlnum}[1]{\textcolor[rgb]{0.69,0.494,0}{#1}}%
\newcommand{\hlstr}[1]{\textcolor[rgb]{0.749,0.012,0.012}{#1}}%
\newcommand{\hlcom}[1]{\textcolor[rgb]{0.514,0.506,0.514}{\textit{#1}}}%
\newcommand{\hlopt}[1]{\textcolor[rgb]{0,0,0}{#1}}%
\newcommand{\hlstd}[1]{\textcolor[rgb]{0,0,0}{#1}}%
\newcommand{\hlkwa}[1]{\textcolor[rgb]{0,0,0}{\textbf{#1}}}%
\newcommand{\hlkwb}[1]{\textcolor[rgb]{0,0.341,0.682}{#1}}%
\newcommand{\hlkwc}[1]{\textcolor[rgb]{0,0,0}{\textbf{#1}}}%
\newcommand{\hlkwd}[1]{\textcolor[rgb]{0.004,0.004,0.506}{#1}}%
\let\hlipl\hlkwb

\usepackage{framed}
\makeatletter
\newenvironment{kframe}{%
 \def\at@end@of@kframe{}%
 \ifinner\ifhmode%
  \def\at@end@of@kframe{\end{minipage}}%
  \begin{minipage}{\columnwidth}%
 \fi\fi%
 \def\FrameCommand##1{\hskip\@totalleftmargin \hskip-\fboxsep
 \colorbox{shadecolor}{##1}\hskip-\fboxsep
     % There is no \\@totalrightmargin, so:
     \hskip-\linewidth \hskip-\@totalleftmargin \hskip\columnwidth}%
 \MakeFramed {\advance\hsize-\width
   \@totalleftmargin\z@ \linewidth\hsize
   \@setminipage}}%
 {\par\unskip\endMakeFramed%
 \at@end@of@kframe}
\makeatother

\definecolor{shadecolor}{rgb}{.97, .97, .97}
\definecolor{messagecolor}{rgb}{0, 0, 0}
\definecolor{warningcolor}{rgb}{1, 0, 1}
\definecolor{errorcolor}{rgb}{1, 0, 0}
\newenvironment{knitrout}{}{} % an empty environment to be redefined in TeX

\usepackage{alltt}
%\documentclass[color=usenames,dvipsnames,handout]{beamer}

\usepackage[roman]{../lectures}
%\usepackage[sans]{../lectures}


\hypersetup{pdfpagemode=UseNone,pdfstartview={FitV}}


\title{Lecture 4 -- Occuancy models: simulation and fitting }
\author{Richard Chandler}


% Load function to compile and open PDF


% Compile and open PDF







%<<knitr-setup,include=FALSE,purl=FALSE>>=
%##opts_chunk$set(comment=NA)
%@


%% New command for inline code that isn't to be evaluated
\definecolor{inlinecolor}{rgb}{0.878, 0.918, 0.933}
\newcommand{\inr}[1]{\colorbox{inlinecolor}{\texttt{#1}}}
\IfFileExists{upquote.sty}{\usepackage{upquote}}{}
\begin{document}






\begin{frame}[plain]
  \LARGE
%  \maketitle
  \centering
  {\huge Lecture 4 -- Occupancy models: simulation and fitting} \\
  {\color{default} \rule{\textwidth}{0.1pt}}
  \vfill
  \large
  WILD(FISH) 8390 \\
  Estimation of Fish and Wildlife Population Parameters \\
  \vfill
  \large
  Richard Chandler \\
  University of Georgia \\
\end{frame}






\section{Motivation}



\begin{frame}[plain]
  \frametitle{Outline}
  \Large
  \only<1>{\tableofcontents}%[hideallsubsections]}
  \only<2 | handout:0>{\tableofcontents[currentsection]}%,hideallsubsections]}
\end{frame}



\begin{frame}
  \frametitle{Motivation}
  We often want to do logistic regression, but the data are subject
  to measurement error. \\  
  \pause
  \vfill
  Specifically, wildlife data are often fraught with false negatives
  (ie, the species was there but we didn't detect it). \\
  \pause
  \vfill
  Ignoring this source of measurement error can result in misleading
  inferences. \\
\end{frame}


\begin{frame}
  \frametitle{Ignoring detection probability}
  Show some examples
\end{frame}



\begin{frame}
  \frametitle{Accounting for detection probability}
  \small
  The model for the state process is the same as logistic regression:
  \begin{gather*}
    \mathrm{logit}(\psi_i) = \beta_0 + \beta_1 x_{i1} + \beta_2 x_{i2} + \cdots \\
    z_i \sim \mathrm{Bern}(\psi_i)
  \end{gather*}
  \pause
  \vfill
  Model for the observation process conditional on the state process:
  \begin{gather*}
    \mathrm{logit}(p_{ij}) = \alpha_0 + \alpha_1 x_{ij1} + \alpha_2 x_{ij2} + \cdots \\
    y_{ij} \sim \mathrm{Bern}(z_i\times p_{ij})
  \end{gather*}
  \pause
%  \vfill
%  \small
  Definitions \\
  $\psi_i$ -- probability that the species occurs at site $i$ \\
  $z_i$ -- binary presence/absence variable at site $i$ \\
  $p_{ij}$ -- probability of detecting the species at site $i$ on occasion $j$ \\
  $y_{ij}$ -- binary detection/non-detection data
\end{frame}


\section{Simulation}



\begin{frame}
  \frametitle{Outline}
  \Large
  \tableofcontents[currentsection]
\end{frame}


\begin{frame}[fragile]
  \frametitle{Simulation}
  Simplest case with no covariates: \\
  \vfill
  \begin{enumerate}[<+->]
  \item Specify the parameters and dimensions
\begin{knitrout}\small
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{psi} \hlkwb{<-} \hlnum{0.4}       \hlcom{## Occurrence probability}
\hlstd{p} \hlkwb{<-} \hlnum{0.2}         \hlcom{## Detection probability}
\hlstd{nSites} \hlkwb{<-} \hlnum{20}
\hlstd{nVisits} \hlkwb{<-} \hlnum{4}
\end{alltt}
\end{kframe}
\end{knitrout}
  \item Now, simulate presence-absence
\begin{knitrout}\small
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlkwd{set.seed}\hlstd{(}\hlnum{3439}\hlstd{)}    \hlcom{## Just to make it reproducible}
\hlstd{z} \hlkwb{<-} \hlkwd{rbinom}\hlstd{(nSites,} \hlkwc{size}\hlstd{=}\hlnum{1}\hlstd{, psi)} \hlcom{## pres/absence}
\end{alltt}
\end{kframe}
\end{knitrout}
  \item Simulate observations
\begin{knitrout}\small
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{y} \hlkwb{<-} \hlkwd{matrix}\hlstd{(}\hlnum{NA}\hlstd{,} \hlkwc{nrow}\hlstd{=nSites,} \hlkwc{ncol}\hlstd{=nVisits)}
\hlkwa{for}\hlstd{(i} \hlkwa{in} \hlnum{1}\hlopt{:}\hlstd{nSites) \{}
    \hlstd{y[i,]} \hlkwb{<-} \hlkwd{rbinom}\hlstd{(nVisits,} \hlkwc{size}\hlstd{=}\hlnum{1}\hlstd{,} \hlkwc{prob}\hlstd{=z[i]}\hlopt{*}\hlstd{p)}
\hlstd{\}}
\end{alltt}
\end{kframe}
\end{knitrout}
\end{enumerate}
\end{frame}




\begin{frame}[fragile]
  \frametitle{Simulated data}
  \begin{columns}
    \begin{column}{0.4\textwidth}
      \small
      Observations
%      \tiny
\begin{knitrout}\scriptsize
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{y}
\end{alltt}
\begin{verbatim}
##       [,1] [,2] [,3] [,4]
##  [1,]    0    0    0    0
##  [2,]    0    0    0    0
##  [3,]    1    0    0    0
##  [4,]    0    0    0    0
##  [5,]    0    0    0    0
##  [6,]    0    0    0    0
##  [7,]    0    0    0    0
##  [8,]    0    0    0    0
##  [9,]    0    1    1    0
## [10,]    0    0    0    0
## [11,]    0    0    0    0
## [12,]    0    0    0    0
## [13,]    0    0    0    0
## [14,]    0    0    0    0
## [15,]    0    0    0    0
## [16,]    0    0    0    0
## [17,]    0    0    0    0
## [18,]    0    0    0    0
## [19,]    0    0    0    0
## [20,]    0    1    0    1
\end{verbatim}
\end{kframe}
\end{knitrout}
  \end{column}
  \begin{column}{0.6\textwidth}
    \pause
%    \scriptsize
    {\centering Summary stats \\}
    \vspace{24pt}
  Detections at each site \\
\begin{knitrout}\scriptsize
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{siteDets} \hlkwb{<-} \hlkwd{rowSums}\hlstd{(y)} \hlcom{# Dets at each site}
\hlkwd{table}\hlstd{(siteDets)}        \hlcom{# Frequency}
\end{alltt}
\begin{verbatim}
## siteDets
##  0  1  2 
## 17  1  2
\end{verbatim}
\end{kframe}
\end{knitrout}
\pause
\vfill
\small
Proportion of sites known to be occupied \\
\begin{knitrout}\scriptsize
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{naiveOccupancy} \hlkwb{<-} \hlkwd{sum}\hlstd{(siteDets}\hlopt{>}\hlnum{0}\hlstd{)}\hlopt{/}\hlstd{nSites}
\hlstd{naiveOccupancy}
\end{alltt}
\begin{verbatim}
## [1] 0.15
\end{verbatim}
\end{kframe}
\end{knitrout}
  \end{column}
  \end{columns}
\end{frame}



\section{Model fitting}



\begin{frame}
  \frametitle{Outline}
  \Large
  \tableofcontents[currentsection]
\end{frame}



\subsection{Likelihood-based methods}


\begin{frame}
  \frametitle{Likelihood-based methods}
  
\end{frame}

\begin{frame}[fragile]
  \frametitle{R package `unmarked'}
%  \small
Install and load the package  \\
\begin{knitrout}
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlcom{## install.packages("unmarked")  }
\hlkwd{library}\hlstd{(unmarked)}
\end{alltt}
\end{kframe}
\end{knitrout}
\pause
\vfill
Documentation (help files) \\
\begin{knitrout}
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlkwd{help}\hlstd{(}\hlstr{"unmarked"}\hlstd{)}
\end{alltt}
\end{kframe}
\end{knitrout}
\vfill
Documentation (vignettes) \\
\begin{knitrout}
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlkwd{print}\hlstd{(}\hlkwd{vignette}\hlstd{(}\hlkwc{package}\hlstd{=}\hlstr{"unmarked"}\hlstd{))}
\hlcom{## vignette("spp-dist")}
\end{alltt}
\end{kframe}
\end{knitrout}
\end{frame}





\begin{frame}[fragile]
  \frametitle{R package `unmarked'}
%  \small
  Unlike standard model fitting functions like \inr{lm} and \inr{glm} 
  that require data to be in \texttt{data.frames}, data for `unmarked'
  has to be formatted in an \inr{unmarkedFrame}.
\begin{knitrout}\small
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{umf} \hlkwb{<-} \hlkwd{unmarkedFrameOccu}\hlstd{(}\hlkwc{y}\hlstd{=y)}
\hlkwd{summary}\hlstd{(umf)}
\end{alltt}
\begin{verbatim}
## unmarkedFrame Object
## 
## 20 sites
## Maximum number of observations per site: 4 
## Mean number of observations per site: 4 
## Sites with at least one detection: 3 
## 
## Tabulation of y observations:
##  0  1 
## 75  5
\end{verbatim}
\end{kframe}
\end{knitrout}
\end{frame}





\begin{frame}[fragile]
  \frametitle{R package `unmarked'}
  \small
Fit the single-season occupancy model
\begin{knitrout}\scriptsize
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{fm} \hlkwb{<-} \hlkwd{occu}\hlstd{(}\hlopt{~}\hlnum{1} \hlopt{~}\hlnum{1}\hlstd{, umf)}
\hlkwd{summary}\hlstd{(fm)}
\end{alltt}
\begin{verbatim}
## 
## Call:
## occu(formula = ~1 ~ 1, data = umf)
## 
## Occupancy (logit-scale):
##  Estimate    SE     z P(>|z|)
##     -1.47 0.723 -2.04  0.0414
## 
## Detection (logit-scale):
##  Estimate    SE      z P(>|z|)
##    -0.684 0.768 -0.891   0.373
## 
## AIC: 36.25049 
## Number of sites: 20
## optim convergence code: 0
## optim iterations: 9 
## Bootstrap iterations: 0
\end{verbatim}
\end{kframe}
\end{knitrout}
\end{frame}



\begin{frame}[fragile]
  \frametitle{R package `unmarked'}
Occupancy estimate ($\hat{\psi}$)
\begin{knitrout}\footnotesize
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlkwd{backTransform}\hlstd{(fm,} \hlkwc{type}\hlstd{=}\hlstr{"state"}\hlstd{)}
\end{alltt}
\begin{verbatim}
## Backtransformed linear combination(s) of Occupancy estimate(s)
## 
##  Estimate   SE LinComb (Intercept)
##     0.186 0.11   -1.47           1
## 
## Transformation: logistic
\end{verbatim}
\end{kframe}
\end{knitrout}
\pause
\vfill
Detection probability estimate ($\hat{p}$)
\begin{knitrout}\footnotesize
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlkwd{backTransform}\hlstd{(fm,} \hlkwc{type}\hlstd{=}\hlstr{"det"}\hlstd{)}
\end{alltt}
\begin{verbatim}
## Backtransformed linear combination(s) of Detection estimate(s)
## 
##  Estimate    SE LinComb (Intercept)
##     0.335 0.171  -0.684           1
## 
## Transformation: logistic
\end{verbatim}
\end{kframe}
\end{knitrout}
\end{frame}


\begin{frame}[fragile]
  \frametitle{R package `unmarked'}
  There are two types of occupancy estimates. \\
  \begin{enumerate}%[<+->]
  \item<1-> Unconditional occupancy $\psi=\Pr(z=1)$
    \begin{itemize}
      \item<1-> The estimate $\hat{\psi}$ that we computed earlier can be
        thought of as a prediction that we could use for a new
        site or a new time period
    \end{itemize}
  \item<2-> Conditional occupancy $\psi^* = \Pr(z_i=1|y_{i})$
    \begin{itemize}
      \item<2-> Conditional occupancy estimates only apply to sites in the
        sample, at the time of sampling
      \item<3-> Conditional occupancy is computed using Empirical Bayes
        methods, with the \inr{ranef} and \inr{bup} functions.
      \item<4-> These can be used to answer questions like:
        \begin{itemize}
          \item Which sites were occupied?
          \item How many sites were occupied?
        \end{itemize}
    \end{itemize}
  \item<5->[]  
%\pause
\begin{knitrout}\scriptsize
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlcom{## Posterior probs Pr(z_i=1)       }
\hlstd{z.post} \hlkwb{<-} \hlkwd{ranef}\hlstd{(fm)}
\hlcom{## Extract posterior means}
\hlstd{psi.conditional} \hlkwb{<-}  \hlkwd{bup}\hlstd{(z.post,} \hlkwc{stat}\hlstd{=}\hlstr{"mean"}\hlstd{)}
\end{alltt}
\end{kframe}
\end{knitrout}
  \end{enumerate}
\end{frame}


\begin{frame}[fragile]
  \frametitle{R package `unmarked'}
\begin{knitrout}\scriptsize
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlkwd{round}\hlstd{(}\hlkwd{data.frame}\hlstd{(}\hlkwc{y}\hlstd{=y,} \hlkwc{psi.unconditional}\hlstd{=}\hlkwd{predict}\hlstd{(fm,} \hlkwc{type}\hlstd{=}\hlstr{"state"}\hlstd{)[,}\hlnum{1}\hlstd{],}
                 \hlstd{psi.conditional),} \hlnum{3}\hlstd{)}
\end{alltt}
\begin{verbatim}
##    y.1 y.2 y.3 y.4 psi.unconditional psi.conditional
## 1    0   0   0   0             0.186           0.043
## 2    0   0   0   0             0.186           0.043
## 3    1   0   0   0             0.186           1.000
## 4    0   0   0   0             0.186           0.043
## 5    0   0   0   0             0.186           0.043
## 6    0   0   0   0             0.186           0.043
## 7    0   0   0   0             0.186           0.043
## 8    0   0   0   0             0.186           0.043
## 9    0   1   1   0             0.186           1.000
## 10   0   0   0   0             0.186           0.043
## 11   0   0   0   0             0.186           0.043
## 12   0   0   0   0             0.186           0.043
## 13   0   0   0   0             0.186           0.043
## 14   0   0   0   0             0.186           0.043
## 15   0   0   0   0             0.186           0.043
## 16   0   0   0   0             0.186           0.043
## 17   0   0   0   0             0.186           0.043
## 18   0   0   0   0             0.186           0.043
## 19   0   0   0   0             0.186           0.043
## 20   0   1   0   1             0.186           1.000
\end{verbatim}
\end{kframe}
\end{knitrout}
\end{frame}



\begin{frame}[fragile]
  \frametitle{R package `unmarked'}
  How many sites were occupied? \pause
  We can answer this using posterior prediction.
\begin{knitrout}\tiny
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{nsim} \hlkwb{<-} \hlnum{1000}
\hlstd{sites.occupied.post} \hlkwb{<-} \hlkwd{predict}\hlstd{(z.post,} \hlkwc{func}\hlstd{=}\hlkwa{function}\hlstd{(}\hlkwc{x}\hlstd{)} \hlkwd{sum}\hlstd{(x),} \hlkwc{nsim}\hlstd{=nsim)}
\hlkwd{par}\hlstd{(}\hlkwc{mai}\hlstd{=}\hlkwd{c}\hlstd{(}\hlnum{0.9}\hlstd{,}\hlnum{0.9}\hlstd{,}\hlnum{0.1}\hlstd{,}\hlnum{0.1}\hlstd{))}
\hlkwd{plot}\hlstd{(}\hlkwd{table}\hlstd{(sites.occupied.post)}\hlopt{/}\hlstd{nsim,} \hlkwc{lwd}\hlstd{=}\hlnum{5}\hlstd{,} \hlkwc{xlab}\hlstd{=}\hlstr{"Sites occupied"}\hlstd{,}
    \hlkwc{ylab}\hlstd{=}\hlstr{"Empirical Bayes posterior probability"}\hlstd{)}
\hlkwd{abline}\hlstd{(}\hlkwc{v}\hlstd{=}\hlkwd{sum}\hlstd{(z),} \hlkwc{col}\hlstd{=}\hlstr{"red"}\hlstd{)} \hlcom{## Actual number occupied}
\end{alltt}
\end{kframe}

{\centering \includegraphics[width=0.7\textwidth]{figure/bup-hist-1} 

}



\end{knitrout}
\end{frame}



\subsection{Bayesian methods}


\begin{frame}
  \frametitle{Bayesian methods}
  
\end{frame}


\begin{frame}
  \frametitle{JAGS and the jagsUI package}
  
\end{frame}


\section{Real data}




\begin{frame}
  \frametitle{Outline}
  \Large
  \tableofcontents[currentsection]
\end{frame}







\begin{frame}
  \frametitle{Assignment}
  \small
  % \scriptsize
  Create a self-contained R script (or better yet an Rmarkdown file)
  to do the following:
  \begin{enumerate}
    \small
    % \footnotesize
    % \scriptsize
    \item Simulate 
    \item Fit 
    \item Fit 4 models to the Canada Warbler
      data. 
  \end{enumerate}
  Upload your {\tt .R} or {\tt .Rmd} file to ELC before Monday, Sept 7. 
\end{frame}





\end{document}

