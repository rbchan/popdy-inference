\documentclass[color=usenames,dvipsnames]{beamer}\usepackage[]{graphicx}\usepackage[]{color}
% maxwidth is the original width if it is less than linewidth
% otherwise use linewidth (to make sure the graphics do not exceed the margin)
\makeatletter
\def\maxwidth{ %
  \ifdim\Gin@nat@width>\linewidth
    \linewidth
  \else
    \Gin@nat@width
  \fi
}
\makeatother

\definecolor{fgcolor}{rgb}{0, 0, 0}
\newcommand{\hlnum}[1]{\textcolor[rgb]{0.69,0.494,0}{#1}}%
\newcommand{\hlstr}[1]{\textcolor[rgb]{0.749,0.012,0.012}{#1}}%
\newcommand{\hlcom}[1]{\textcolor[rgb]{0.514,0.506,0.514}{\textit{#1}}}%
\newcommand{\hlopt}[1]{\textcolor[rgb]{0,0,0}{#1}}%
\newcommand{\hlstd}[1]{\textcolor[rgb]{0,0,0}{#1}}%
\newcommand{\hlkwa}[1]{\textcolor[rgb]{0,0,0}{\textbf{#1}}}%
\newcommand{\hlkwb}[1]{\textcolor[rgb]{0,0.341,0.682}{#1}}%
\newcommand{\hlkwc}[1]{\textcolor[rgb]{0,0,0}{\textbf{#1}}}%
\newcommand{\hlkwd}[1]{\textcolor[rgb]{0.004,0.004,0.506}{#1}}%
\let\hlipl\hlkwb

\usepackage{framed}
\makeatletter
\newenvironment{kframe}{%
 \def\at@end@of@kframe{}%
 \ifinner\ifhmode%
  \def\at@end@of@kframe{\end{minipage}}%
  \begin{minipage}{\columnwidth}%
 \fi\fi%
 \def\FrameCommand##1{\hskip\@totalleftmargin \hskip-\fboxsep
 \colorbox{shadecolor}{##1}\hskip-\fboxsep
     % There is no \\@totalrightmargin, so:
     \hskip-\linewidth \hskip-\@totalleftmargin \hskip\columnwidth}%
 \MakeFramed {\advance\hsize-\width
   \@totalleftmargin\z@ \linewidth\hsize
   \@setminipage}}%
 {\par\unskip\endMakeFramed%
 \at@end@of@kframe}
\makeatother

\definecolor{shadecolor}{rgb}{.97, .97, .97}
\definecolor{messagecolor}{rgb}{0, 0, 0}
\definecolor{warningcolor}{rgb}{1, 0, 1}
\definecolor{errorcolor}{rgb}{1, 0, 0}
\newenvironment{knitrout}{}{} % an empty environment to be redefined in TeX

\usepackage{alltt}
%\documentclass[color=usenames,dvipsnames,handout]{beamer}

\usepackage[roman]{../lectures}
%\usepackage[sans]{../lectures}


\hypersetup{pdfpagemode=UseNone,pdfstartview={FitV}}



% Load function to compile and open PDF


% Compile and open PDF






% New command for inline code that isn't to be evaluated
\definecolor{inlinecolor}{rgb}{0.878, 0.918, 0.933}
\newcommand{\inr}[1]{\colorbox{inlinecolor}{\texttt{#1}}}
\IfFileExists{upquote.sty}{\usepackage{upquote}}{}
\begin{document}




\begin{frame}[plain]
  \LARGE
  \centering
  {
    \LARGE Lecture 9 -- Hierarchical distance sampling: \\
    \Large simulation, fitting, and prediction %, and random effects \\
  }
  {\color{default} \rule{\textwidth}{0.1pt} }
  \vfill
  \large
  WILD(FISH) 8390 \\
  Estimation of Fish and Wildlife Population Parameters \\
  \vfill
  \large
  Richard Chandler \\
  University of Georgia \\
\end{frame}






\section{Overview}



\begin{frame}[plain]
  \frametitle{Outline}
  \Large
  \only<1>{\tableofcontents}%[hideallsubsections]}
  \only<2 | handout:0>{\tableofcontents[currentsection]}%,hideallsubsections]}
\end{frame}



\begin{frame}
  \frametitle{Distance sampling overview}
  Distance sampling is one of the oldest wildlife sampling methods. \\
  \pause
  \vfill
  It's based on the simple idea that detection probability should
  decline with distance between an an animal and a transect. \\
  \pause
  \vfill
  If we can estimate the function describing how $p$ declines with
  distance $x$, we can estimate abundance \pause (if certain assumptions
  hold, as always). \\
\end{frame}



\begin{frame}
  \frametitle{Distance sampling overview}
  The simplest estimator of abundance is 
  \[
    \hat{N} = \frac{n}{\hat{p}}
  \]
  where $n$ is the number of individuals detected, $p$ is detection
  probability, and $E(n)=Np$. \\
  \pause
  \vfill
  In distance sampling, detection probability is a \alert{function} of
  distance, rather than a constant, such that all individuals have
  unique detection probabilities. \\
  \pause
  \vfill
  As a result, we have to replace
  $p$ with \alert{average} detection probability:
  \[
    \hat{N} = \frac{n}{\hat{\bar{p}}}
  \]
  \pause
  \vfill
  How do we compute average detection probability ($\bar{p}$)?
\end{frame}



\begin{frame}
  \frametitle{Detection functions}
  To estimate average detection probability ($\bar{p}$), we need:
  \begin{itemize}
    \item A detection function $g(x)$ describing how $p$ declines with
      distance.
    \item A probability distribution $p(x)$ describing the
      distances of all animals (detected and not detected). 
  \end{itemize}
  \pause
  \vfill
  \centering
  The most common functions are: \\
  \vspace{6pt}
  \begin{tabular}{lc}
%    \centering
    \hline
    Detection function & $g(x)$ \\
    \hline
    Half normal & $\exp(-x^2 / (2\sigma^2))$ \\
    Negative exponential & $\exp(-x/\sigma)$ \\
    Hazard rate & $1-\exp(-(x/a)^{-b})$ \\
    \hline
  \end{tabular}
\end{frame}


\begin{frame}[fragile]
  \frametitle{Half-normal}
  \footnotesize
  \[
    g(x,\sigma) = \exp(-x^2/(2\sigma^2))
  \]
  \vspace{-12pt}
  \centering
\begin{knitrout}\scriptsize
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{sigma1} \hlkwb{<-} \hlnum{25}\hlstd{; sigma2} \hlkwb{<-} \hlnum{50}
\hlkwd{plot}\hlstd{(}\hlkwa{function}\hlstd{(}\hlkwc{x}\hlstd{)} \hlkwd{exp}\hlstd{(}\hlopt{-}\hlstd{x}\hlopt{^}\hlnum{2}\hlopt{/}\hlstd{(}\hlnum{2}\hlopt{*}\hlstd{sigma1}\hlopt{^}\hlnum{2}\hlstd{)),} \hlkwc{from}\hlstd{=}\hlnum{0}\hlstd{,} \hlkwc{to}\hlstd{=}\hlnum{100}\hlstd{,}
     \hlkwc{xlab}\hlstd{=}\hlstr{"Distance (x)"}\hlstd{,} \hlkwc{ylab}\hlstd{=}\hlstr{"Detection probability (p)"}\hlstd{)}
\hlkwd{plot}\hlstd{(}\hlkwa{function}\hlstd{(}\hlkwc{x}\hlstd{)} \hlkwd{exp}\hlstd{(}\hlopt{-}\hlstd{x}\hlopt{^}\hlnum{2}\hlopt{/}\hlstd{(}\hlnum{2}\hlopt{*}\hlstd{sigma2}\hlopt{^}\hlnum{2}\hlstd{)),} \hlkwc{from}\hlstd{=}\hlnum{0}\hlstd{,} \hlkwc{to}\hlstd{=}\hlnum{100}\hlstd{,} \hlkwc{add}\hlstd{=}\hlnum{TRUE}\hlstd{,} \hlkwc{col}\hlstd{=}\hlnum{4}\hlstd{)}
\hlkwd{legend}\hlstd{(}\hlnum{70}\hlstd{,} \hlnum{1}\hlstd{,} \hlkwd{c}\hlstd{(}\hlstr{"sigma=25"}\hlstd{,} \hlstr{"sigma=50"}\hlstd{),} \hlkwc{lty}\hlstd{=}\hlnum{1}\hlstd{,} \hlkwc{col}\hlstd{=}\hlkwd{c}\hlstd{(}\hlstr{"black"}\hlstd{,}\hlstr{"blue"}\hlstd{))}
\end{alltt}
\end{kframe}
\includegraphics[width=0.7\linewidth]{figure/hn-1} 

\end{knitrout}
\end{frame}




\begin{frame}[fragile]
  \frametitle{Negative exponential}
  \footnotesize
  \[
    g(x,\sigma) = \exp(-x/\sigma)
  \]
  \vspace{-12pt}
  \centering
\begin{knitrout}\scriptsize
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{sigma1} \hlkwb{<-} \hlnum{25}\hlstd{; sigma2} \hlkwb{<-} \hlnum{50}
\hlkwd{plot}\hlstd{(}\hlkwa{function}\hlstd{(}\hlkwc{x}\hlstd{)} \hlkwd{exp}\hlstd{(}\hlopt{-}\hlstd{x}\hlopt{/}\hlstd{sigma1),} \hlkwc{from}\hlstd{=}\hlnum{0}\hlstd{,} \hlkwc{to}\hlstd{=}\hlnum{100}\hlstd{,}
     \hlkwc{xlab}\hlstd{=}\hlstr{"Distance (x)"}\hlstd{,} \hlkwc{ylab}\hlstd{=}\hlstr{"Detection probability (p)"}\hlstd{)}
\hlkwd{plot}\hlstd{(}\hlkwa{function}\hlstd{(}\hlkwc{x}\hlstd{)} \hlkwd{exp}\hlstd{(}\hlopt{-}\hlstd{x}\hlopt{/}\hlstd{sigma2),} \hlkwc{from}\hlstd{=}\hlnum{0}\hlstd{,} \hlkwc{to}\hlstd{=}\hlnum{100}\hlstd{,} \hlkwc{add}\hlstd{=}\hlnum{TRUE}\hlstd{,} \hlkwc{col}\hlstd{=}\hlnum{4}\hlstd{)}
\hlkwd{legend}\hlstd{(}\hlnum{70}\hlstd{,} \hlnum{1}\hlstd{,} \hlkwd{c}\hlstd{(}\hlstr{"sigma=25"}\hlstd{,} \hlstr{"sigma=50"}\hlstd{),} \hlkwc{lty}\hlstd{=}\hlnum{1}\hlstd{,} \hlkwc{col}\hlstd{=}\hlkwd{c}\hlstd{(}\hlstr{"black"}\hlstd{,}\hlstr{"blue"}\hlstd{))}
\end{alltt}
\end{kframe}
\includegraphics[width=0.7\linewidth]{figure/nexp-1} 

\end{knitrout}
\end{frame}





\begin{frame}[fragile]
  \frametitle{Hazard rate}
  \footnotesize
  \[
    g(x,a,b) = 1-\exp(-(x/a)^{-b})
  \]
  \vspace{-12pt}
  \centering
\begin{knitrout}\scriptsize
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{a1} \hlkwb{<-} \hlnum{25}\hlstd{; a2} \hlkwb{<-} \hlnum{50}\hlstd{; b1} \hlkwb{<-} \hlnum{2}\hlstd{; b2} \hlkwb{<-} \hlnum{10}
\hlkwd{plot}\hlstd{(}\hlkwa{function}\hlstd{(}\hlkwc{x}\hlstd{)} \hlnum{1}\hlopt{-}\hlkwd{exp}\hlstd{(}\hlopt{-}\hlstd{(x}\hlopt{/}\hlstd{a1)}\hlopt{^}\hlstd{(}\hlopt{-}\hlstd{b1)),} \hlkwc{from}\hlstd{=}\hlnum{0}\hlstd{,} \hlkwc{to}\hlstd{=}\hlnum{100}\hlstd{,}
     \hlkwc{xlab}\hlstd{=}\hlstr{"Distance (x)"}\hlstd{,} \hlkwc{ylab}\hlstd{=}\hlstr{"Detection probability (p)"}\hlstd{,} \hlkwc{ylim}\hlstd{=}\hlnum{0}\hlopt{:}\hlnum{1}\hlstd{)}
\hlkwd{plot}\hlstd{(}\hlkwa{function}\hlstd{(}\hlkwc{x}\hlstd{)} \hlnum{1}\hlopt{-}\hlkwd{exp}\hlstd{(}\hlopt{-}\hlstd{(x}\hlopt{/}\hlstd{a2)}\hlopt{^}\hlstd{(}\hlopt{-}\hlstd{b2)),} \hlkwc{from}\hlstd{=}\hlnum{0}\hlstd{,} \hlkwc{to}\hlstd{=}\hlnum{100}\hlstd{,} \hlkwc{add}\hlstd{=}\hlnum{TRUE}\hlstd{,} \hlkwc{col}\hlstd{=}\hlnum{4}\hlstd{)}
\hlkwd{legend}\hlstd{(}\hlnum{70}\hlstd{,} \hlnum{1}\hlstd{,} \hlkwd{c}\hlstd{(}\hlstr{"a=25, b=2"}\hlstd{,} \hlstr{"a=50, b=10"}\hlstd{),} \hlkwc{lty}\hlstd{=}\hlnum{1}\hlstd{,} \hlkwc{col}\hlstd{=}\hlkwd{c}\hlstd{(}\hlstr{"black"}\hlstd{,}\hlstr{"blue"}\hlstd{))}
\end{alltt}
\end{kframe}
\includegraphics[width=0.7\linewidth]{figure/haz-1} 

\end{knitrout}
\end{frame}



\begin{frame}
  \frametitle{Average detection probability ($\bar{p}$)}
  Regardless of the chosen detection function, average detection
  probability is defined as: 
  \[
%     \bar{p} = \int g(x)p(x) \; \mathrm{d}x
%     \bar{p} = \int_{b_1}^{b_2} g(x)p(x) \; \mathrm{d}x
     \bar{p} = \int_{0}^{B} g(x)p(x) \; \mathrm{d}x
   \]
%   where $b_1$ and $b_2$ are the limits of the distance interval.
   where $B$ is the width of the transect.
  \pause
  \vfill
  All that remains is the specification of $p(x)$, the
  distribution of distances (between animals and the transect).
  \pause
  \vfill
  To understand why $p(x)$ is needed, think about it this way:
  \begin{itemize}
    \item If most animals are close to the transect, $\bar{p}$ would
      be high
    \item If most animals are far from the transect, $\bar{p}$ would
      be low
  \end{itemize}
  % \pause
  % \vfill
  % The standard assumption (for line transects) is that animals are
  % uniformly distributed with respect to the transect
\end{frame}



\begin{frame}
  \frametitle{What should we use for $p(x)$?}
  What distribution should we use for the distances between animals
  and transects?
  \pause
  \vfill
  In \alert{line-transect sampling}, it is often assumed that animals
  are uniformly distributed with respect to the transect.
  \begin{itemize}
    \item Consequently, $p(x) = 1/B$ where $B$ is the width of the
      transect.
    \item This is guaranteed by random transect placement
    \item Can also be justified if animals are neither attracted to
      the transects or avoid them. 
  \end{itemize}
  \pause
  \vfill
  In \alert{point-transect sampling}, we make the same assumptions,
  but we recognize that area increases with distance from a point.
  \begin{itemize}
    \item Consequently, $p(x) = 2x/B^2$ (see pg. 408 in AHM)
  \end{itemize}
\end{frame}




\begin{frame}[fragile]
  \frametitle{Computing $\bar{p}$}
  Half-normal detection function and line-transect sampling.
  \vspace{-6pt}
\begin{knitrout}\footnotesize
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{B} \hlkwb{<-} \hlnum{100}                                         \hlcom{# Transect width}
\hlstd{g} \hlkwb{<-} \hlkwa{function}\hlstd{(}\hlkwc{x}\hlstd{,} \hlkwc{sigma}\hlstd{=}\hlnum{25}\hlstd{)} \hlkwd{exp}\hlstd{(}\hlopt{-}\hlstd{x}\hlopt{^}\hlnum{2}\hlopt{/}\hlstd{(}\hlnum{2}\hlopt{*}\hlstd{sigma}\hlopt{^}\hlnum{2}\hlstd{))} \hlcom{# g(x)}
\hlstd{pdf} \hlkwb{<-} \hlkwa{function}\hlstd{(}\hlkwc{x}\hlstd{)} \hlnum{1}\hlopt{/}\hlstd{B}                           \hlcom{# p(x), constant}
\end{alltt}
\end{kframe}
\end{knitrout}
\pause
\vfill
  Do the integration
  \vspace{-6pt}
\begin{knitrout}\footnotesize
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{gp} \hlkwb{<-} \hlkwa{function}\hlstd{(}\hlkwc{x}\hlstd{)} \hlkwd{g}\hlstd{(x)}\hlopt{*}\hlkwd{pdf}\hlstd{(x)}
\hlstd{(pbar} \hlkwb{<-} \hlkwd{integrate}\hlstd{(gp,} \hlkwc{lower}\hlstd{=}\hlnum{0}\hlstd{,} \hlkwc{upper}\hlstd{=B)}\hlopt{$}\hlstd{value)}
\end{alltt}
\begin{verbatim}
## [1] 0.3133087
\end{verbatim}
\end{kframe}
\end{knitrout}
\pause
\vfill
  Note the equivalence
  \vspace{-6pt}
\begin{knitrout}\footnotesize
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{(pbar} \hlkwb{<-} \hlkwd{integrate}\hlstd{(g,} \hlkwc{lower}\hlstd{=}\hlnum{0}\hlstd{,} \hlkwc{upper}\hlstd{=B)}\hlopt{$}\hlstd{value} \hlopt{/} \hlstd{B)}
\end{alltt}
\begin{verbatim}
## [1] 0.3133087
\end{verbatim}
\begin{alltt}
\hlstd{(pbar} \hlkwb{<-} \hlstd{(}\hlkwd{pnorm}\hlstd{(B,}\hlnum{0}\hlstd{,}\hlnum{25}\hlstd{)} \hlopt{-} \hlkwd{pnorm}\hlstd{(}\hlnum{0}\hlstd{,}\hlnum{0}\hlstd{,}\hlnum{25}\hlstd{))} \hlopt{/} \hlkwd{dnorm}\hlstd{(}\hlnum{0}\hlstd{,}\hlnum{0}\hlstd{,}\hlnum{25}\hlstd{)} \hlopt{/} \hlstd{B)}
\end{alltt}
\begin{verbatim}
## [1] 0.3133087
\end{verbatim}
\end{kframe}
\end{knitrout}
\pause
\vfill
\centering
31.3\% chance of detecting an individual within 100 m. \\
\end{frame}




\begin{frame}
  \frametitle{In-class exercise}
  Building off the previous example\dots
  \begin{enumerate}
    \item Compute $\bar{p}$ when $\sigma=50, 100, \mathrm{and}\, 200$, instead of
      $\sigma=25$. 
    \item Repeat step 1, but for point transect sampling where
      $p(x)=2x/B^2$, instead of $p(x)=1/B$. 
  \end{enumerate}
\end{frame}




\begin{frame}
  \frametitle{Conventional vs hierarchical distance sampling}
  \alert{Conventional} distance sampling focuses on estimating the
  detection function, which describes how the probability of detecting
  an individual decreases with distance from the observer. Abundance
  and density are estimated, but there is no model for
  spatial variation in abundance/density.
  \pause
  \vfill
  \alert{Hierarchical} distance sampling is similar, but includes a
  model for spatial variation in abundance/density -- it's really just
  a multinomial $N$-mixture model with a unique function for computing
  the multinomial cell probabilities.
\end{frame}




\begin{frame}
  \frametitle{Hierarchical distance sampling}
  \small
  State model (with Poisson assumption)
  \begin{gather*}
    \mathrm{log}(\lambda_i) = \beta_0 + \beta_1 {\color{blue} w_{i1}} +
    \beta_2 {\color{blue} w_{i2}} + \cdots \\
    N_i \sim \mathrm{Poisson}(\lambda_i)
  \end{gather*}
  \pause
%  \vfill
  Observation model
  \begin{gather*}
    \mathrm{log}(\sigma_{i}) = \alpha_0 + \alpha_1 {\color{blue} w_{i1}}
    + \alpha_2 {\color{blue} w_{i3}} + \cdots \\
%    \bar{p}_{ij} = \int_{b_j}^{b_{j+1}} g(x,\sigma_i)p(x) \; \mathrm{d}x \\
    \{y_{i1}, \dots, y_{iK}\}  \sim \mathrm{Multinomial}(N_i,
%    \pi(\bar{p}_{i1}, \dots, \bar{p}_{iJ}))
    \pi(b_1, \dots, b_{J+1}, x, \sigma_i))
  \end{gather*}
  \pause
%  \vfill
  \small
  Definitions \\
%  \footnotesize
  $\lambda_i$ -- Expected value of abundance at site $i$ \\
  $N_i$ -- Realized value of abundance at site $i$ \\
  $\sigma_{i}$ -- Scale parameter of detection function $g(x)$ at site $i$ \\
%  $\pi(g(x),p(x))$ -- Function computing multinomial cell probs \\
  $\pi(x,b,\sigma_i)$ -- Function computing multinomial cell probs \\
  $y_{ij}$ -- count for distance bin $j$ (final count is unobserved) \\
%  \vfill
  $\color{blue} w_1$, $\color{blue} w_2$, $\color{blue} w_3$ -- site covariates %\hfill %\\
%  \vspace{12pt}
%  $\color{Purple} w$ -- observation covariate
\end{frame}




\begin{frame}
  \frametitle{Multinomial cell probabilities}
  \small
%  Some of the equations must be modified when we're working with distance bins. \\
%  \pause
%  \vfill
  Definitions needed for computing \alert{bin-specific} $\bar{p}$ and multinomial cell probabilities.
  \begin{itemize}
  \small
    \setlength\itemsep{1pt}
    \item $y_{ij}$ -- number of individuals detected at site $i$ in bin $j$
    \item $\sigma_i$ -- scale parameter of detection function $g(x)$
    \item $b_1, \dots, b_J$ -- Distance break points defining $J$ distance intervals
    \item $\bar{p}_j = \int_{b_j}^{b_{j+1}} g(x,\sigma)p(x|b_j\le x<b_{j+1})\, \mathrm{d}x$
    \item $p(x|b_j\le x<b_{j+1}) = 1/(b_{j+1}-b_j)$
    \item $\psi_j=\Pr(b_j\le x<b_{j+1})=(b_{j+1}-b_j)/B$ % -- Pr(occuring in distance bin $j$)
  \end{itemize}
  \pause \vfill
  \footnotesize
  \begin{columns}
    \column{0.9\paperwidth}
    % \begin{tabular}{lc}
    %   \hline
    %   \centering
    %   Description                       & Multinomial cell probability \\
    %   \hline
    %   Pr(occurs and detected in first distance bin)  & $\pi_1 = \int_{b_1}^{b_2} g(x,\sigma_i)p(x)\, \mathrm{d}x$   \\
    %   Pr(occurs and detected in second distance bin)  & $\pi_2 = \int_{b_2}^{b_3} g(x,\sigma_i)p(x)\, \mathrm{d}x$   \\
    %   {\centering $\cdots$}             & $\cdots$                     \\
    %   Pr(occurs and detected in last distance bin)  & $\pi_J = \int_{b_{J-1}}^{b_J} g(x,\sigma_i)p(x)\, \mathrm{d}x$   \\
    %   Pr(not detected)                  & $\pi_{K} = 1-\sum_{j=1}^J \pi_j$          \\
    %   \hline
    % \end{tabular}
    \begin{tabular}{lc}
      \hline
      \centering
      Description                       & Multinomial cell probability \\
      \hline
      Pr(occurs and detected in first distance bin)  & $\pi_1 = \psi_1\bar{p}_1$   \\
      Pr(occurs and detected in second distance bin)  & $\pi_2 = \psi_2\bar{p}_2$   \\
      {\centering $\cdots$}             & $\cdots$                     \\
      Pr(occurs and detected in last distance bin)  & $\pi_J = \psi_J\bar{p}_J$   \\
      Pr(not detected)                  & $\pi_{K} = 1-\sum_{j=1}^J \pi_j$          \\
      \hline
    \end{tabular}
  \end{columns}
\end{frame}








%\section{Simulation}

\section{Line transects}

\subsection{Simulation}

\begin{frame}
  \frametitle{Outline}
  \Large
%  \tableofcontents[currentsection,currentsubsection]
  \tableofcontents[currentsection]
\end{frame}










\begin{frame}[fragile]
  \frametitle{Line transects, no covariates}
  \small
  Abundance
  \vspace{-6pt}
\begin{knitrout}\scriptsize
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{nSites} \hlkwb{<-} \hlnum{100}\hlstd{; lambda1} \hlkwb{<-} \hlnum{2.6}  \hlcom{## Expected value of N}
\hlstd{N1} \hlkwb{<-} \hlkwd{rpois}\hlstd{(}\hlkwc{n}\hlstd{=nSites,} \hlkwc{lambda}\hlstd{=lambda1)}
\end{alltt}
\end{kframe}
\end{knitrout}
  \pause
  \vfill
  Multinomial cell probabilities
  \vspace{-6pt}
\begin{knitrout}\scriptsize
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{J} \hlkwb{<-} \hlnum{5}                     \hlcom{# distance bins}
\hlstd{sigma} \hlkwb{<-} \hlnum{50}                \hlcom{# scale parameter}
\hlstd{B} \hlkwb{<-} \hlnum{100}\hlstd{; L} \hlkwb{<-} \hlnum{100}         \hlcom{# transect widths (B) and lengths (L)}
\hlstd{b} \hlkwb{<-} \hlkwd{seq}\hlstd{(}\hlnum{0}\hlstd{, B,} \hlkwc{length}\hlstd{=J}\hlopt{+}\hlnum{1}\hlstd{)} \hlcom{# distance break points}
\hlstd{psi} \hlkwb{<-} \hlkwd{diff}\hlstd{(b)}\hlopt{/}\hlstd{B}           \hlcom{# Pr(x is in bin j)}
\hlstd{pbar1} \hlkwb{<-} \hlkwd{numeric}\hlstd{(J)}        \hlcom{# average detection probability}
\hlstd{pi1} \hlkwb{<-} \hlkwd{numeric}\hlstd{(J}\hlopt{+}\hlnum{1}\hlstd{)}        \hlcom{# multinomial cell probs}
\hlkwa{for}\hlstd{(j} \hlkwa{in} \hlnum{1}\hlopt{:}\hlstd{J) \{}
    \hlstd{pbar1[j]} \hlkwb{<-} \hlkwd{integrate}\hlstd{(}\hlkwa{function}\hlstd{(}\hlkwc{x}\hlstd{)} \hlkwd{exp}\hlstd{(}\hlopt{-}\hlstd{x}\hlopt{^}\hlnum{2}\hlopt{/}\hlstd{(}\hlnum{2}\hlopt{*}\hlstd{sigma}\hlopt{^}\hlnum{2}\hlstd{)),}
                          \hlkwc{lower}\hlstd{=b[j],} \hlkwc{upper}\hlstd{=b[j}\hlopt{+}\hlnum{1}\hlstd{])}\hlopt{$}\hlstd{value} \hlopt{/} \hlkwd{diff}\hlstd{(b)[j]}
    \hlstd{pi1[j]} \hlkwb{<-} \hlstd{pbar1[j]}\hlopt{*}\hlstd{psi[j]}
\hlstd{\}}
\hlstd{pi1[J}\hlopt{+}\hlnum{1}\hlstd{]} \hlkwb{<-} \hlnum{1}\hlopt{-}\hlkwd{sum}\hlstd{(pi1[}\hlnum{1}\hlopt{:}\hlstd{J])}
\end{alltt}
\end{kframe}
\end{knitrout}
  \pause
  \vfill
  Detections in each distance interval
  \vspace{-6pt}
\begin{knitrout}\scriptsize
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{y1.all} \hlkwb{<-} \hlkwd{matrix}\hlstd{(}\hlnum{NA}\hlstd{,} \hlkwc{nrow}\hlstd{=nSites,} \hlkwc{ncol}\hlstd{=J}\hlopt{+}\hlnum{1}\hlstd{)}
\hlkwa{for}\hlstd{(i} \hlkwa{in} \hlnum{1}\hlopt{:}\hlstd{nSites) \{}
    \hlstd{y1.all[i,]} \hlkwb{<-} \hlkwd{rmultinom}\hlstd{(}\hlkwc{n}\hlstd{=}\hlnum{1}\hlstd{,} \hlkwc{size}\hlstd{=N1[i],} \hlkwc{prob}\hlstd{=pi1)    \}}
\hlstd{y1} \hlkwb{<-} \hlstd{y1.all[,}\hlnum{1}\hlopt{:}\hlstd{J]}  \hlcom{## Drop final cell}
\end{alltt}
\end{kframe}
\end{knitrout}
\end{frame}



\begin{frame}[fragile]
  \frametitle{Observed distances}
  \centering
\begin{knitrout}\scriptsize
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlkwd{plot}\hlstd{(b[}\hlopt{-}\hlstd{(J}\hlopt{+}\hlnum{1}\hlstd{)]}\hlopt{+}\hlnum{10}\hlstd{,} \hlkwd{colSums}\hlstd{(y1),} \hlkwc{type}\hlstd{=}\hlstr{"h"}\hlstd{,} \hlkwc{lwd}\hlstd{=}\hlnum{80}\hlstd{,} \hlkwc{lend}\hlstd{=}\hlnum{2}\hlstd{,} \hlkwc{col}\hlstd{=}\hlstr{"tan"}\hlstd{,}
     \hlkwc{xlim}\hlstd{=}\hlkwd{c}\hlstd{(}\hlnum{0}\hlstd{,}\hlnum{100}\hlstd{),} \hlkwc{ylim}\hlstd{=}\hlkwd{c}\hlstd{(}\hlnum{0}\hlstd{,} \hlnum{70}\hlstd{),} \hlkwc{xlab}\hlstd{=}\hlstr{"Distance"}\hlstd{,} \hlkwc{ylab}\hlstd{=}\hlstr{"Detections"}\hlstd{)}
\end{alltt}
\end{kframe}
\includegraphics[width=0.9\linewidth]{figure/dist-hist2-1} 

\end{knitrout}
\end{frame}




\begin{frame}[fragile]
  \frametitle{Line transects, covariates}
  \small
  Abundance
  \vspace{-6pt}
\begin{knitrout}\scriptsize
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{elevation} \hlkwb{<-} \hlkwd{rnorm}\hlstd{(nSites)}
\hlstd{beta0} \hlkwb{<-} \hlnum{2}\hlstd{; beta1} \hlkwb{<-} \hlnum{1}
\hlstd{lambda2} \hlkwb{<-} \hlkwd{exp}\hlstd{(beta0} \hlopt{+} \hlstd{beta1}\hlopt{*}\hlstd{elevation)}
\hlstd{N2} \hlkwb{<-} \hlkwd{rpois}\hlstd{(}\hlkwc{n}\hlstd{=nSites,} \hlkwc{lambda}\hlstd{=lambda2)}
\end{alltt}
\end{kframe}
\end{knitrout}
  \pause
  \vfill
  Multinomial cell probabilities
  \vspace{-6pt}
\begin{knitrout}\scriptsize
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{noise} \hlkwb{<-} \hlkwd{rnorm}\hlstd{(nSites)}
\hlstd{alpha0} \hlkwb{<-} \hlnum{3}\hlstd{; alpha1} \hlkwb{<-} \hlopt{-}\hlnum{0.5}
\hlstd{sigma2} \hlkwb{<-} \hlkwd{exp}\hlstd{(alpha0} \hlopt{+} \hlstd{alpha1}\hlopt{*}\hlstd{noise)}
\hlstd{pi2} \hlkwb{<-} \hlkwd{matrix}\hlstd{(}\hlnum{NA}\hlstd{, nSites, J}\hlopt{+}\hlnum{1}\hlstd{)} \hlcom{# multinomial cell probs}
\hlkwa{for}\hlstd{(i} \hlkwa{in} \hlnum{1}\hlopt{:}\hlstd{nSites) \{}
  \hlkwa{for}\hlstd{(j} \hlkwa{in} \hlnum{1}\hlopt{:}\hlstd{J) \{}
      \hlstd{pi2[i,j]} \hlkwb{<-} \hlkwd{integrate}\hlstd{(}\hlkwa{function}\hlstd{(}\hlkwc{x}\hlstd{)} \hlkwd{exp}\hlstd{(}\hlopt{-}\hlstd{x}\hlopt{^}\hlnum{2}\hlopt{/}\hlstd{(}\hlnum{2}\hlopt{*}\hlstd{sigma2[i]}\hlopt{^}\hlnum{2}\hlstd{)),}
          \hlkwc{lower}\hlstd{=b[j],} \hlkwc{upper}\hlstd{=b[j}\hlopt{+}\hlnum{1}\hlstd{])}\hlopt{$}\hlstd{value} \hlopt{/} \hlstd{(b[j}\hlopt{+}\hlnum{1}\hlstd{]}\hlopt{-}\hlstd{b[j])} \hlopt{*} \hlstd{psi[j] \}}
  \hlstd{pi2[i,J}\hlopt{+}\hlnum{1}\hlstd{]} \hlkwb{<-} \hlnum{1}\hlopt{-}\hlkwd{sum}\hlstd{(pi2[i,}\hlnum{1}\hlopt{:}\hlstd{J]) \}}
\end{alltt}
\end{kframe}
\end{knitrout}
  \pause
  \vfill
  Detections in each distance interval
  \vspace{-6pt}
\begin{knitrout}\scriptsize
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{y2.all} \hlkwb{<-} \hlkwd{matrix}\hlstd{(}\hlnum{NA}\hlstd{,} \hlkwc{nrow}\hlstd{=nSites,} \hlkwc{ncol}\hlstd{=J}\hlopt{+}\hlnum{1}\hlstd{)}
\hlkwa{for}\hlstd{(i} \hlkwa{in} \hlnum{1}\hlopt{:}\hlstd{nSites) \{}
    \hlstd{y2.all[i,]} \hlkwb{<-} \hlkwd{rmultinom}\hlstd{(}\hlkwc{n}\hlstd{=}\hlnum{1}\hlstd{,} \hlkwc{size}\hlstd{=N2[i],} \hlkwc{prob}\hlstd{=pi2[i,])    \}}
\hlstd{y2} \hlkwb{<-} \hlstd{y2.all[,}\hlnum{1}\hlopt{:}\hlstd{J]}
\end{alltt}
\end{kframe}
\end{knitrout}
\end{frame}






\begin{frame}[fragile]
  \frametitle{Simulated data}
  \begin{columns}
    \begin{column}{0.4\textwidth}
      \small
      Observations
%      \tiny
  \vspace{-6pt}
\begin{knitrout}\tiny
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{y2[}\hlnum{1}\hlopt{:}\hlnum{25}\hlstd{,]}
\end{alltt}
\begin{verbatim}
##       [,1] [,2] [,3] [,4] [,5]
##  [1,]    1    0    0    0    0
##  [2,]    1    1    0    0    0
##  [3,]    4    3    0    0    0
##  [4,]    0    0    0    0    0
##  [5,]    1    1    0    0    0
##  [6,]    1    1    0    1    0
##  [7,]    1    1    0    0    0
##  [8,]    0    0    0    0    0
##  [9,]    0    2    0    0    0
## [10,]    1    2    0    0    0
## [11,]    0    1    0    0    0
## [12,]    1    0    0    0    0
## [13,]    2    1    0    0    0
## [14,]    2    0    0    0    0
## [15,]    0    0    1    0    1
## [16,]    0    0    0    0    0
## [17,]    2    1    0    0    0
## [18,]    3    1    0    1    0
## [19,]    3    0    0    0    0
## [20,]    1    0    0    0    0
## [21,]    1    0    0    0    0
## [22,]    1    0    0    0    0
## [23,]    1    0    0    0    0
## [24,]    1    0    0    0    0
## [25,]    9    4    1    1    0
\end{verbatim}
\end{kframe}
\end{knitrout}
  \end{column}
  \begin{column}{0.6\textwidth}
    \pause
%    \scriptsize
    {\centering Summary stats \\}
    \vspace{24pt}
    \small
    Proportion of sites known to be occupied
    \vspace{-6pt}
\begin{knitrout}\scriptsize
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlcom{# Max count at each site}
\hlstd{maxCounts} \hlkwb{<-} \hlkwd{apply}\hlstd{(y2,} \hlnum{1}\hlstd{, max)}
\hlstd{naiveOccupancy} \hlkwb{<-} \hlkwd{sum}\hlstd{(maxCounts}\hlopt{>}\hlnum{0}\hlstd{)}\hlopt{/}\hlstd{nSites}
\hlstd{naiveOccupancy}
\end{alltt}
\begin{verbatim}
## [1] 0.77
\end{verbatim}
\end{kframe}
\end{knitrout}
  \pause
  \vfill
  \small
  Total detections in each distance interval
  \vspace{-6pt}
\begin{knitrout}\scriptsize
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlkwd{colSums}\hlstd{(y2)}
\end{alltt}
\begin{verbatim}
## [1] 137  78  28  11   1
\end{verbatim}
\end{kframe}
\end{knitrout}
  \pause
  \vfill
  Naive abundance
  \vspace{-6pt}
\begin{knitrout}\scriptsize
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlkwd{sum}\hlstd{(y2)}
\end{alltt}
\begin{verbatim}
## [1] 255
\end{verbatim}
\end{kframe}
\end{knitrout}

  \end{column}
  \end{columns}
\end{frame}









%\section{Prediction}
\subsection{Likelihood}


\begin{frame}
  \frametitle{Outline}
  \Large
  \tableofcontents[currentsection]
\end{frame}






\begin{frame}[fragile]
  \frametitle{Prepare data in `unmarked'}
  \small
  Note the new arguments.
  \vspace{-6pt}
\begin{knitrout}\tiny
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{umf} \hlkwb{<-} \hlkwd{unmarkedFrameDS}\hlstd{(}\hlkwc{y}\hlstd{=y2,} \hlkwc{siteCovs}\hlstd{=}\hlkwd{data.frame}\hlstd{(elevation,noise),} \hlkwc{dist.breaks}\hlstd{=b,}
                       \hlkwc{tlength}\hlstd{=}\hlkwd{rep}\hlstd{(L, nSites),} \hlkwc{survey}\hlstd{=}\hlstr{"line"}\hlstd{,} \hlkwc{unitsIn}\hlstd{=}\hlstr{"m"}\hlstd{)}
\end{alltt}
\end{kframe}
\end{knitrout}
\pause
\begin{knitrout}\tiny
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlkwd{summary}\hlstd{(umf)}
\end{alltt}
\begin{verbatim}
## unmarkedFrameDS Object
## 
## line-transect survey design
## Distance class cutpoints (m):  0 20 40 60 80 100 
## 
## 100 sites
## Maximum number of distance classes per site: 5 
## Mean number of distance classes per site: 5 
## Sites with at least one detection: 77 
## 
## Tabulation of y observations:
##   0   1   2   3   4   5   6   8   9  12 
## 368  77  23  16  11   1   1   1   1   1 
## 
## Site-level covariates:
##    elevation            noise         
##  Min.   :-2.15115   Min.   :-2.10388  
##  1st Qu.:-0.67921   1st Qu.:-0.62759  
##  Median :-0.20250   Median :-0.09483  
##  Mean   :-0.07937   Mean   : 0.04132  
##  3rd Qu.: 0.60327   3rd Qu.: 0.65752  
##  Max.   : 2.03949   Max.   : 2.83252
\end{verbatim}
\end{kframe}
\end{knitrout}
\end{frame}



\begin{frame}[fragile]
  \frametitle{Fit the model}
  \footnotesize
\begin{knitrout}\tiny
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{fm} \hlkwb{<-} \hlkwd{distsamp}\hlstd{(}\hlopt{~}\hlstd{noise} \hlopt{~}\hlstd{elevation, umf)}
\hlstd{fm}
\end{alltt}
\begin{verbatim}
## 
## Call:
## distsamp(formula = ~noise ~ elevation, data = umf)
## 
## Density:
##             Estimate     SE    z  P(>|z|)
## (Intercept)     1.10 0.0957 11.5 1.93e-30
## elevation       1.05 0.0754 13.9 7.07e-44
## 
## Detection:
##                  Estimate     SE     z  P(>|z|)
## sigma(Intercept)    3.137 0.0515 60.90 0.00e+00
## sigmanoise         -0.369 0.0443 -8.34 7.55e-17
## 
## AIC: 576.9817
\end{verbatim}
\end{kframe}
\end{knitrout}
\pause
\vfill
Compare to actual parameter values:
\vspace{-6pt}
\begin{knitrout}\tiny
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlkwd{c}\hlstd{(}\hlkwc{beta0}\hlstd{=beta0,} \hlkwc{beta1}\hlstd{=beta1);} \hlkwd{c}\hlstd{(}\hlkwc{alpha0}\hlstd{=alpha0,} \hlkwc{alpha1}\hlstd{=alpha1)}
\end{alltt}
\begin{verbatim}
## beta0 beta1 
##     2     1
## alpha0 alpha1 
##    3.0   -0.5
\end{verbatim}
\end{kframe}
\end{knitrout}
\end{frame}








\begin{frame}[fragile]
  \frametitle{Prediction in `unmarked'}
  \small
  Create \texttt{data.frame} with prediction covariates. 
  \vspace{-6pt}
\begin{knitrout}\footnotesize
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{pred.data} \hlkwb{<-} \hlkwd{data.frame}\hlstd{(}\hlkwc{noise}\hlstd{=}\hlkwd{seq}\hlstd{(}\hlopt{-}\hlnum{3}\hlstd{,} \hlnum{3}\hlstd{,} \hlkwc{length}\hlstd{=}\hlnum{20}\hlstd{))}
\end{alltt}
\end{kframe}
\end{knitrout}
\pause
\vfill
Get predictions of $\sigma$ for each row of prediction data.
  \vspace{-6pt}
\begin{knitrout}\footnotesize
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{sigma.pred} \hlkwb{<-} \hlkwd{predict}\hlstd{(fm,} \hlkwc{newdata}\hlstd{=pred.data,}
                      \hlkwc{type}\hlstd{=}\hlstr{'det'}\hlstd{,} \hlkwc{append}\hlstd{=}\hlnum{TRUE}\hlstd{)}
\end{alltt}
\end{kframe}
\end{knitrout}
\pause
\vfill
  View $\sigma$ predictions
  \vspace{-6pt}
\begin{knitrout}\footnotesize
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlkwd{print}\hlstd{(}\hlkwd{head}\hlstd{(sigma.pred),} \hlkwc{digits}\hlstd{=}\hlnum{2}\hlstd{)}
\end{alltt}
\begin{verbatim}
##   Predicted  SE lower upper noise
## 1        70 9.2    54    90  -3.0
## 2        62 7.4    49    78  -2.7
## 3        55 5.9    45    68  -2.4
## 4        49 4.7    41    59  -2.1
## 5        44 3.6    37    51  -1.7
## 6        39 2.8    34    45  -1.4
\end{verbatim}
\end{kframe}
\end{knitrout}
\end{frame}





\begin{frame}[fragile]
  \frametitle{Prediction in `unmarked'}
\begin{knitrout}\tiny
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlkwd{plot}\hlstd{(Predicted} \hlopt{~} \hlstd{noise, sigma.pred,} \hlkwc{ylab}\hlstd{=}\hlstr{"Scale parameter (sigma)"}\hlstd{,}
     \hlkwc{ylim}\hlstd{=}\hlkwd{c}\hlstd{(}\hlnum{0}\hlstd{,}\hlnum{100}\hlstd{),} \hlkwc{xlab}\hlstd{=}\hlstr{"Noise level"}\hlstd{,} \hlkwc{type}\hlstd{=}\hlstr{"l"}\hlstd{)}
\hlkwd{lines}\hlstd{(lower} \hlopt{~} \hlstd{noise, sigma.pred,} \hlkwc{col}\hlstd{=}\hlstr{"grey"}\hlstd{)}
\hlkwd{lines}\hlstd{(upper} \hlopt{~} \hlstd{noise, sigma.pred,} \hlkwc{col}\hlstd{=}\hlstr{"grey"}\hlstd{)}
\end{alltt}
\end{kframe}

{\centering \includegraphics[width=0.8\linewidth]{figure/pred-sigma-1} 

}



\end{knitrout}
\end{frame}





\begin{frame}[fragile]
  \frametitle{Prediction in `unmarked'}
\begin{knitrout}\tiny
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlkwd{plot}\hlstd{(Predicted} \hlopt{~} \hlstd{noise, sigma.pred,} \hlkwc{ylab}\hlstd{=}\hlstr{"Scale parameter (sigma)"}\hlstd{,}
     \hlkwc{ylim}\hlstd{=}\hlkwd{c}\hlstd{(}\hlnum{0}\hlstd{,}\hlnum{100}\hlstd{),} \hlkwc{xlab}\hlstd{=}\hlstr{"Noise level"}\hlstd{,} \hlkwc{type}\hlstd{=}\hlstr{"l"}\hlstd{)}
\hlkwd{lines}\hlstd{(lower} \hlopt{~} \hlstd{noise, sigma.pred,} \hlkwc{col}\hlstd{=}\hlstr{"grey"}\hlstd{)}
\hlkwd{lines}\hlstd{(upper} \hlopt{~} \hlstd{noise, sigma.pred,} \hlkwc{col}\hlstd{=}\hlstr{"grey"}\hlstd{)}
\end{alltt}
\end{kframe}

{\centering \includegraphics[width=0.8\linewidth]{figure/pred-sigma2-1} 

}



\end{knitrout}
\end{frame}







\subsection{Bayes}


\begin{frame}
  \frametitle{Outline}
  \Large
  \tableofcontents[currentsection,currentsubsection]
\end{frame}





\begin{frame}[fragile]
  \frametitle{\normalsize Conditional-on-$N$ and $n_i=\sum_{j=1}^{J} y_{i,j}$}
\vspace{-3pt}
\begin{knitrout}\tiny
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{verbatim}
## model {
## 
## lambda.intercept ~ dunif(0, 20)
## beta0 <- log(lambda.intercept)
## beta1 ~ dnorm(0, 0.5)
## 
## alpha0 ~ dnorm(0, 0.5)
## alpha1 ~ dnorm(0, 0.5)
## 
## for(i in 1:nSites) {
##   log(lambda[i]) <- beta0 + beta1*elevation[i]
##   N[i] ~ dpois(lambda[i])         # Latent local abundance
##   log(sigma[i]) <- alpha0 + alpha1*noise[i]
##   tau[i] <- 1/sigma[i]^2
##   for(j in 1:nBins) {
##     ## Trick to do integration for *line-transects*
##     pbar[i,j] <- (pnorm(b[j+1], 0, tau[i]) - pnorm(b[j], 0, tau[i])) /
##                   dnorm(0, 0, tau[i]) / (b[j+1]-b[j])
##     pi[i,j] <- psi[j]*pbar[i,j]
##   }
##   pi[i,nBins+1] <- 1-sum(pi[i,1:nBins])
##   n[i] ~ dbin(1-pi[i,nBins+1], N[i])
##   y[i,] ~ dmulti(pi[i,1:nBins]/(1-pi[i,nBins+1]), n[i])
##   ## If N~Pois(lam), then the above is equivalent to:
##   # for(j in 1:nBins) { y[i,j] ~ dpois(lambda[i]*pi[i,j])  }
## }
## 
## totalAbundance <- sum(N[1:nSites])
## 
## }
\end{verbatim}
\end{kframe}
\end{knitrout}
\end{frame}





\begin{frame}[fragile]
  \frametitle{Data, inits, and parameters}
  Put data in a named list
  \vspace{-12pt}
\begin{knitrout}\footnotesize
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{jags.data.line} \hlkwb{<-} \hlkwd{list}\hlstd{(}\hlkwc{y}\hlstd{=y2,} \hlkwc{n}\hlstd{=}\hlkwd{rowSums}\hlstd{(y2),}
                       \hlkwc{b}\hlstd{=b,}           \hlcom{# Distance break points}
                       \hlkwc{psi}\hlstd{=}\hlkwd{diff}\hlstd{(b)}\hlopt{/}\hlstd{B,} \hlcom{# Pr(occuring in bin j)}
                       \hlkwc{elevation}\hlstd{=elevation,} \hlkwc{noise}\hlstd{=noise,}
                       \hlkwc{nSites}\hlstd{=nSites,} \hlkwc{nBins}\hlstd{=J)}
\end{alltt}
\end{kframe}
\end{knitrout}
\pause
\vfill
  Initial values
  \vspace{-12pt}
\begin{knitrout}\footnotesize
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{jags.inits.line} \hlkwb{<-} \hlkwa{function}\hlstd{() \{}
    \hlkwd{list}\hlstd{(}\hlkwc{lambda.intercept}\hlstd{=}\hlkwd{runif}\hlstd{(}\hlnum{1}\hlstd{),} \hlkwc{alpha0}\hlstd{=}\hlkwd{rnorm}\hlstd{(}\hlnum{1}\hlstd{,} \hlnum{5}\hlstd{),}
         \hlkwc{N}\hlstd{=}\hlkwd{rowSums}\hlstd{(y2)}\hlopt{+}\hlkwd{rpois}\hlstd{(}\hlkwd{nrow}\hlstd{(y2),} \hlnum{2}\hlstd{))}
\hlstd{\}}
\end{alltt}
\end{kframe}
\end{knitrout}
\pause
\vfill
  Parameters to monitor
  \vspace{-12pt}
\begin{knitrout}\small
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{jags.pars.line} \hlkwb{<-} \hlkwd{c}\hlstd{(}\hlstr{"beta0"}\hlstd{,} \hlstr{"beta1"}\hlstd{,}
                    \hlstr{"alpha0"}\hlstd{,} \hlstr{"alpha1"}\hlstd{,} \hlstr{"totalAbundance"}\hlstd{)}
\end{alltt}
\end{kframe}
\end{knitrout}
\end{frame}





\begin{frame}[fragile]
  \frametitle{MCMC}
  \small
\begin{knitrout}\scriptsize
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlkwd{library}\hlstd{(jagsUI)}
\hlstd{jags.post.line} \hlkwb{<-} \hlkwd{jags.basic}\hlstd{(}\hlkwc{data}\hlstd{=jags.data.line,} \hlkwc{inits}\hlstd{=jags.inits.line,}
                             \hlkwc{parameters.to.save}\hlstd{=jags.pars.line,}
                             \hlkwc{model.file}\hlstd{=}\hlstr{"distsamp-line-mod.jag"}\hlstd{,}
                             \hlkwc{n.chains}\hlstd{=}\hlnum{3}\hlstd{,} \hlkwc{n.adapt}\hlstd{=}\hlnum{100}\hlstd{,} \hlkwc{n.burnin}\hlstd{=}\hlnum{0}\hlstd{,}
                             \hlkwc{n.iter}\hlstd{=}\hlnum{2000}\hlstd{,} \hlkwc{parallel}\hlstd{=}\hlnum{TRUE}\hlstd{)}
\end{alltt}
\end{kframe}
\end{knitrout}
\vfill
\begin{knitrout}\scriptsize
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlkwd{round}\hlstd{(}\hlkwd{summary}\hlstd{(jags.post.line)}\hlopt{$}\hlstd{quantile,} \hlkwc{digits}\hlstd{=}\hlnum{3}\hlstd{)}
\end{alltt}
\begin{verbatim}
##                   2.5%     25%     50%     75%   97.5%
## alpha0           3.043   3.103   3.138   3.172   3.242
## alpha1          -0.463  -0.403  -0.373  -0.342  -0.290
## beta0            1.603   1.731   1.792   1.851   1.963
## beta1            0.897   0.991   1.037   1.089   1.181
## deviance       520.673 531.579 537.705 543.925 557.278
## totalAbundance 718.000 791.000 831.000 868.250 947.000
\end{verbatim}
\end{kframe}
\end{knitrout}
\end{frame}


\begin{frame}[fragile]
  \frametitle{Traceplots and density plots}
\begin{knitrout}\footnotesize
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlkwd{plot}\hlstd{(jags.post.line[,jags.pars.line[}\hlnum{1}\hlopt{:}\hlnum{3}\hlstd{]])}
\end{alltt}
\end{kframe}

{\centering \includegraphics[width=0.7\textwidth]{figure/bugs-plot1-rem2-1} 

}



\end{knitrout}
\end{frame}



\begin{frame}[fragile]
  \frametitle{Traceplots and density plots}
\begin{knitrout}\footnotesize
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlkwd{plot}\hlstd{(jags.post.line[,jags.pars.line[}\hlnum{4}\hlopt{:}\hlnum{5}\hlstd{]])}
\end{alltt}
\end{kframe}

{\centering \includegraphics[width=0.7\textwidth]{figure/bugs-plot2-rem2-1} 

}



\end{knitrout}
\end{frame}




\section{Point transects}

\subsection{Simulation}

\subsection{Likelihood}

\subsection{Bayes}



\section{Summary}


\begin{frame}
  \frametitle{Assumptions}
  
\end{frame}




\section{Assignment}




\begin{frame}[fragile]
  \frametitle{Assignment}
  % \small
  \footnotesize
  Create a self-contained R script or Rmarkdown file
  to do the following:
  \vfill
  \begin{enumerate}
%    \small
    \footnotesize
    \item Simulate \alert{independent} double observer data with the following
      properties:
      \begin{itemize}
        \item nSites=200
        \item $\lambda=3$
        \item $p_1=0.3$ and $p_2=0.5$
      \end{itemize}
    \item Fit the model using `unmarked'\footnote{\scriptsize You will
        need to create an observation covariate indicating observer A
        and B} and JAGS
    \item Use the point estimate of $p$ to compute the $\pi$ probabilities.
    \item Repeat steps 1-3 using the \alert{dependent} double observer
      method. 
  \end{enumerate}
  \vfill
  Upload your {\tt .R} or {\tt .Rmd} file to ELC before Monday. 
\end{frame}





\end{document}

