\documentclass[color=usenames,dvipsnames]{beamer}\usepackage[]{graphicx}\usepackage[]{color}
% maxwidth is the original width if it is less than linewidth
% otherwise use linewidth (to make sure the graphics do not exceed the margin)
\makeatletter
\def\maxwidth{ %
  \ifdim\Gin@nat@width>\linewidth
    \linewidth
  \else
    \Gin@nat@width
  \fi
}
\makeatother

\definecolor{fgcolor}{rgb}{0, 0, 0}
\newcommand{\hlnum}[1]{\textcolor[rgb]{0.69,0.494,0}{#1}}%
\newcommand{\hlstr}[1]{\textcolor[rgb]{0.749,0.012,0.012}{#1}}%
\newcommand{\hlcom}[1]{\textcolor[rgb]{0.514,0.506,0.514}{\textit{#1}}}%
\newcommand{\hlopt}[1]{\textcolor[rgb]{0,0,0}{#1}}%
\newcommand{\hlstd}[1]{\textcolor[rgb]{0,0,0}{#1}}%
\newcommand{\hlkwa}[1]{\textcolor[rgb]{0,0,0}{\textbf{#1}}}%
\newcommand{\hlkwb}[1]{\textcolor[rgb]{0,0.341,0.682}{#1}}%
\newcommand{\hlkwc}[1]{\textcolor[rgb]{0,0,0}{\textbf{#1}}}%
\newcommand{\hlkwd}[1]{\textcolor[rgb]{0.004,0.004,0.506}{#1}}%
\let\hlipl\hlkwb

\usepackage{framed}
\makeatletter
\newenvironment{kframe}{%
 \def\at@end@of@kframe{}%
 \ifinner\ifhmode%
  \def\at@end@of@kframe{\end{minipage}}%
  \begin{minipage}{\columnwidth}%
 \fi\fi%
 \def\FrameCommand##1{\hskip\@totalleftmargin \hskip-\fboxsep
 \colorbox{shadecolor}{##1}\hskip-\fboxsep
     % There is no \\@totalrightmargin, so:
     \hskip-\linewidth \hskip-\@totalleftmargin \hskip\columnwidth}%
 \MakeFramed {\advance\hsize-\width
   \@totalleftmargin\z@ \linewidth\hsize
   \@setminipage}}%
 {\par\unskip\endMakeFramed%
 \at@end@of@kframe}
\makeatother

\definecolor{shadecolor}{rgb}{.97, .97, .97}
\definecolor{messagecolor}{rgb}{0, 0, 0}
\definecolor{warningcolor}{rgb}{1, 0, 1}
\definecolor{errorcolor}{rgb}{1, 0, 0}
\newenvironment{knitrout}{}{} % an empty environment to be redefined in TeX

\usepackage{alltt}
%\documentclass[color=usenames,dvipsnames,handout]{beamer}

\usepackage[roman]{../lectures}
%\usepackage[sans]{../lectures}

\usepackage{pgffor}% http://ctan.org/pkg/pgffor


\hypersetup{pdfpagemode=UseNone,pdfstartview={FitV}}



% Load function to compile and open PDF


% Compile and open PDF




% New command for inline code that isn't to be evaluated
\definecolor{inlinecolor}{rgb}{0.878, 0.918, 0.933}
\newcommand{\inr}[1]{\colorbox{inlinecolor}{\texttt{#1}}}




\newcommand{\bxt}{${\bm x}_j$}
\newcommand{\bx}{{\bm x}}
\newcommand{\bxj}{{\bm x}_j}
\newcommand{\bst}{${\bm s}_i$}
\newcommand{\bs}{{\bm s}}
\newcommand{\bsi}{{\bm s}_i}
\newcommand{\ed}{\|\bx - \bs\|}
\newcommand{\cs}{\mathcal{S} }
\newcommand{\dsixj}{\|\bsi - \bxj\|}
\IfFileExists{upquote.sty}{\usepackage{upquote}}{}
\begin{document}




\begin{frame}[plain]
  \LARGE
  \centering
  {
    \LARGE Lecture 12 -- Spatial capture-recapture \\
    for closed populations: \\
    \Large Part II: mapping density surfaces \\
  }
  {\color{default} \rule{\textwidth}{0.1pt} }
  \vfill
  \large
  WILD(FISH) 8390 \\
  Estimation of Fish and Wildlife Population Parameters \\
  \vfill
  \large
  Richard Chandler \\
  University of Georgia \\
\end{frame}






\section{Overview}



\begin{frame}[plain]
  \frametitle{Outline}
  \Large
  \only<1>{\tableofcontents}%[hideallsubsections]}
  \only<2 | handout:0>{\tableofcontents[currentsection]}%,hideallsubsections]}
\end{frame}




\begin{frame}
  \frametitle{SCR overview}
  Last time, we focused on simulation and basic model fitting. \\
  \pause \vfill
  This time, we're going to talk about estimating and mapping density surfaces. \\
%  \pause \vfill
%  And you'll learn how to create maps of 
\end{frame}



\begin{frame}
  \frametitle{SCR overview}
  {\centering Two motivations for SCR \\}
  \vfill
  \begin{enumerate}
    \item Improved inference
    \begin{itemize}
      \item<1-> Non-spatial models can't properly account for sources
        of variation in $p$ that can cause bias.
        \begin{itemize}
          \item<1-> Distance to traps
          \item<1-> Trap-specific covariates
        \end{itemize}
      \item<1-> SCR makes it possible to estimate \alert{density}, not
        just $N$ in an unknown region. 
    \end{itemize}
%    \pause
    \vfill
  \item<1-> Improved science
  \begin{itemize}
    \item<1-> We can ask new questions, such as:
      \begin{itemize}
        \item<1-> What influences spatial variation in density?
        \item<1-> How do survival and recruitment vary in space and time?
        \item<1-> How does movement influence density and detectability?
      \end{itemize}
    \item<1-> Rather than think of SCR as a new estimation tool, you
      can think of it as an individual-based framework for inference on
      spatial population dynamics.
    \end{itemize}
  \end{enumerate}
\end{frame}




% \begin{frame}
%   \frametitle{In-class exercise}
%   Building off the previous example\dots
%   \begin{enumerate}
%     \item Compute $\bar{p}$ for line-transect sampling when
%       $\sigma=50, 100, \mathrm{and}\, 200$, instead of $\sigma=25$.  
%     \item Repeat, but for point-transect sampling. 
%   \end{enumerate}
% \end{frame}





\begin{frame}
  \frametitle{\large Closed population model ($N$ known hypothetically) }
  \footnotesize
  State model (a spatial point process model) %\\
  \begin{gather*}
    \lambda(\bs) = \beta_0 + \beta_1 w_1(\bs) + \beta_2 w_2(\bs) \dots \\
    \Lambda = \int_{\mathcal{S}} \lambda(\bs) \; \mathrm{d}\bs \\
    N \sim \mathrm{Pois}(\Lambda) \\
    \bsi \propto p(\lambda(\bs)) \;\; \mathrm{for}\; i=1,\dots,N 
  \end{gather*}
%  \pause
%  \vfill
  Observation model (supposing $N$ was known)
  \begin{gather*}
    p_{ij} = g_0\exp(-\|\bsi - \bxj\|^2/(2\sigma^2))  \;\; \mathrm{for}\, j=1,\dots,J  \\
    y_{ijk} \sim \mathrm{Bernoulli}(p_{ij})
  \end{gather*}
%  \pause
%  \vfill
%  \footnotesize
  \scriptsize
  Definitions \\
  \hangindent=0.9cm $\lambda(\bs)$ -- The ``intensity function'' %or ``density surface''
  describing the density of individuals at location $\bs$ \\ 
  $\Lambda$ -- Expected number of individuals \\
  $N$ -- Realized number of individuals (ie, population size) \\
  $\bsi$ -- Location of the $i$th activity center \\
  $\bxj$ -- Location of trap $j$ \\
  $\dsixj$ -- Euclidean distance between $\bsi$ and $\bxj$ \\
  $g_0$ -- Capture probability when distance between activity centers
  and traps is 0 \\
  $\sigma$ -- Scale parameter of encounter function \\
  $p_{ij}$ -- Capture probability \\
  $y_{ijk}$ -- Spatial capture histories \\
\end{frame}







\section{Simulation}


\begin{frame}
  \frametitle{Outline}
  \Large
%  \tableofcontents[currentsection,currentsubsection]
  \tableofcontents[currentsection]
\end{frame}






\begin{frame}[fragile]
  \frametitle{Inhomogeneous Poisson point process}
  First, let's import a raster layer
\begin{knitrout}\footnotesize
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlkwd{library}\hlstd{(raster)}
\hlstd{elevation} \hlkwb{<-} \hlkwd{raster}\hlstd{(}\hlstr{"elevation.tif"}\hlstd{)}
\hlkwd{plot}\hlstd{(elevation,} \hlkwc{col}\hlstd{=}\hlkwd{topo.colors}\hlstd{(}\hlnum{100}\hlstd{),} \hlkwc{main}\hlstd{=}\hlstr{"Elevation"}\hlstd{)}
\end{alltt}
\end{kframe}

{\centering \includegraphics[width=0.6\linewidth]{figure/ippp1-1} 

}



\end{knitrout}
\end{frame}




\begin{frame}[fragile]
  \frametitle{Inhomogeneous Poisson point process}
  \small
  Second, let's pick some coefficients and create a density surface
\begin{knitrout}\footnotesize
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{beta0} \hlkwb{<-} \hlopt{-}\hlnum{15}
\hlstd{beta1} \hlkwb{<-} \hlnum{0.01} \hlcom{#0.005}
\hlstd{lambda} \hlkwb{<-} \hlkwd{exp}\hlstd{(beta0} \hlopt{+} \hlstd{beta1}\hlopt{*}\hlstd{elevation)} \hlcom{# Intensity function}
\hlkwd{plot}\hlstd{(lambda,} \hlkwc{col}\hlstd{=}\hlkwd{terrain.colors}\hlstd{(}\hlnum{100}\hlstd{),} \hlkwc{main}\hlstd{=}\hlstr{"Density surface"}\hlstd{)}
\end{alltt}
\end{kframe}

{\centering \includegraphics[width=0.6\linewidth]{figure/ippp2-1} 

}



\end{knitrout}
\end{frame}




\begin{frame}[fragile]
  \frametitle{Inhomogeneous Poisson point process}
  \small
  Third, simulate $N$
  \vspace{-6pt}
\begin{knitrout}\footnotesize
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlkwd{set.seed}\hlstd{(}\hlnum{538}\hlstd{)}
\hlstd{ds} \hlkwb{<-} \hlnum{1}                            \hlcom{## Pixel area is 1 ha}
\hlstd{lambda.values} \hlkwb{<-} \hlkwd{values}\hlstd{(lambda)}    \hlcom{## Convert raster to vector}
\hlstd{Lambda} \hlkwb{<-} \hlkwd{sum}\hlstd{(lambda.values}\hlopt{*}\hlstd{ds)}    \hlcom{## E(N)}
\hlstd{(N} \hlkwb{<-} \hlkwd{rpois}\hlstd{(}\hlnum{1}\hlstd{, Lambda))}            \hlcom{## Realized N}
\end{alltt}
\begin{verbatim}
## [1] 98
\end{verbatim}
\end{kframe}
\end{knitrout}
\pause
\vfill
Fourth, simulate and $\bs_1, \dots, \bs_N$. To do this, we'll pick
pixels proportional to density. Then we'll jitter each point
inside its pixel. 
  \vspace{-6pt}
\begin{knitrout}\footnotesize
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{n.pixels} \hlkwb{<-} \hlkwd{length}\hlstd{(lambda)}
\hlstd{jitter} \hlkwb{<-} \hlnum{0.005}                    \hlcom{## Half width of pixel }
\hlstd{s.pixels} \hlkwb{<-} \hlkwd{sample}\hlstd{(n.pixels,} \hlkwc{size}\hlstd{=N,} \hlkwc{replace}\hlstd{=}\hlnum{TRUE}\hlstd{,}
                   \hlkwc{prob}\hlstd{=lambda.values}\hlopt{/}\hlstd{Lambda)}
\hlstd{elevation.xyz} \hlkwb{<-} \hlkwd{as.data.frame}\hlstd{(elevation,} \hlkwc{xy}\hlstd{=}\hlnum{TRUE}\hlstd{)}
\hlstd{s} \hlkwb{<-} \hlstd{elevation.xyz[s.pixels,}\hlkwd{c}\hlstd{(}\hlstr{"x"}\hlstd{,}\hlstr{"y"}\hlstd{)]} \hlopt{+}
    \hlkwd{cbind}\hlstd{(}\hlkwd{runif}\hlstd{(N,} \hlopt{-}\hlstd{jitter, jitter),}\hlkwd{runif}\hlstd{(N,} \hlopt{-}\hlstd{jitter, jitter))}
\end{alltt}
\end{kframe}
\end{knitrout}
\end{frame}







\begin{frame}[fragile]
  \frametitle{Inhomogeneous Poisson point process}
\begin{knitrout}\scriptsize
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlkwd{plot}\hlstd{(lambda,} \hlkwc{col}\hlstd{=}\hlkwd{terrain.colors}\hlstd{(}\hlnum{100}\hlstd{),}
     \hlkwc{main}\hlstd{=}\hlstr{"Density surface with activity centers"}\hlstd{)}
\hlkwd{points}\hlstd{(s,} \hlkwc{pch}\hlstd{=}\hlnum{16}\hlstd{,} \hlkwc{cex}\hlstd{=}\hlnum{1}\hlstd{,} \hlkwc{col}\hlstd{=}\hlstr{"blue"}\hlstd{)}
\end{alltt}
\end{kframe}

{\centering \includegraphics[width=0.7\linewidth]{figure/ippp5-1} 

}



\end{knitrout}
\end{frame}






\begin{frame}[fragile]
  \frametitle{Traps}
\begin{knitrout}\scriptsize
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{x} \hlkwb{<-} \hlkwd{cbind}\hlstd{(}\hlkwd{rep}\hlstd{(}\hlkwd{seq}\hlstd{(}\hlnum{0.15}\hlstd{,} \hlnum{0.85}\hlstd{,} \hlkwc{by}\hlstd{=}\hlnum{0.1}\hlstd{),} \hlkwc{each}\hlstd{=}\hlnum{8}\hlstd{),}
           \hlkwd{rep}\hlstd{(}\hlkwd{seq}\hlstd{(}\hlnum{0.15}\hlstd{,} \hlnum{0.85}\hlstd{,} \hlkwc{by}\hlstd{=}\hlnum{0.1}\hlstd{),} \hlkwc{times}\hlstd{=}\hlnum{8}\hlstd{))}  \hlcom{## Trap locations}
\hlkwd{plot}\hlstd{(lambda,} \hlkwc{col}\hlstd{=}\hlkwd{terrain.colors}\hlstd{(}\hlnum{100}\hlstd{),}
     \hlkwc{main}\hlstd{=}\hlstr{"Density surface with activity centers and traps"}\hlstd{)}
\hlkwd{points}\hlstd{(s,} \hlkwc{pch}\hlstd{=}\hlnum{16}\hlstd{,} \hlkwc{col}\hlstd{=}\hlstr{"blue"}\hlstd{)} \hlcom{## Activity center locations}
\hlkwd{points}\hlstd{(x,} \hlkwc{pch}\hlstd{=}\hlnum{3}\hlstd{)}              \hlcom{## Trap locations}
\end{alltt}
\end{kframe}

{\centering \includegraphics[width=0.6\linewidth]{figure/traps1-1} 

}



\end{knitrout}
\end{frame}





\begin{frame}[fragile]
  \frametitle{Distance between traps and activity centers}
  Compute distances between activity centers ($\bs_1, \dots, \bs_N$)
  and traps ($\bx_1, \dots, \bx_J$).
\begin{knitrout}\footnotesize
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{J} \hlkwb{<-} \hlkwd{nrow}\hlstd{(x)}                 \hlcom{## nTraps}
\hlstd{dist.sx} \hlkwb{<-} \hlkwd{matrix}\hlstd{(}\hlnum{NA}\hlstd{, N, J)}
\hlkwa{for}\hlstd{(i} \hlkwa{in} \hlnum{1}\hlopt{:}\hlstd{N) \{}
    \hlstd{dist.sx[i,]} \hlkwb{<-} \hlkwd{sqrt}\hlstd{((s[i,}\hlnum{1}\hlstd{]}\hlopt{-}\hlstd{x[,}\hlnum{1}\hlstd{])}\hlopt{^}\hlnum{2} \hlopt{+} \hlstd{(s[i,}\hlnum{2}\hlstd{]}\hlopt{-}\hlstd{x[,}\hlnum{2}\hlstd{])}\hlopt{^}\hlnum{2}\hlstd{)}
\hlstd{\}}
\end{alltt}
\end{kframe}
\end{knitrout}
\pause
\vfill
  Look at distances between first 4 individuals and first 5 traps.
\begin{knitrout}\footnotesize
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{dist.sx[}\hlnum{1}\hlopt{:}\hlnum{4}\hlstd{,}\hlnum{1}\hlopt{:}\hlnum{5}\hlstd{]}
\end{alltt}
\begin{verbatim}
##           [,1]      [,2]      [,3]      [,4]      [,5]
## [1,] 0.1218625 0.1175070 0.1810119 0.2678109 0.3614970
## [2,] 0.9587743 0.8922040 0.8323508 0.7807610 0.7391668
## [3,] 0.7162980 0.6912027 0.6800289 0.6834600 0.7012815
## [4,] 0.6222620 0.5569781 0.5032288 0.4650310 0.4463949
\end{verbatim}
\end{kframe}
\end{knitrout}

\end{frame}






\begin{frame}[fragile]
  \frametitle{Capture probability}
  Compute capture probability
\begin{knitrout}\footnotesize
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{g0} \hlkwb{<-} \hlnum{0.2}
\hlstd{sigma} \hlkwb{<-} \hlnum{0.05}
\hlstd{p} \hlkwb{<-} \hlstd{g0}\hlopt{*}\hlkwd{exp}\hlstd{(}\hlopt{-}\hlstd{dist.sx}\hlopt{^}\hlnum{2}\hlopt{/}\hlstd{(}\hlnum{2}\hlopt{*}\hlstd{sigma}\hlopt{^}\hlnum{2}\hlstd{))}
\end{alltt}
\end{kframe}
\end{knitrout}
\pause
\vfill
  Look at capture probs for first 4 individuals and first 5 traps.
\begin{knitrout}\footnotesize
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlkwd{print}\hlstd{(p[}\hlnum{1}\hlopt{:}\hlnum{4}\hlstd{,}\hlnum{1}\hlopt{:}\hlnum{5}\hlstd{],} \hlkwc{digits}\hlstd{=}\hlnum{3}\hlstd{)}
\end{alltt}
\begin{verbatim}
##          [,1]     [,2]     [,3]     [,4]     [,5]
## [1,] 1.03e-02 1.26e-02 2.85e-04 1.18e-07 8.92e-13
## [2,] 2.86e-81 1.44e-70 1.33e-61 2.25e-54 6.98e-49
## [3,] 5.44e-46 6.36e-43 1.36e-41 5.34e-42 3.84e-44
## [4,] 4.66e-35 2.27e-28 2.02e-23 3.29e-20 9.84e-19
\end{verbatim}
\end{kframe}
\end{knitrout}

\end{frame}





\begin{frame}[fragile]
  \frametitle{Capture histories}
  Simulate capture histories for all $N$ individuals
\begin{knitrout}\footnotesize
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{K} \hlkwb{<-} \hlnum{5}                          \hlcom{# nOccasions}
\hlstd{y.all} \hlkwb{<-} \hlkwd{array}\hlstd{(}\hlnum{NA}\hlstd{,} \hlkwd{c}\hlstd{(N, J, K))}
\hlkwa{for}\hlstd{(i} \hlkwa{in} \hlnum{1}\hlopt{:}\hlstd{N) \{}
    \hlkwa{for}\hlstd{(j} \hlkwa{in} \hlnum{1}\hlopt{:}\hlstd{J) \{}
        \hlstd{y.all[i,j,]} \hlkwb{<-} \hlkwd{rbinom}\hlstd{(K,} \hlnum{1}\hlstd{,} \hlkwc{prob}\hlstd{=p[i,j])}
    \hlstd{\}}
\hlstd{\}}
\end{alltt}
\end{kframe}
\end{knitrout}
\pause
\vfill
  Discard individuals not captured
\begin{knitrout}\footnotesize
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{captured} \hlkwb{<-} \hlkwd{rowSums}\hlstd{(y.all)}\hlopt{>}\hlnum{0}
\hlstd{y} \hlkwb{<-} \hlstd{y.all[captured,,]}
\end{alltt}
\end{kframe}
\end{knitrout}
\pause
\vfill
  Capture histories for first 2 individuals and first 5 traps
  on first occasion.
\begin{knitrout}\footnotesize
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{y[}\hlnum{1}\hlopt{:}\hlnum{2}\hlstd{,}\hlnum{1}\hlopt{:}\hlnum{5}\hlstd{,}\hlnum{1}\hlstd{]}
\end{alltt}
\begin{verbatim}
##      [,1] [,2] [,3] [,4] [,5]
## [1,]    0    0    0    0    0
## [2,]    0    0    0    0    0
\end{verbatim}
\end{kframe}
\end{knitrout}
\end{frame}







\section{Likelihood}



\begin{frame}
  \frametitle{Outline}
  \Large
  \tableofcontents[currentsection]
\end{frame}









\begin{frame}[fragile]
  \frametitle{R package `secr'}
  \footnotesize
  Import data from two text files.
\begin{knitrout}\scriptsize
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlkwd{library}\hlstd{(secr)}
\hlstd{sch} \hlkwb{<-} \hlkwd{read.capthist}\hlstd{(}\hlkwc{captfile}\hlstd{=}\hlstr{"encounter_data_file.csv"}\hlstd{,}
                   \hlkwc{trapfile}\hlstd{=}\hlstr{"trap_data_file.csv"}\hlstd{,}
                   \hlkwc{detector}\hlstd{=}\hlstr{"proximity"}\hlstd{,} \hlkwc{fmt}\hlstd{=}\hlstr{"trapID"}\hlstd{)}
\end{alltt}
\end{kframe}
\end{knitrout}
  \pause
  Create the ``habitat mask'', which defines the state-space and the
  spatial covariates. First, prepare the elevation covariate. 
\begin{knitrout}\scriptsize
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{elevation.xyz} \hlkwb{<-} \hlkwd{as.data.frame}\hlstd{(elevation,} \hlkwc{xy}\hlstd{=}\hlnum{TRUE}\hlstd{)}
\hlstd{elevation.xyz.m} \hlkwb{<-} \hlstd{elevation.xyz}
\hlstd{elevation.xyz.m}\hlopt{$}\hlstd{x} \hlkwb{<-} \hlstd{elevation.xyz}\hlopt{$}\hlstd{x}\hlopt{*}\hlnum{1000}  \hlcom{## Convert units to meters}
\hlstd{elevation.xyz.m}\hlopt{$}\hlstd{y} \hlkwb{<-} \hlstd{elevation.xyz}\hlopt{$}\hlstd{y}\hlopt{*}\hlnum{1000}
\hlstd{elevation.xyz.m}\hlopt{$}\hlstd{elevation} \hlkwb{<-} \hlkwd{scale}\hlstd{(elevation.xyz}\hlopt{$}\hlstd{elevation)} \hlcom{## Standardize}
\hlstd{elevation.m} \hlkwb{<-} \hlkwd{rasterFromXYZ}\hlstd{(elevation.xyz.m)}
\end{alltt}
\end{kframe}
\end{knitrout}
  \pause
  Now create the mask.
\begin{knitrout}\scriptsize
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlkwd{library}\hlstd{(sp)}
\hlstd{elev.sp} \hlkwb{<-} \hlkwd{as}\hlstd{(elevation.m,} \hlstr{"SpatialGridDataFrame"}\hlstd{)}
\hlstd{trp} \hlkwb{<-} \hlkwd{traps}\hlstd{(sch)}
\hlstd{mask} \hlkwb{<-} \hlkwd{make.mask}\hlstd{(trp,} \hlkwc{buffer}\hlstd{=}\hlnum{150}\hlstd{,} \hlkwc{spacing}\hlstd{=}\hlnum{15}\hlstd{)}
\hlstd{mask} \hlkwb{<-} \hlkwd{addCovariates}\hlstd{(mask,} \hlkwc{spatialdata}\hlstd{=elev.sp)}
\end{alltt}
\end{kframe}
\end{knitrout}
\end{frame}


\begin{frame}[fragile]
  \frametitle{Habitat mask}
\begin{knitrout}\scriptsize
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlkwd{plot}\hlstd{(mask,} \hlkwc{covariate}\hlstd{=}\hlstr{"elevation"}\hlstd{)}
\hlkwd{plot}\hlstd{(trp,} \hlkwc{add}\hlstd{=}\hlnum{TRUE}\hlstd{)}
\end{alltt}
\end{kframe}

{\centering \includegraphics[width=0.95\linewidth]{figure/plot-mask-1} 

}



\end{knitrout}
\end{frame}




\begin{frame}[fragile]
  \frametitle{R package `secr'}
  Model density as a function of elevation. 
\begin{knitrout}\scriptsize
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{fm.elev} \hlkwb{<-} \hlkwd{secr.fit}\hlstd{(sch,} \hlkwc{model}\hlstd{=}\hlkwd{list}\hlstd{(}\hlkwc{D}\hlstd{=}\hlopt{~}\hlstd{elevation,} \hlkwc{g0}\hlstd{=}\hlopt{~}\hlnum{1}\hlstd{,} \hlkwc{sigma}\hlstd{=}\hlopt{~}\hlnum{1}\hlstd{),}
                    \hlkwc{mask}\hlstd{=mask,} \hlkwc{trace}\hlstd{=}\hlnum{FALSE}\hlstd{)} \hlcom{## Don't use 'buffer'}
\hlkwd{coef}\hlstd{(fm.elev)}
\end{alltt}
\begin{verbatim}
##                   beta    SE.beta        lcl         ucl
## D           -0.5498612 0.23019036 -1.0010260 -0.09869634
## D.elevation  0.9301088 0.18698334  0.5636282  1.29658945
## g0          -1.1809462 0.21373511 -1.5998593 -0.76203311
## sigma        3.9099026 0.06563899  3.7812525  4.03855261
\end{verbatim}
\end{kframe}
\end{knitrout}
\pause
\vfill
Estimates on original scale (at average covariate values).
\begin{knitrout}\scriptsize
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlkwd{predict}\hlstd{(fm.elev)}
\end{alltt}
\begin{verbatim}
##        link   estimate SE.estimate        lcl       ucl
## D       log  1.4125652  0.19635565  1.0770892  1.852530
## g0    logit  0.2348821  0.03841087  0.1680013  0.318205
## sigma   log 49.8940897  3.27852830 43.8709558 56.744152
\end{verbatim}
\end{kframe}
\end{knitrout}
\end{frame}



\begin{frame}[fragile]
  \frametitle{Estimated density surface}
\begin{knitrout}\scriptsize
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{dsurf} \hlkwb{<-} \hlkwd{predictDsurface}\hlstd{(fm.elev)}
\hlstd{dsurf.r} \hlkwb{<-} \hlkwd{raster}\hlstd{(dsurf,} \hlkwc{covariate}\hlstd{=}\hlstr{"D.0"}\hlstd{)}
\hlkwd{plot}\hlstd{(dsurf.r,} \hlkwc{col}\hlstd{=}\hlkwd{terrain.colors}\hlstd{(}\hlnum{100}\hlstd{),} \hlkwc{main}\hlstd{=}\hlstr{"Estimated density surface"}\hlstd{)}
\end{alltt}
\end{kframe}
\end{knitrout}
\centering
\includegraphics[width=0.49\textwidth]{figure/secr-dsurf-1}
\includegraphics[width=0.49\textwidth]{figure/ippp2-1} \\
\pause \vfill
The units differ because we transformed to meters. \\
\end{frame}



\begin{frame}[fragile]
  \frametitle{Estimated activity center locations}
  Can't get this to work.
\begin{knitrout}\scriptsize
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlkwd{plot}\hlstd{(trp)}
\hlcom{#fxi.secr(fm.elev, X=mask[,c("x","y")])}
\hlcom{#fxi.contour(fm0)#,i=2,add=TRUE,plotmode=FALSE,drawlabels = FALSE, X=mask[,c("x","y")])}
\end{alltt}
\end{kframe}
\end{knitrout}
\end{frame}




\begin{frame}[fragile]
  \frametitle{R package `secr'}
  We can still estimate $N$ as before. \\
  \vfill
  \inr{E.N} is the expected value of
  $N$. \inr{R.N} is the realized value of $N$. 
  \vfill
\begin{knitrout}\small
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlkwd{region.N}\hlstd{(fm.elev)}
\end{alltt}
\begin{verbatim}
##     estimate SE.estimate      lcl      ucl  n
## E.N 88.05875   12.336690 67.00411 115.7294 59
## R.N 94.33840    8.008443 81.79063 113.7945 59
\end{verbatim}
\end{kframe}
\end{knitrout}
\end{frame}




\section{Data augmentation}


%\section{Prediction}
%\subsection{Likelihood-based inference}


\begin{frame}
  \frametitle{Outline}
  \Large
  \tableofcontents[currentsection]
\end{frame}





\begin{frame}
  \frametitle{Data augmentation model}
  The DA version of a SCR model with an inhomogeneous point process
  can be written like this:
  \begin{gather*}
    \lambda(\bs) = \exp(\beta_0 + \beta_1 \mathrm{ELEV}(\bs)) \\
    \bsi \propto (\lambda(\bs)) \\
    z_i \sim \mathrm{Bern}(\psi) \\
    p_{ij} = g_0\exp(-\|\bsi-\bxj\|^2/(2\sigma^2)) \\
    y_{ijk} \sim \mathrm{Bern}(z_i p_{ij}) \\
    N=\sum_{i=1}^M z_i
  \end{gather*}
  % A uniform prior on $\psi$ results in a discrete uniform prior on
  % $N$. We can change the prior for $N$ by changing the prior on
  % $\psi$, recognizing that $E(N)=M\psi$.
  % But why bother with augmentation?
  % \begin{itemize}
  %   \item DA works for \alert{all} varieties of mark-recapture models
  %   \item Make it easy to incorporate
  %     individual-covariates\dots\pause including distance and
  %     location!   
  % \end{itemize}
\end{frame}



\begin{frame}
  \frametitle{Inhomogeneous point process in JAGS}
  We need to do the following to make this work:
  \begin{enumerate}
    \item Provide the spatial covariate as a vector
    \item Loop over all pixels to compute the density at each pixel
    \item Retain the uniform prior on the activity centers, but add a
      second probability component to force them to be distributed
      according to the density surface.
      \begin{enumerate}
        \item This requires that we create a ``lookup'' table to map
          points in space to pixel IDs
        \item Then we use the ``zero's trick'' to implement the
          non-standard probability distribution
      \end{enumerate}
    \item Define $\psi=E(N)/M$
  \end{enumerate}
\end{frame}




\begin{frame}[fragile]
  \frametitle{SCR with inhomogeneous PP and data augmentation}
\vspace{-3pt}
\begin{knitrout}\scriptsize
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlkwd{writeLines}\hlstd{(}\hlkwd{readLines}\hlstd{(}\hlstr{"SCR-elev.jag"}\hlstd{))}
\end{alltt}
\begin{verbatim}
## model {
## 
## psi ~ dunif(0, 1)  ## Can't put prior on psi *and* beta0
## #lambda.intercept ~ dexp(1)
## #beta0 ~ dnorm(0, 0.1)
## #beta0 <- log(lambda.intercept)
## beta0 <- log(M*psi/Lambda) ## Algebra
## beta1 ~ dnorm(0, 0.1)
## g0 ~ dunif(0, 1)
## sigma ~ dunif(0, 0.5)
## 
## for(g in 1:G) { ## Loop over pixels
## #  lambda[g] <- exp(beta0 + beta1*elevation[g])*pixelArea
##   lambda[g] <- exp(beta1*elevation[g])*pixelArea
##   pi[g] <- lambda[g]/Lambda
## }
## Lambda <- sum(lambda)
## 
## for(i in 1:M) {
##   s[i,1] ~ dunif(xlim[1], xlim[2]) 
##   s[i,2] ~ dunif(ylim[1], ylim[2])
##   pixel[i] <- lookup[round((ylim[2]-s[i,2])/delta+0.5),  ## row
##                      round((s[i,1]-xlim[1])/delta+0.5)]  ## column
##   logProb[i] <- log(pi[pixel[i]])
##   zeros[i] ~ dpois(-logProb[i]) ## zeros trick for IPP
##   z[i] ~ dbern(psi)
##   for(j in 1:J) {
##     dist[i,j] <- sqrt((s[i,1]-x[j,1])^2 + (s[i,2]-x[j,2])^2)
##     p[i,j] <- g0*exp(-dist[i,j]^2/(2*sigma^2))
##   }
## }
## for(i in 1:n) {  ## Model for observed capture histories
##   for(j in 1:J) {
##     y.tilde[i,j] ~ dbinom(p[i,j], K)
##   }
## }
## for(i in (n+1):M) { ## Model for augmented guys
##   PrAtLeastOneCap[i] <- 1-prod(1-p[i,])^K
##   zero.cap[i] ~ dbern(PrAtLeastOneCap[i]*z[i])
## }
## 
## #EN <- sum(lambda) ## Expected value of N
## #psi <- EN/M
## EN <- M*psi
## N <- sum(z)
## }
\end{verbatim}
\end{kframe}
\end{knitrout}
\end{frame}






\begin{frame}[fragile]
  \frametitle{SCR with IPP}
  Create the lookup table
\begin{knitrout}\scriptsize
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{G} \hlkwb{<-} \hlkwd{nrow}\hlstd{(elevation.xyz)}    \hlcom{## nPixels  }
\hlstd{lookup} \hlkwb{<-} \hlkwd{matrix}\hlstd{(}\hlnum{1}\hlopt{:}\hlstd{G,} \hlkwc{nrow}\hlstd{=}\hlkwd{nrow}\hlstd{(elevation),} \hlkwc{ncol}\hlstd{=}\hlkwd{ncol}\hlstd{(elevation))}
\hlstd{delta} \hlkwb{<-} \hlkwd{res}\hlstd{(elevation)[}\hlnum{1}\hlstd{]}  \hlcom{## resolution}
\end{alltt}
\end{kframe}
\end{knitrout}
\end{frame}


\begin{frame}[fragile]
  \frametitle{SCR with IPP}
  Data
  \vspace{-6pt}
\begin{knitrout}\scriptsize
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{M} \hlkwb{<-} \hlnum{150}
\hlstd{y.tilde} \hlkwb{<-} \hlkwd{apply}\hlstd{(y,} \hlkwd{c}\hlstd{(}\hlnum{1}\hlstd{,}\hlnum{2}\hlstd{), sum)}
\hlstd{n} \hlkwb{<-} \hlkwd{nrow}\hlstd{(y)}
\hlstd{jags.data.SCR.elev} \hlkwb{<-} \hlkwd{list}\hlstd{(}\hlkwc{y.tilde}\hlstd{=y.tilde,} \hlkwc{n}\hlstd{=n,} \hlkwc{M}\hlstd{=M,} \hlkwc{J}\hlstd{=J,}
                           \hlkwc{G}\hlstd{=G,} \hlkwc{delta}\hlstd{=delta,} \hlkwc{lookup}\hlstd{=lookup,}
                           \hlkwc{pixelArea}\hlstd{=delta}\hlopt{^}\hlnum{2}\hlopt{*}\hlnum{1e4}\hlstd{,} \hlcom{## Convert to hectares}
                           \hlkwc{elevation}\hlstd{=elevation.xyz}\hlopt{$}\hlstd{elevation,}
                           \hlkwc{z}\hlstd{=}\hlkwd{c}\hlstd{(}\hlkwd{rep}\hlstd{(}\hlnum{1}\hlstd{, n),} \hlkwd{rep}\hlstd{(}\hlnum{NA}\hlstd{, M}\hlopt{-}\hlstd{n)),}
                           \hlkwc{zeros}\hlstd{=}\hlkwd{rep}\hlstd{(}\hlnum{0}\hlstd{, M),}
                           \hlkwc{K}\hlstd{=K,} \hlkwc{zero.cap}\hlstd{=}\hlkwd{rep}\hlstd{(}\hlnum{0}\hlstd{, M),} \hlkwc{x}\hlstd{=x,}
                           \hlkwc{xlim}\hlstd{=}\hlkwd{c}\hlstd{(}\hlnum{0}\hlstd{,}\hlnum{1}\hlstd{),} \hlkwc{ylim}\hlstd{=}\hlkwd{c}\hlstd{(}\hlnum{0}\hlstd{,}\hlnum{1}\hlstd{))}
\end{alltt}
\end{kframe}
\end{knitrout}
\pause
\vfill
  Inits and parameters (same as before)
\begin{knitrout}
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{jp.SCR.elev} \hlkwb{<-} \hlkwd{c}\hlstd{(}\hlstr{"beta0"}\hlstd{,} \hlstr{"beta1"}\hlstd{,} \hlstr{"g0"}\hlstd{,} \hlstr{"sigma"}\hlstd{,} \hlstr{"EN"}\hlstd{,} \hlstr{"N"}\hlstd{)}
\end{alltt}
\end{kframe}
\end{knitrout}
\pause
\vfill
\begin{knitrout}\scriptsize
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{ji.SCR.elev} \hlkwb{<-} \hlkwa{function}\hlstd{() \{}
    \hlkwd{list}\hlstd{(}\hlkwc{z}\hlstd{=}\hlkwd{c}\hlstd{(}\hlkwd{rep}\hlstd{(}\hlnum{NA}\hlstd{, n),} \hlkwd{rep}\hlstd{(}\hlnum{0}\hlstd{,M}\hlopt{-}\hlstd{n)),} \hlcom{#psi=runif(1),}
\hlcom{#         beta0=runif(1, -20, -15),}
         \hlkwc{beta1}\hlstd{=}\hlnum{0.01}\hlstd{,}
         \hlkwc{s}\hlstd{=}\hlkwd{cbind}\hlstd{(}\hlkwd{runif}\hlstd{(M),} \hlkwd{runif}\hlstd{(M)),}
         \hlkwc{g0}\hlstd{=}\hlkwd{runif}\hlstd{(}\hlnum{1}\hlstd{),} \hlkwc{sigma}\hlstd{=}\hlkwd{runif}\hlstd{(}\hlnum{1}\hlstd{,} \hlnum{0.05}\hlstd{,} \hlnum{0.1}\hlstd{)) \}}
\end{alltt}
\end{kframe}
\end{knitrout}
MCMC
  \vspace{-6pt}
\begin{knitrout}\scriptsize
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{jags.post.SCR.elev} \hlkwb{<-} \hlkwd{jags.basic}\hlstd{(}\hlkwc{data}\hlstd{=jags.data.SCR.elev,}
                                 \hlkwc{inits}\hlstd{=ji.SCR.elev,}
                                 \hlkwc{parameters.to.save}\hlstd{=jp.SCR.elev,}
                                 \hlkwc{model.file}\hlstd{=}\hlstr{"SCR-elev.jag"}\hlstd{,}
                                 \hlkwc{n.chains}\hlstd{=}\hlnum{3}\hlstd{,} \hlkwc{n.adapt}\hlstd{=}\hlnum{100}\hlstd{,}
                                 \hlkwc{n.iter}\hlstd{=}\hlnum{1000}\hlstd{,} \hlkwc{parallel}\hlstd{=}\hlnum{TRUE}\hlstd{)}
\end{alltt}
\end{kframe}
\end{knitrout}
\end{frame}




\begin{frame}[fragile]
  \frametitle{Posterior summaries}
\begin{knitrout}\tiny
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlkwd{summary}\hlstd{(jags.post.SCR.elev)}
\end{alltt}
\begin{verbatim}
## 
## Iterations = 1:1000
## Thinning interval = 1 
## Number of chains = 3 
## Sample size per chain = 1000 
## 
## 1. Empirical mean and standard deviation for each variable,
##    plus standard error of the mean:
## 
##                Mean        SD  Naive SE Time-series SE
## EN        9.263e+01 10.713990 1.956e-01      0.5705006
## N         9.275e+01  9.129784 1.667e-01      0.5036545
## beta0    -1.072e+01  2.054192 3.750e-02      0.1473479
## beta1     5.759e-03  0.001890 3.451e-05      0.0001343
## deviance  3.239e+03 34.348548 6.271e-01      2.0159064
## g0        2.358e-01  0.039095 7.138e-04      0.0023399
## sigma     5.007e-02  0.003272 5.974e-05      0.0002151
## 
## 2. Quantiles for each variable:
## 
##                2.5%        25%        50%        75%      97.5%
## EN         72.47013  8.545e+01  9.223e+01  9.946e+01  114.70352
## N          77.00000  8.600e+01  9.200e+01  9.800e+01  113.00000
## beta0     -14.65194 -1.214e+01 -1.076e+01 -9.297e+00   -6.56462
## beta1       0.00187  4.468e-03  5.791e-03  7.065e-03    0.00934
## deviance 3170.31484  3.216e+03  3.239e+03  3.261e+03 3306.13326
## g0          0.16737  2.082e-01  2.328e-01  2.608e-01    0.32239
## sigma       0.04399  4.775e-02  5.007e-02  5.224e-02    0.05658
\end{verbatim}
\end{kframe}
\end{knitrout}
\end{frame}



\begin{frame}[fragile]
  \frametitle{Traceplots and density plots}
\begin{knitrout}\footnotesize
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlkwd{plot}\hlstd{(jags.post.SCR.elev[,jp.SCR.elev[}\hlnum{1}\hlopt{:}\hlnum{3}\hlstd{]])}
\end{alltt}
\end{kframe}

{\centering \includegraphics[width=0.7\textwidth]{figure/plot-mcmc-SCR-elev1-1} 

}



\end{knitrout}
\end{frame}



\begin{frame}[fragile]
  \frametitle{Traceplots and density plots}
\begin{knitrout}\footnotesize
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlkwd{plot}\hlstd{(jags.post.SCR.elev[,jp.SCR.elev[}\hlnum{4}\hlopt{:}\hlnum{6}\hlstd{]])}
\end{alltt}
\end{kframe}

{\centering \includegraphics[width=0.7\textwidth]{figure/plot-mcmc-SCR-elev2-1} 

}



\end{knitrout}
\end{frame}




\begin{frame}[fragile]
  \frametitle{Predicted density surface in JAGS}
  Extract posterior samples of $\beta_0$ and $\beta_1$. 
\begin{knitrout}\scriptsize
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{beta.post} \hlkwb{<-} \hlkwd{as.matrix}\hlstd{(jags.post.SCR.elev[,}\hlkwd{c}\hlstd{(}\hlstr{"beta0"}\hlstd{,}\hlstr{"beta1"}\hlstd{)])}
\hlstd{n.samples} \hlkwb{<-} \hlkwd{nrow}\hlstd{(beta.post)}
\end{alltt}
\end{kframe}
\end{knitrout}
  Compute density surface for every MCMC sample
\begin{knitrout}\scriptsize
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{lambda.post} \hlkwb{<-} \hlkwd{matrix}\hlstd{(}\hlnum{NA}\hlstd{, n.pixels, n.samples)}
\hlkwa{for}\hlstd{(i} \hlkwa{in} \hlnum{1}\hlopt{:}\hlstd{n.samples) \{}
    \hlstd{lambda.post[,i]} \hlkwb{<-} \hlkwd{exp}\hlstd{(}
        \hlstd{beta.post[i,}\hlstr{"beta0"}\hlstd{]} \hlopt{+}
        \hlstd{beta.post[i,}\hlstr{"beta1"}\hlstd{]}\hlopt{*}\hlstd{elevation.xyz}\hlopt{$}\hlstd{elevation)}
\hlstd{\}}
\hlstd{lambda.post.mean} \hlkwb{<-} \hlkwd{rowMeans}\hlstd{(lambda.post)}
\hlstd{lambda.post.lower} \hlkwb{<-} \hlkwd{apply}\hlstd{(lambda.post,} \hlnum{1}\hlstd{, quantile,} \hlkwc{prob}\hlstd{=}\hlnum{0.025}\hlstd{)}
\hlstd{lambda.post.upper} \hlkwb{<-} \hlkwd{apply}\hlstd{(lambda.post,} \hlnum{1}\hlstd{, quantile,} \hlkwc{prob}\hlstd{=}\hlnum{0.975}\hlstd{)}
\end{alltt}
\end{kframe}
\end{knitrout}
\end{frame}




\begin{frame}[fragile]
  \frametitle{Predicted density surface}
\begin{knitrout}\scriptsize
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlkwd{library}\hlstd{(latticeExtra)}
\hlstd{panel1} \hlkwb{<-} \hlkwd{levelplot}\hlstd{(lambda.post.lower} \hlopt{~} \hlstd{x}\hlopt{+}\hlstd{y, elevation.xyz,} \hlkwc{aspect}\hlstd{=}\hlstr{"iso"}\hlstd{,}
                    \hlkwc{colorkey}\hlstd{=}\hlkwd{list}\hlstd{(}\hlkwc{space}\hlstd{=}\hlstr{"bottom"}\hlstd{),} \hlkwc{xlab}\hlstd{=}\hlstr{""}\hlstd{,} \hlkwc{ylab}\hlstd{=}\hlstr{""}\hlstd{)}
\hlstd{panel2} \hlkwb{<-} \hlkwd{levelplot}\hlstd{(lambda.post.mean} \hlopt{~}\hlstd{x}\hlopt{+}\hlstd{y, elevation.xyz,} \hlkwc{aspect}\hlstd{=}\hlstr{"iso"}\hlstd{)}
\hlstd{panel3} \hlkwb{<-} \hlkwd{levelplot}\hlstd{(lambda.post.upper} \hlopt{~}\hlstd{x}\hlopt{+}\hlstd{y, elevation.xyz,} \hlkwc{aspect}\hlstd{=}\hlstr{"iso"}\hlstd{)}
\hlstd{panels} \hlkwb{<-} \hlkwd{c}\hlstd{(panel1, panel2, panel3)}
\hlstd{panels} \hlkwb{<-} \hlkwd{update}\hlstd{(}
    \hlstd{panels,} \hlkwc{scales}\hlstd{=}\hlkwd{list}\hlstd{(}\hlkwc{draw}\hlstd{=}\hlnum{FALSE}\hlstd{),} \hlkwc{layout}\hlstd{=}\hlkwd{c}\hlstd{(}\hlnum{3}\hlstd{,}\hlnum{1}\hlstd{),}
    \hlkwc{xlab}\hlstd{=}\hlstr{""}\hlstd{,} \hlkwc{ylab}\hlstd{=}\hlstr{""}\hlstd{,}
    \hlkwc{par.settings}\hlstd{=}\hlkwd{ggplot2like}\hlstd{(),} \hlcom{#theEconomist.theme(), }
    \hlkwc{strip}\hlstd{=}\hlkwd{strip.custom}\hlstd{(}
        \hlkwc{factor.levels}\hlstd{=}\hlkwd{c}\hlstd{(}\hlstr{"Lower CI"}\hlstd{,}\hlstr{"Posterior mean"}\hlstd{,}\hlstr{"Upper CI"}\hlstd{)))}
\hlkwd{plot}\hlstd{(panels)}
\end{alltt}
\end{kframe}
\end{knitrout}
\end{frame}




\begin{frame}
  \frametitle{Predicted density surface}
  Posterior mean and 95\% CI \\
  \includegraphics[width=\textwidth]{figure/lambda-post-1}  
\end{frame}




\begin{frame}[fragile]
  \frametitle{Realized density surface}
  We need to monitor $z$ and $\bsi$.
\begin{knitrout}\scriptsize
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{jags.post.SCR.elev.sz} \hlkwb{<-} \hlkwd{jags.basic}\hlstd{(}
    \hlkwc{data}\hlstd{=jags.data.SCR.elev,} \hlkwc{inits}\hlstd{=ji.SCR.elev,}
    \hlkwc{parameters.to.save}\hlstd{=}\hlkwd{c}\hlstd{(jp.SCR.elev,}\hlstr{"s"}\hlstd{,}\hlstr{"z"}\hlstd{),}
    \hlkwc{model.file}\hlstd{=}\hlstr{"SCR-elev.jag"}\hlstd{,}
    \hlkwc{n.chains}\hlstd{=}\hlnum{3}\hlstd{,} \hlkwc{n.adapt}\hlstd{=}\hlnum{100}\hlstd{,} \hlkwc{n.iter}\hlstd{=}\hlnum{1000}\hlstd{,} \hlkwc{parallel}\hlstd{=}\hlnum{TRUE}\hlstd{)}
\end{alltt}
\end{kframe}
\end{knitrout}
\pause \vfill
  Extract posterior samples of $z$ and $\bsi$. 
\begin{knitrout}\scriptsize
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{s1.post} \hlkwb{<-} \hlkwd{as.matrix}\hlstd{(jags.post.SCR.elev.sz[,}\hlkwd{paste0}\hlstd{(}\hlstr{"s["}\hlstd{,} \hlnum{1}\hlopt{:}\hlstd{M,} \hlstr{",1]"}\hlstd{)])}
\hlstd{s2.post} \hlkwb{<-} \hlkwd{as.matrix}\hlstd{(jags.post.SCR.elev.sz[,}\hlkwd{paste0}\hlstd{(}\hlstr{"s["}\hlstd{,} \hlnum{1}\hlopt{:}\hlstd{M,} \hlstr{",2]"}\hlstd{)])}
\hlstd{z.post} \hlkwb{<-} \hlkwd{as.matrix}\hlstd{(jags.post.SCR.elev.sz[,}\hlkwd{paste0}\hlstd{(}\hlstr{"z["}\hlstd{,} \hlnum{1}\hlopt{:}\hlstd{M,} \hlstr{"]"}\hlstd{)])}
\end{alltt}
\end{kframe}
\end{knitrout}
Chop activity centers into discrete intervals, then tabulate.
\begin{knitrout}\scriptsize
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{lambda.r.post} \hlkwb{<-} \hlkwd{array}\hlstd{(}\hlnum{NA}\hlstd{,} \hlkwd{c}\hlstd{(}\hlkwd{sqrt}\hlstd{(n.pixels),} \hlkwd{sqrt}\hlstd{(n.pixels), n.samples))}
\hlkwa{for}\hlstd{(i} \hlkwa{in} \hlnum{1}\hlopt{:}\hlstd{n.samples) \{}
    \hlstd{si1.post.d} \hlkwb{<-} \hlkwd{cut}\hlstd{(s1.post[i,z.post[i,]}\hlopt{==}\hlnum{1}\hlstd{],} \hlkwc{breaks}\hlstd{=}\hlkwd{seq}\hlstd{(}\hlnum{0}\hlstd{,} \hlnum{1}\hlstd{, delta))}
    \hlstd{si2.post.d} \hlkwb{<-} \hlkwd{cut}\hlstd{(s2.post[i,z.post[i,]}\hlopt{==}\hlnum{1}\hlstd{],} \hlkwc{breaks}\hlstd{=}\hlkwd{seq}\hlstd{(}\hlnum{0}\hlstd{,} \hlnum{1}\hlstd{, delta))}
    \hlstd{pixel.counts} \hlkwb{<-} \hlkwd{table}\hlstd{(si2.post.d, si1.post.d)}
    \hlstd{lambda.r.post[,,i]} \hlkwb{<-} \hlstd{pixel.counts[}\hlkwd{sqrt}\hlstd{(n.pixels)}\hlopt{:}\hlnum{1}\hlstd{,]}
\hlstd{\}}
\end{alltt}
\end{kframe}
\end{knitrout}
\end{frame}



\begin{frame}[fragile]
  \frametitle{Realized density surface}
\begin{knitrout}\scriptsize
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{lambda.r.mean} \hlkwb{<-} \hlkwd{raster}\hlstd{(}\hlkwd{t}\hlstd{(}\hlkwd{apply}\hlstd{(lambda.r.post,} \hlkwd{c}\hlstd{(}\hlnum{1}\hlstd{,}\hlnum{2}\hlstd{), mean)))}
\hlstd{lambda.e.mean} \hlkwb{<-} \hlkwd{raster}\hlstd{(}\hlkwd{matrix}\hlstd{(lambda.post.mean,} \hlkwd{sqrt}\hlstd{(n.pixels)))}
\hlstd{lambda.re} \hlkwb{<-} \hlkwd{stack}\hlstd{(lambda.r.mean, lambda.e.mean)}
\hlkwd{names}\hlstd{(lambda.re)} \hlkwb{<-} \hlkwd{c}\hlstd{(}\hlstr{"Realized"}\hlstd{,} \hlstr{"Expected"}\hlstd{)}
\hlkwd{plot}\hlstd{(lambda.re)}
\end{alltt}
\end{kframe}
\includegraphics[width=\maxwidth]{figure/lambda-r-1} 

\end{knitrout}
\end{frame}



\begin{frame}[fragile]
  \frametitle{Posterior distribution of $\bsi$}
  \small
  Posterior distribution of $\bs_1$. 
\begin{knitrout}\scriptsize
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlkwd{plot}\hlstd{(x,} \hlkwc{asp}\hlstd{=}\hlnum{1}\hlstd{,} \hlkwc{xlim}\hlstd{=}\hlnum{0}\hlopt{:}\hlnum{1}\hlstd{,} \hlkwc{ylim}\hlstd{=}\hlnum{0}\hlopt{:}\hlnum{1}\hlstd{,} \hlkwc{pch}\hlstd{=}\hlnum{3}\hlstd{,} \hlkwc{axes}\hlstd{=}\hlnum{FALSE}\hlstd{,} \hlkwc{ann}\hlstd{=}\hlnum{FALSE}\hlstd{)}
\hlkwd{points}\hlstd{(s1.post[,}\hlnum{1}\hlstd{], s2.post[,}\hlnum{1}\hlstd{],} \hlkwc{pch}\hlstd{=}\hlnum{16}\hlstd{,} \hlkwc{col}\hlstd{=}\hlkwd{rgb}\hlstd{(}\hlnum{0}\hlstd{,}\hlnum{0}\hlstd{,}\hlnum{1}\hlstd{,}\hlnum{0.1}\hlstd{))}
\hlkwd{contour}\hlstd{(MASS}\hlopt{::}\hlkwd{kde2d}\hlstd{(s1.post[,}\hlnum{1}\hlstd{], s2.post[,}\hlnum{1}\hlstd{]),} \hlkwc{add}\hlstd{=}\hlnum{TRUE}\hlstd{)}
\hlkwd{points}\hlstd{(x[y.tilde[}\hlnum{1}\hlstd{,]}\hlopt{>}\hlnum{0}\hlstd{,,}\hlkwc{drop}\hlstd{=}\hlnum{FALSE}\hlstd{],} \hlkwc{pch}\hlstd{=}\hlnum{3}\hlstd{,} \hlkwc{col}\hlstd{=}\hlstr{"red"}\hlstd{,} \hlkwc{lwd}\hlstd{=}\hlnum{2}\hlstd{,} \hlkwc{cex}\hlstd{=}\hlnum{2}\hlstd{)}
\end{alltt}
\end{kframe}
\end{knitrout}
\vspace{-1.1cm}
\centering
\includegraphics[width=0.75\textwidth]{figure/si-post-1} \\
\end{frame}



\begin{frame}[fragile]
  \frametitle{Posterior distribution of $\bsi$}
  \small
  Posterior distribution of $\bs_i$

%\vfill
\vspace{-0.5cm}
\centering
\only<1>{\includegraphics[width=0.85\textwidth]{figure/si-post-i-2} \\}
%\only<2>{\includegraphics[width=0.85\textwidth]{figure/si-post-i-3} \\}
% \only<3>{\includegraphics[width=0.85\textwidth]{figure/si-post-i-4} \\}
\foreach \n in {3,...,58} {%
  \only<\n>{\includegraphics[width=0.85\textwidth]{figure/si-post-i-\n}\\}
}
\end{frame}




\begin{frame}[fragile]
  \frametitle{Posterior distribution of $\bsi$}
  \small
  Posterior distribution of $\bs_{n+1}$. 
\begin{knitrout}\scriptsize
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlkwd{plot}\hlstd{(x,} \hlkwc{asp}\hlstd{=}\hlnum{1}\hlstd{,} \hlkwc{xlim}\hlstd{=}\hlnum{0}\hlopt{:}\hlnum{1}\hlstd{,} \hlkwc{ylim}\hlstd{=}\hlnum{0}\hlopt{:}\hlnum{1}\hlstd{,} \hlkwc{pch}\hlstd{=}\hlnum{3}\hlstd{,} \hlkwc{axes}\hlstd{=}\hlnum{FALSE}\hlstd{,} \hlkwc{ann}\hlstd{=}\hlnum{FALSE}\hlstd{)}
\hlkwd{points}\hlstd{(s1.post[z.post[,}\hlnum{150}\hlstd{]}\hlopt{==}\hlnum{1}\hlstd{,}\hlnum{150}\hlstd{],}
       \hlstd{s2.post[z.post[,}\hlnum{150}\hlstd{]}\hlopt{==}\hlnum{1}\hlstd{,}\hlnum{150}\hlstd{],} \hlkwc{pch}\hlstd{=}\hlnum{16}\hlstd{,} \hlkwc{col}\hlstd{=}\hlkwd{rgb}\hlstd{(}\hlnum{0}\hlstd{,}\hlnum{0}\hlstd{,}\hlnum{1}\hlstd{,}\hlnum{0.8}\hlstd{))}
\end{alltt}
\end{kframe}
\end{knitrout}
%\vspace{-1.1cm}
\centering
\includegraphics[width=0.5\textwidth]{figure/si-post-y0-1} \\
\end{frame}





\begin{frame}
  \frametitle{Summary}
\end{frame}




\section{Assignment}




\begin{frame}[fragile]
  \frametitle{Assignment}
  Create a self-contained R script or Rmarkdown file to do the
  following: 
  \vfill
  \begin{enumerate}
    \item Fit a ``local behavioral response'' model,
      rather than a ``global behavioral response'' model in secr.
    \item Fit a model in JAGS where $g_0$ varies among
      occasions. Compare estimates of $E(N)$ and $N$ to the estimates
      from secr for the same model (which we fit earlier).
  \end{enumerate}
  \vfill
  Upload your {\tt .R} or {\tt .Rmd} file to ELC before Tuesday. 
\end{frame}





\end{document}

