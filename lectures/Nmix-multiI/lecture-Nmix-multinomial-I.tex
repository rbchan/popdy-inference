\documentclass[color=usenames,dvipsnames]{beamer}\usepackage[]{graphicx}\usepackage[]{color}
% maxwidth is the original width if it is less than linewidth
% otherwise use linewidth (to make sure the graphics do not exceed the margin)
\makeatletter
\def\maxwidth{ %
  \ifdim\Gin@nat@width>\linewidth
    \linewidth
  \else
    \Gin@nat@width
  \fi
}
\makeatother

\definecolor{fgcolor}{rgb}{0, 0, 0}
\newcommand{\hlnum}[1]{\textcolor[rgb]{0.69,0.494,0}{#1}}%
\newcommand{\hlstr}[1]{\textcolor[rgb]{0.749,0.012,0.012}{#1}}%
\newcommand{\hlcom}[1]{\textcolor[rgb]{0.514,0.506,0.514}{\textit{#1}}}%
\newcommand{\hlopt}[1]{\textcolor[rgb]{0,0,0}{#1}}%
\newcommand{\hlstd}[1]{\textcolor[rgb]{0,0,0}{#1}}%
\newcommand{\hlkwa}[1]{\textcolor[rgb]{0,0,0}{\textbf{#1}}}%
\newcommand{\hlkwb}[1]{\textcolor[rgb]{0,0.341,0.682}{#1}}%
\newcommand{\hlkwc}[1]{\textcolor[rgb]{0,0,0}{\textbf{#1}}}%
\newcommand{\hlkwd}[1]{\textcolor[rgb]{0.004,0.004,0.506}{#1}}%
\let\hlipl\hlkwb

\usepackage{framed}
\makeatletter
\newenvironment{kframe}{%
 \def\at@end@of@kframe{}%
 \ifinner\ifhmode%
  \def\at@end@of@kframe{\end{minipage}}%
  \begin{minipage}{\columnwidth}%
 \fi\fi%
 \def\FrameCommand##1{\hskip\@totalleftmargin \hskip-\fboxsep
 \colorbox{shadecolor}{##1}\hskip-\fboxsep
     % There is no \\@totalrightmargin, so:
     \hskip-\linewidth \hskip-\@totalleftmargin \hskip\columnwidth}%
 \MakeFramed {\advance\hsize-\width
   \@totalleftmargin\z@ \linewidth\hsize
   \@setminipage}}%
 {\par\unskip\endMakeFramed%
 \at@end@of@kframe}
\makeatother

\definecolor{shadecolor}{rgb}{.97, .97, .97}
\definecolor{messagecolor}{rgb}{0, 0, 0}
\definecolor{warningcolor}{rgb}{1, 0, 1}
\definecolor{errorcolor}{rgb}{1, 0, 0}
\newenvironment{knitrout}{}{} % an empty environment to be redefined in TeX

\usepackage{alltt}
%\documentclass[color=usenames,dvipsnames,handout]{beamer}

\usepackage[roman]{../lectures}
%\usepackage[sans]{../lectures}


\hypersetup{pdfpagemode=UseNone,pdfstartview={FitV}}



% Load function to compile and open PDF


% Compile and open PDF






%% New command for inline code that isn't to be evaluated
\definecolor{inlinecolor}{rgb}{0.878, 0.918, 0.933}
\newcommand{\inr}[1]{\colorbox{inlinecolor}{\texttt{#1}}}
\IfFileExists{upquote.sty}{\usepackage{upquote}}{}
\begin{document}




\begin{frame}[plain]
  \LARGE
%  \maketitle
  \centering
  {\LARGE Lecture 8 -- Multinomial $N$-mixture models: \\ simulation, fitting, and prediction} \\
  {\color{default} \rule{\textwidth}{0.1pt}}
  \vfill
  \large
  WILD(FISH) 8390 \\
  Estimation of Fish and Wildlife Population Parameters \\
  \vfill
  \large
  Richard Chandler \\
  University of Georgia \\
\end{frame}






\section{Overview}



\begin{frame}[plain]
  \frametitle{Outline}
  \Large
  \only<1>{\tableofcontents}%[hideallsubsections]}
  \only<2 | handout:0>{\tableofcontents[currentsection]}%,hideallsubsections]}
\end{frame}



\begin{frame}
  \frametitle{Overview}
  The objectives are the same as with binomial $N$-mixture models. %\\
%  \pause
%  \vfill
  We want to:
  \begin{itemize}
    \item Estimate abundance
    \item Model spatial variation in abundance/density
  \end{itemize}
  \pause
  \vfill
  The difference is that, instead of repeated count data at each site,
  we have data from sampling methods such as:
  \begin{itemize}
    \item<2-> Double observer sampling
    \item<3-> Removal sampling
    \item<4-> Mark-recapture
    \item<5-> Distance sampling
    \item<6-> And others that yield multinomial counts\dots
  \end{itemize}
\end{frame}




\begin{frame}
  \frametitle{Multinomial $N$-mixture model}
  \small
  State model (with Poisson assumption)
  \begin{gather*}
    \mathrm{log}(\lambda_i) = \beta_0 + \beta_1 {\color{blue} x_{i1}} +
    \beta_2 {\color{blue} x_{i2}} + \cdots \\
    N_i \sim \mathrm{Poisson}(\lambda_i)
  \end{gather*}
  \pause
  \vfill
  Observation model
  \begin{gather*}
    \mathrm{logit}(p_{ij}) = \alpha_0 + \alpha_1 {\color{blue} x_{i1}}
    + \alpha_2 {\color{Purple} w_{ij}} + \cdots \\
    \{y_{i1}, \dots, y_{iK}\}  \sim \mathrm{Multinomial}(N_i,
    \pi(p_{i1}, \dots, p_{iJ}))
  \end{gather*}
  \pause
%  \vfill
  \small
  Definitions \\
  $\lambda_i$ -- Expected value of abundance at site $i$ \\
  $N_i$ -- Realized value of abundance at site $i$ \\
  $p_{ij}$ -- Probability of detecting \alert{an individual} at site $i$ on occasion $j$ \\
  $\pi(p)$ -- A function mapping $J$ detection probabilities to
  $K$ multinomial cell probabilities \\
  $y_{ik}$ -- Multinomial count data \\
%  \vfill
  $\color{blue} x_1$ and $\color{blue} x_2$ -- site covariates \\
%  \vspace{12pt}
  $\color{Purple} w$ -- observation covariate
\end{frame}




\begin{frame}[fragile]
  \frametitle{The multinomial distribution}
  \small
  This is the first multivariate distribution we've covered. \\
  \[
    \{y_{1}, \dots, y_{K}\}  \sim \mathrm{Multinomial}(N, \{\pi_i, \dots, \pi_K\})
  \]
  \pause
%  \vfill
  The multinomial describes how $N$ objects are distributed among
  $K$ classes (also called bins, categories, etc\dots). \\
  \pause
  \vfill
  Imagine $N=20$ animals studied for 1 year with 3 possible outcomes
  and associated probabilities: \\
  $\Pr(\mathrm{survived})=0.5$, $\Pr(\mathrm{depredated})=0.3$, $\Pr(\mathrm{starved})=0.2$. \\
  \pause
  \vfill
  Here is one possible outcome:
  \vspace{-6pt}
\begin{knitrout}\footnotesize
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{N} \hlkwb{<-} \hlnum{20}
\hlstd{pi} \hlkwb{<-} \hlkwd{c}\hlstd{(}\hlkwc{survived}\hlstd{=}\hlnum{0.5}\hlstd{,} \hlkwc{depredated}\hlstd{=}\hlnum{0.3}\hlstd{,} \hlkwc{starved}\hlstd{=}\hlnum{0.2}\hlstd{)}
\hlkwd{drop}\hlstd{(}\hlkwd{rmultinom}\hlstd{(}\hlkwc{n}\hlstd{=}\hlnum{1}\hlstd{,} \hlkwc{size}\hlstd{=N,} \hlkwc{prob}\hlstd{=pi))}
\end{alltt}
\begin{verbatim}
##   survived depredated    starved 
##         11          8          1
\end{verbatim}
\end{kframe}
\end{knitrout}
  \pause
  \vfill
  \centering
  Note: the probabilities must sum to 1 and the counts must sum to $N$. \\
\end{frame}



\begin{frame}[fragile]
  \frametitle{\normalsize Multinomial/Categorical vs Binomial/Bernoulli}
  \centering
  \fbox{\includegraphics[width=0.85\textwidth]{figs/fig7-1}} \\
\end{frame}



\begin{frame}
  \frametitle{Sampling methods}
  Benefits of the multinomial $N$-mixture model
  \begin{itemize}
    \item Can be applied to data from many sampling designs, simply by
      changing how the $\pi$ probabilities are computed. %\\
    \item Precision is typically better than binomial $N$-mixture
      models because there's more information in the data
  \end{itemize}
  \pause
  \vfill
  Removal sampling %\\
  \[
    {\pi(p)} = \{p, (1-p)p, (1-p)^2p, \dots, (1-p)^{K-1}p, (1-p)^K\}
  \]
  \pause %\vfill
  Double observer (\alert{independent observers})
  \[
    {\pi(p)} = \{p_1(1-p_2), (1-p_1)p_2, p_1p_2, (1-p_1)(1-p_2)\}
  \]
  \pause %\vfill
  Double observer (\alert{dependent observers})
  \[
    {\pi(p)} = \{p_1, (1-p_1)p_2, (1-p_1)(1-p_2)\}
  \]
\end{frame}












%\section{Simulation}

\section{Removal sampling}

\subsection{Likelihood-based methods}

\begin{frame}
  \frametitle{Outline}
  \Large
%  \tableofcontents[currentsection,currentsubsection]
  \tableofcontents[currentsection]
\end{frame}



\begin{frame}
  \frametitle{Removal sampling}
  \small
  Removal sampling is often used in electrofishing studies. \\
  \pause
  \vfill
  A stream section is surveyed $J$ times, fish are removed on each
  ``pass'', and the rate of removal tells us about capture
  probability.  
  \pause
  \vfill
  Definitions
  \begin{itemize}
    \setlength\itemsep{1pt}
    \item $y_{ij}$ -- number of individuals removed at site $i$ on pass $j$
    \item $p$ -- probability of catching an individual on a single pass
  \end{itemize}
  \pause \vfill
  \footnotesize
  \begin{tabular}{lc}
    \hline
    \centering
    Description                       & Multinomial cell probability \\
    \hline
    Pr(first captured on first pass)  & $\pi_1 = p$                  \\
    Pr(first captured on second pass) & $\pi_2 = (1-p)p$             \\
    Pr(first captured on third pass)  & $\pi_3 = (1-p)(1-p)p$        \\
    {\centering $\cdots$}             & $\cdots$                     \\
    Pr(first captured on pass $J$)    & $\pi_J = (1-p)^{J-1}p$       \\
    Pr(not captured)                  & $\pi_{J+1} = (1-p)^J$          \\
    \hline
  \end{tabular}
\end{frame}







\begin{frame}[fragile]
  \frametitle{Removal sampling, no covariates}
  \small
  Abundance
\begin{knitrout}\scriptsize
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{nSites} \hlkwb{<-} \hlnum{100}
\hlstd{lambda1} \hlkwb{<-} \hlnum{2.6}  \hlcom{## Expected value of N}
\hlstd{N1} \hlkwb{<-} \hlkwd{rpois}\hlstd{(}\hlkwc{n}\hlstd{=nSites,} \hlkwc{lambda}\hlstd{=lambda1)}
\end{alltt}
\end{kframe}
\end{knitrout}
% \item
  \pause
  \vfill
  Capture probability and \alert{all} multinomial counts
\begin{knitrout}\scriptsize
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{nPasses} \hlkwb{<-} \hlnum{3}
\hlstd{K} \hlkwb{<-} \hlstd{nPasses}\hlopt{+}\hlnum{1}  \hlcom{# multinomial cells}
\hlstd{p1} \hlkwb{<-} \hlnum{0.3}
\hlstd{pi1} \hlkwb{<-} \hlkwd{c}\hlstd{(p1, (}\hlnum{1}\hlopt{-}\hlstd{p1)}\hlopt{*}\hlstd{p1, (}\hlnum{1}\hlopt{-}\hlstd{p1)}\hlopt{*}\hlstd{(}\hlnum{1}\hlopt{-}\hlstd{p1)}\hlopt{*}\hlstd{p1, (}\hlnum{1}\hlopt{-}\hlstd{p1)}\hlopt{^}\hlnum{3}\hlstd{)}
\hlstd{y1.all} \hlkwb{<-} \hlkwd{matrix}\hlstd{(}\hlnum{NA}\hlstd{,} \hlkwc{nrow}\hlstd{=nSites,} \hlkwc{ncol}\hlstd{=K)}
\hlkwa{for}\hlstd{(i} \hlkwa{in} \hlnum{1}\hlopt{:}\hlstd{nSites) \{}
    \hlstd{y1.all[i,]} \hlkwb{<-} \hlkwd{rmultinom}\hlstd{(}\hlkwc{n}\hlstd{=}\hlnum{1}\hlstd{,} \hlkwc{size}\hlstd{=N1[i],} \hlkwc{prob}\hlstd{=pi1)    \}}
\end{alltt}
\end{kframe}
\end{knitrout}
%\end{enumerate}
  \pause
  \vfill
  Discard final column of individuals not detected
\begin{knitrout}\scriptsize
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{y1} \hlkwb{<-} \hlstd{y1.all[,}\hlopt{-}\hlstd{K]}
\hlkwd{head}\hlstd{(y1,} \hlkwc{n}\hlstd{=}\hlnum{3}\hlstd{)}
\end{alltt}
\begin{verbatim}
##      [,1] [,2] [,3]
## [1,]    0    0    0
## [2,]    2    1    2
## [3,]    2    0    1
\end{verbatim}
\end{kframe}
\end{knitrout}
\end{frame}



\begin{frame}[fragile]
  \frametitle{Removal model, covariates}
  \small
  Covariates
  \vspace{-6pt}
\begin{knitrout}\scriptsize
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{streamDepth} \hlkwb{<-} \hlkwd{rnorm}\hlstd{(nSites)}
\end{alltt}
\end{kframe}
\end{knitrout}
% \item
\vfill
  Coefficients, $\lambda$, and $p$
  \vspace{-6pt}
\begin{knitrout}\scriptsize
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{beta0} \hlkwb{<-} \hlnum{1}\hlstd{; beta1} \hlkwb{<-} \hlnum{0.5}
\hlstd{lambda2} \hlkwb{<-} \hlkwd{exp}\hlstd{(beta0} \hlopt{+} \hlstd{beta1}\hlopt{*}\hlstd{streamDepth)}
\hlstd{alpha0} \hlkwb{<-} \hlnum{0}\hlstd{; alpha1} \hlkwb{<-} \hlopt{-}\hlnum{1}
\hlstd{p2} \hlkwb{<-} \hlkwd{plogis}\hlstd{(alpha0} \hlopt{+} \hlstd{alpha1}\hlopt{*}\hlstd{streamDepth)}
\hlstd{pi2} \hlkwb{<-} \hlkwd{t}\hlstd{(}\hlkwd{sapply}\hlstd{(p2,} \hlkwa{function}\hlstd{(}\hlkwc{p}\hlstd{)} \hlkwd{c}\hlstd{(p, (}\hlnum{1}\hlopt{-}\hlstd{p)}\hlopt{*}\hlstd{p, (}\hlnum{1}\hlopt{-}\hlstd{p)}\hlopt{^}\hlnum{2}\hlopt{*}\hlstd{p, (}\hlnum{1}\hlopt{-}\hlstd{p)}\hlopt{^}\hlnum{3}\hlstd{)))}
\end{alltt}
\end{kframe}
\end{knitrout}
% \item
\vfill
  Simulate abundance and removal data
  \vspace{-6pt}
\begin{knitrout}\scriptsize
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{N2} \hlkwb{<-} \hlkwd{rpois}\hlstd{(nSites,} \hlkwc{lambda}\hlstd{=lambda2)}         \hlcom{## local abundance }
\hlstd{y2.all} \hlkwb{<-} \hlkwd{matrix}\hlstd{(}\hlnum{NA}\hlstd{,} \hlkwc{nrow}\hlstd{=nSites,} \hlkwc{ncol}\hlstd{=K)}
\hlkwa{for}\hlstd{(i} \hlkwa{in} \hlnum{1}\hlopt{:}\hlstd{nSites) \{}
    \hlstd{y2.all[i,]} \hlkwb{<-} \hlkwd{rmultinom}\hlstd{(}\hlkwc{n}\hlstd{=}\hlnum{1}\hlstd{,} \hlkwc{size}\hlstd{=N2[i],} \hlkwc{prob}\hlstd{=pi2[i,])}
\hlstd{\}}
\hlstd{y2} \hlkwb{<-} \hlstd{y2.all[,}\hlopt{-}\hlstd{K]}
\end{alltt}
\end{kframe}
\end{knitrout}
%\end{enumerate}
\end{frame}




\begin{frame}[fragile]
  \frametitle{Simulated data}
  \begin{columns}
    \begin{column}{0.4\textwidth}
      \small
      Observations
%      \tiny
  \vspace{-6pt}
\begin{knitrout}\scriptsize
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{y2[}\hlnum{1}\hlopt{:}\hlnum{19}\hlstd{,]}
\end{alltt}
\begin{verbatim}
##       [,1] [,2] [,3]
##  [1,]    3    0    0
##  [2,]    2    0    1
##  [3,]    2    0    0
##  [4,]    2    0    0
##  [5,]    0    0    0
##  [6,]    2    2    0
##  [7,]    3    0    0
##  [8,]    0    1    1
##  [9,]    0    0    0
## [10,]    0    1    0
## [11,]    0    0    0
## [12,]    2    0    0
## [13,]    0    2    0
## [14,]    1    1    0
## [15,]    2    2    1
## [16,]    4    0    0
## [17,]    0    0    2
## [18,]    3    3    0
## [19,]    1    0    0
\end{verbatim}
\end{kframe}
\end{knitrout}
  \end{column}
  \begin{column}{0.6\textwidth}
    \pause
%    \scriptsize
    {\centering Summary stats \\}
    \vspace{24pt}
    \small
    Proportion of sites known to be occupied
    \vspace{-6pt}
\begin{knitrout}\scriptsize
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlcom{# Max count at each site}
\hlstd{maxCounts} \hlkwb{<-} \hlkwd{apply}\hlstd{(y2,} \hlnum{1}\hlstd{, max)}
\hlstd{naiveOccupancy} \hlkwb{<-} \hlkwd{sum}\hlstd{(maxCounts}\hlopt{>}\hlnum{0}\hlstd{)}\hlopt{/}\hlstd{nSites}
\hlstd{naiveOccupancy}
\end{alltt}
\begin{verbatim}
## [1] 0.9
\end{verbatim}
\end{kframe}
\end{knitrout}
  \pause
  \vfill
  \small
  Captures on each pass
  \vspace{-6pt}
\begin{knitrout}\scriptsize
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlkwd{colSums}\hlstd{(y2)}
\end{alltt}
\begin{verbatim}
## [1] 117  55  28
\end{verbatim}
\end{kframe}
\end{knitrout}
  Naive abundance
  \vspace{-6pt}
\begin{knitrout}\scriptsize
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlkwd{sum}\hlstd{(y2)}
\end{alltt}
\begin{verbatim}
## [1] 200
\end{verbatim}
\end{kframe}
\end{knitrout}

  \end{column}
  \end{columns}
\end{frame}









%\section{Prediction}



% \begin{frame}
%   \frametitle{Outline}
%   \Large
%   \tableofcontents[currentsection]
% \end{frame}






\begin{frame}[fragile]
  \frametitle{Prepare data in `unmarked'}
  \small
\begin{knitrout}\tiny
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{umf} \hlkwb{<-} \hlkwd{unmarkedFrameMPois}\hlstd{(}\hlkwc{y}\hlstd{=y2,} \hlkwc{siteCovs}\hlstd{=}\hlkwd{data.frame}\hlstd{(streamDepth),} \hlkwc{type}\hlstd{=}\hlstr{"removal"}\hlstd{)}
\end{alltt}
\end{kframe}
\end{knitrout}
\pause
\begin{knitrout}\scriptsize
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlkwd{summary}\hlstd{(umf)}
\end{alltt}
\begin{verbatim}
## unmarkedFrame Object
## 
## 100 sites
## Maximum number of observations per site: 3 
## Mean number of observations per site: 3 
## Sites with at least one detection: 90 
## 
## Tabulation of y observations:
##   0   1   2   3   4 
## 166  82  39  12   1 
## 
## Site-level covariates:
##   streamDepth      
##  Min.   :-1.98353  
##  1st Qu.:-0.48806  
##  Median : 0.04055  
##  Mean   : 0.10013  
##  3rd Qu.: 0.78351  
##  Max.   : 2.64727
\end{verbatim}
\end{kframe}
\end{knitrout}
\end{frame}


% > fm <- multinomPois(~temp ~forest, umf)    

% error: Mat::operator(): index out of bounds
% terminate called after throwing an instance of 'std::logic_error'
%   what():  Mat::operator(): index out of bounds


\begin{frame}[fragile]
  \frametitle{Fit the model}
  \footnotesize
  \inr{multinomPois} has similar arguments as \inr{occu} and
  \inr{pcount}. 
\begin{knitrout}\tiny
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{fm} \hlkwb{<-} \hlkwd{multinomPois}\hlstd{(}\hlopt{~}\hlstd{streamDepth} \hlopt{~}\hlstd{streamDepth, umf)}
\hlstd{fm}
\end{alltt}
\begin{verbatim}
## 
## Call:
## multinomPois(formula = ~streamDepth ~ streamDepth, data = umf)
## 
## Abundance:
##             Estimate     SE    z  P(>|z|)
## (Intercept)    0.853 0.0904 9.43 4.04e-21
## streamDepth    0.391 0.1269 3.08 2.09e-03
## 
## Detection:
##             Estimate    SE      z  P(>|z|)
## (Intercept)    0.198 0.205  0.968 3.33e-01
## streamDepth   -1.002 0.217 -4.623 3.78e-06
## 
## AIC: 590.9196
\end{verbatim}
\end{kframe}
\end{knitrout}
\pause
\vfill
Compare to actual parameter values:
\vspace{-6pt}
\begin{knitrout}\tiny
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlkwd{c}\hlstd{(}\hlkwc{beta0}\hlstd{=beta0,} \hlkwc{beta1}\hlstd{=beta1);} \hlkwd{c}\hlstd{(}\hlkwc{alpha0}\hlstd{=alpha0,} \hlkwc{alpha1}\hlstd{=alpha1)}
\end{alltt}
\begin{verbatim}
## beta0 beta1 
##   1.0   0.5
## alpha0 alpha1 
##      0     -1
\end{verbatim}
\end{kframe}
\end{knitrout}
\end{frame}





\begin{frame}[fragile]
  \frametitle{\normalsize Empirical Bayes -- Site-level abundance}
\begin{knitrout}\scriptsize
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{re} \hlkwb{<-} \hlkwd{ranef}\hlstd{(fm,} \hlkwc{K}\hlstd{=}\hlnum{15}\hlstd{)}
\hlkwd{plot}\hlstd{(re,} \hlkwc{layout}\hlstd{=}\hlkwd{c}\hlstd{(}\hlnum{4}\hlstd{,}\hlnum{3}\hlstd{),} \hlkwc{subset}\hlstd{=site}\hlopt{%in%}\hlnum{1}\hlopt{:}\hlnum{12}\hlstd{,} \hlkwc{xlim}\hlstd{=}\hlkwd{c}\hlstd{(}\hlopt{-}\hlnum{1}\hlstd{,} \hlnum{11}\hlstd{),} \hlkwc{lwd}\hlstd{=}\hlnum{5}\hlstd{)}
\end{alltt}
\end{kframe}

{\centering \includegraphics[width=0.8\linewidth]{figure/ranef-1} 

}



\end{knitrout}
\end{frame}





\begin{frame}[fragile]
  \frametitle{Total abundance (in surveyed region)}
\begin{knitrout}\scriptsize
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{N.total.post} \hlkwb{<-} \hlkwd{predict}\hlstd{(re,} \hlkwc{func}\hlstd{=sum,} \hlkwc{nsim}\hlstd{=}\hlnum{1000}\hlstd{)}
\hlkwd{hist}\hlstd{(N.total.post,} \hlkwc{freq}\hlstd{=}\hlnum{FALSE}\hlstd{,} \hlkwc{main}\hlstd{=}\hlstr{""}\hlstd{,} \hlkwc{xlab}\hlstd{=}\hlstr{"N total"}\hlstd{,} \hlkwc{ylab}\hlstd{=}\hlstr{"Probability"}\hlstd{)}
\end{alltt}
\end{kframe}

{\centering \includegraphics[width=0.6\linewidth]{figure/Ntotal-1} 

}



\end{knitrout}
\end{frame}






\begin{frame}[fragile]
  \frametitle{Prediction in `unmarked'}
  \small
  Create \texttt{data.frame} with prediction covariates. 
  \vspace{-6pt}
\begin{knitrout}\footnotesize
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{pred.data} \hlkwb{<-} \hlkwd{data.frame}\hlstd{(}\hlkwc{streamDepth}\hlstd{=}\hlkwd{seq}\hlstd{(}\hlopt{-}\hlnum{3}\hlstd{,} \hlnum{3}\hlstd{,} \hlkwc{length}\hlstd{=}\hlnum{20}\hlstd{))}
\end{alltt}
\end{kframe}
\end{knitrout}
\pause
\vfill
Get predictions of $\lambda$ for each row of prediction data.
  \vspace{-6pt}
\begin{knitrout}\footnotesize
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{lambda.pred} \hlkwb{<-} \hlkwd{predict}\hlstd{(fm,} \hlkwc{newdata}\hlstd{=pred.data,}
                       \hlkwc{type}\hlstd{=}\hlstr{'state'}\hlstd{,} \hlkwc{append}\hlstd{=}\hlnum{TRUE}\hlstd{)}
\end{alltt}
\end{kframe}
\end{knitrout}
\pause
\vfill
  View $\lambda$ predictions
  \vspace{-6pt}
\begin{knitrout}\footnotesize
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlkwd{print}\hlstd{(}\hlkwd{head}\hlstd{(lambda.pred),} \hlkwc{digits}\hlstd{=}\hlnum{2}\hlstd{)}
\end{alltt}
\begin{verbatim}
##   Predicted   SE lower upper streamDepth
## 1      0.73 0.27  0.36   1.5        -3.0
## 2      0.82 0.27  0.43   1.6        -2.7
## 3      0.93 0.27  0.53   1.6        -2.4
## 4      1.05 0.26  0.64   1.7        -2.1
## 5      1.19 0.25  0.78   1.8        -1.7
## 6      1.35 0.24  0.95   1.9        -1.4
\end{verbatim}
\end{kframe}
\end{knitrout}
\end{frame}





\begin{frame}[fragile]
  \frametitle{Prediction in `unmarked'}
\begin{knitrout}\tiny
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlkwd{plot}\hlstd{(Predicted} \hlopt{~} \hlstd{streamDepth, lambda.pred,} \hlkwc{ylab}\hlstd{=}\hlstr{"Expected value of abundance"}\hlstd{,}
     \hlkwc{ylim}\hlstd{=}\hlkwd{c}\hlstd{(}\hlnum{0}\hlstd{,}\hlnum{30}\hlstd{),} \hlkwc{xlab}\hlstd{=}\hlstr{"Stream depth"}\hlstd{,} \hlkwc{type}\hlstd{=}\hlstr{"l"}\hlstd{)}
\hlkwd{lines}\hlstd{(lower} \hlopt{~} \hlstd{streamDepth, lambda.pred,} \hlkwc{col}\hlstd{=}\hlstr{"grey"}\hlstd{)}
\hlkwd{lines}\hlstd{(upper} \hlopt{~} \hlstd{streamDepth, lambda.pred,} \hlkwc{col}\hlstd{=}\hlstr{"grey"}\hlstd{)}
\hlkwd{points}\hlstd{(}\hlkwd{rowSums}\hlstd{(y2)}\hlopt{~}\hlstd{streamDepth)}
\hlkwd{lines}\hlstd{(}\hlkwd{lowess}\hlstd{(}\hlkwd{rowSums}\hlstd{(y2)}\hlopt{~}\hlstd{streamDepth),} \hlkwc{col}\hlstd{=}\hlstr{"blue"}\hlstd{)}  \hlcom{## Loess line for fun (it's way off)}
\end{alltt}
\end{kframe}

{\centering \includegraphics[width=0.8\linewidth]{figure/pred-lam2-1} 

}



\end{knitrout}
\end{frame}







\begin{frame}[fragile]
  \frametitle{In-class exercise}
  % \small
  % \begin{enumerate}
  %   \item Predict
  %   \end{enumerate}
  %   \centering
%  \large
  Do the following using the fitted removal model above:
  \begin{enumerate}
    \normalsize
    \item Predict $p$ when \verb+streamDepth=-1+
    \item Compute $\pi_1, \pi_2, \pi_3, \pi_4$
  \end{enumerate}
\end{frame}


\subsection{Bayesian methods}


\begin{frame}
  \frametitle{Outline}
  \Large
  \tableofcontents[currentsection,currentsubsection]
\end{frame}


\begin{frame}
  \frametitle{Bayesian multinomial $N$-mixture models}
  There are several equivalent formulations of the multinomial that we
  can exploit to fit the model in JAGS.
  \begin{itemize}
    \item Conditional-on-$N$, missing $y_{iK}$
    \item Conditional-on-$N$, conditional on $n_i=\sum_{k=1}^{K-1} y_{i,k}$
    \item Conditional-on-$N$, sequential binomial
    \item Marginalized $N$
  \end{itemize}
  
\end{frame}




\begin{frame}[fragile]
  \frametitle{Conditional-on-$N$, missing $y_k$}
\end{frame}





\begin{frame}[fragile]
  \frametitle{Conditional-on-$N$, missing $y_k$}
  \footnotesize
  Under this formulation, we view the final multinomial cell
  (corresponding to individuals not detected) as missing data. \\
  \pause
  Unfortunately, this won't work in JAGS because it doesn't allow
  missing values in multinomial outcomes.
  \pause
\begin{knitrout}\tiny
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{verbatim}
## model {
## 
## lambda.intercept ~ dunif(0, 5)
## beta0 <- log(lambda.intercept)
## beta1 ~ dnorm(0, 0.5)
## 
## alpha0 ~ dnorm(0, 0.5)  
## alpha1 ~ dnorm(0, 0.5)
## 
## for(i in 1:nSites) {
##   log(lambda[i]) <- beta0 + beta1*streamDepth[i]
##   N[i] ~ dpois(lambda[i])         # Latent local abundance
##   logit(p[i]) <- alpha0 + alpha1*streamDepth[i]
##   pi[i,1] <- p[i]            ## Pr(first captured in first pass)
##   pi[i,2] <- (1-p[i])*p[i]   ## Pr(first captured in second pass)
##   pi[i,3] <- (1-p[i])^2*p[i] ## Pr(first captured in third pass)
##   pi[i,4] <- (1-p[i])^3      ## Pr(not captured)
##   y[i,1:4] ~ dmulti(pi[i,1:4], N[i])
## }
## 
## totalAbundance <- sum(N[1:nSites])
## 
## }
\end{verbatim}
\end{kframe}
\end{knitrout}

\end{frame}





\begin{frame}[fragile]
  \frametitle{\normalsize Conditional-on-$N$ and $n_i=\sum_{k=1}^{K-1} y_{i,k}$}
  Rather than treating the final multinomial cell as missing data:
  \[
    \{y_{i,1}, \dots, y_{i,K-1}, \mathtt{NA}\} \sim
    \mathrm{Multinomial}(N_i, \{\pi_{i,1}, \dots, \pi_{i,K-1}, \pi_{i,K}\})
  \]
  \pause
  \vfill
  We can break the problem down into two steps by conditioning on
  $n_i$, the number captured:
  \small
  \begin{gather*}
    n_i \sim \mathrm{Bin}(N_i, 1-\pi_K) \\
    \{y_{i,1}, \dots, y_{i,K-1}\} \sim \mathrm{Multinomial}(n_i,
    \{\pi_{i,1}, \dots, \pi_{i,K-1}\}/(1-\pi_K))
  \end{gather*}
\end{frame}



\begin{frame}[fragile]
  \frametitle{\normalsize Conditional-on-$N$ and $n_i=\sum_{k=1}^{K-1} y_{i,k}$}
\begin{knitrout}\scriptsize
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{verbatim}
## model {
## 
## lambda.intercept ~ dunif(0, 5)
## beta0 <- log(lambda.intercept)
## beta1 ~ dnorm(0, 0.5)
## 
## alpha0 ~ dnorm(0, 0.5)  
## alpha1 ~ dnorm(0, 0.5)
## 
## for(i in 1:nSites) {
##   log(lambda[i]) <- beta0 + beta1*streamDepth[i]
##   N[i] ~ dpois(lambda[i])         # Latent local abundance
##   logit(p[i]) <- alpha0 + alpha1*streamDepth[i]
##   pi[i,1] <- p[i]
##   pi[i,2] <- (1-p[i])*p[i]
##   pi[i,3] <- (1-p[i])^2*p[i]
##   pi[i,4] <- (1-p[i])^3         ## Pr(not captured)
##   n[i] ~ dbin(1-pi[i,4], N[i])  ## nCaptured
##   y[i,1:3] ~ dmulti(pi[i,1:3]/sum(pi[i,1:3]), n[i])
## }
## 
## totalAbundance <- sum(N[1:nSites])
## 
## }
\end{verbatim}
\end{kframe}
\end{knitrout}
\end{frame}





\begin{frame}[fragile]
  \frametitle{Data, inits, and parameters}
  Put data in a named list
  \vspace{-12pt}
\begin{knitrout}\small
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{jags.data.rem2} \hlkwb{<-} \hlkwd{list}\hlstd{(}\hlkwc{y}\hlstd{=y2,} \hlkwc{n}\hlstd{=}\hlkwd{rowSums}\hlstd{(y2),}
                       \hlkwc{streamDepth}\hlstd{=streamDepth,}
                       \hlkwc{nSites}\hlstd{=nSites,} \hlkwc{nPasses}\hlstd{=nPasses)}
\end{alltt}
\end{kframe}
\end{knitrout}
\pause
\vfill
  Initial values
  \vspace{-12pt}
\begin{knitrout}\small
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{jags.inits.rem} \hlkwb{<-} \hlkwa{function}\hlstd{() \{}
    \hlkwd{list}\hlstd{(}\hlkwc{lambda.intercept}\hlstd{=}\hlkwd{runif}\hlstd{(}\hlnum{1}\hlstd{),} \hlkwc{alpha0}\hlstd{=}\hlkwd{rnorm}\hlstd{(}\hlnum{1}\hlstd{),}
         \hlkwc{N}\hlstd{=}\hlkwd{rowSums}\hlstd{(y2)}\hlopt{+}\hlnum{1}\hlstd{)}
\hlstd{\}}
\end{alltt}
\end{kframe}
\end{knitrout}
\pause
\vfill
  Parameters to monitor
  \vspace{-12pt}
\begin{knitrout}\small
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{jags.pars.rem} \hlkwb{<-} \hlkwd{c}\hlstd{(}\hlstr{"beta0"}\hlstd{,} \hlstr{"beta1"}\hlstd{,}
                   \hlstr{"alpha0"}\hlstd{,} \hlstr{"alpha1"}\hlstd{,} \hlstr{"totalAbundance"}\hlstd{)}
\end{alltt}
\end{kframe}
\end{knitrout}
\end{frame}





\begin{frame}[fragile]
  \frametitle{MCMC}
  \small
\begin{knitrout}\scriptsize
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlkwd{library}\hlstd{(jagsUI)}
\hlstd{jags.post.rem2} \hlkwb{<-} \hlkwd{jags.basic}\hlstd{(}\hlkwc{data}\hlstd{=jags.data.rem2,} \hlkwc{inits}\hlstd{=jags.inits.rem,}
                             \hlkwc{parameters.to.save}\hlstd{=jags.pars.rem,}
                             \hlkwc{model.file}\hlstd{=}\hlstr{"removal-mod2.jag"}\hlstd{,}
                             \hlkwc{n.chains}\hlstd{=}\hlnum{3}\hlstd{,} \hlkwc{n.adapt}\hlstd{=}\hlnum{100}\hlstd{,} \hlkwc{n.burnin}\hlstd{=}\hlnum{0}\hlstd{,}
                             \hlkwc{n.iter}\hlstd{=}\hlnum{2000}\hlstd{,} \hlkwc{parallel}\hlstd{=}\hlnum{TRUE}\hlstd{)}
\end{alltt}
\end{kframe}
\end{knitrout}
\end{frame}



\begin{frame}[fragile]
  \frametitle{Summarize output}
\begin{knitrout}\tiny
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlkwd{summary}\hlstd{(jags.post.rem2[,jags.pars.rem])}
\end{alltt}
\begin{verbatim}
## 
## Iterations = 1:2000
## Thinning interval = 1 
## Number of chains = 3 
## Sample size per chain = 2000 
## 
## 1. Empirical mean and standard deviation for each variable,
##    plus standard error of the mean:
## 
##                    Mean       SD Naive SE Time-series SE
## beta0            0.8647  0.09246 0.001194       0.004077
## beta1            0.3956  0.12739 0.001645       0.007282
## alpha0           0.1574  0.20162 0.002603       0.008717
## alpha1          -0.9861  0.22312 0.002880       0.010963
## totalAbundance 268.9377 30.61393 0.395224       2.053057
## 
## 2. Quantiles for each variable:
## 
##                    2.5%       25%      50%      75%    97.5%
## beta0            0.6899   0.80196   0.8630   0.9231   1.0471
## beta1            0.1592   0.30854   0.3877   0.4793   0.6704
## alpha0          -0.2737   0.03012   0.1623   0.2950   0.5345
## alpha1          -1.4213  -1.13647  -0.9903  -0.8385  -0.5475
## totalAbundance 227.0000 248.00000 263.0000 284.0000 345.0000
\end{verbatim}
\end{kframe}
\end{knitrout}
\end{frame}




\begin{frame}[fragile]
  \frametitle{Traceplots and density plots}
\begin{knitrout}\footnotesize
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlkwd{plot}\hlstd{(jags.post.rem2[,jags.pars.rem[}\hlnum{1}\hlopt{:}\hlnum{3}\hlstd{]])}
\end{alltt}
\end{kframe}

{\centering \includegraphics[width=0.7\textwidth]{figure/bugs-plot1-rem2-1} 

}



\end{knitrout}
\end{frame}



\begin{frame}[fragile]
  \frametitle{Traceplots and density plots}
\begin{knitrout}\footnotesize
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlkwd{plot}\hlstd{(jags.post.rem2[,jags.pars.rem[}\hlnum{4}\hlopt{:}\hlnum{5}\hlstd{]])}
\end{alltt}
\end{kframe}

{\centering \includegraphics[width=0.7\textwidth]{figure/bugs-plot2-rem2-1} 

}



\end{knitrout}
\end{frame}




\begin{frame}[fragile]
  \frametitle{\normalsize Conditional-on-$N$, sequential binomial}
\begin{knitrout}\scriptsize
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{verbatim}
## model {
## 
## lambda.intercept ~ dunif(0, 5)
## beta0 <- log(lambda.intercept)
## beta1 ~ dnorm(0, 0.5)
## 
## alpha0 ~ dnorm(0, 0.5)  
## alpha1 ~ dnorm(0, 0.5)
## 
## for(i in 1:nSites) {
##   log(lambda[i]) <- beta0 + beta1*streamDepth[i]
##   N[i] ~ dpois(lambda[i])         # Latent local abundance
##   logit(p[i]) <- alpha0 + alpha1*streamDepth[i]
##   y[i,1] ~ dbin(p[i], N[i])
##   y[i,2] ~ dbin(p[i], N[i]-y[i,1])
##   y[i,3] ~ dbin(p[i], N[i]-y[i,1]-y[i,2])
## }
## 
## totalAbundance <- sum(N[1:nSites])
## 
## }
\end{verbatim}
\end{kframe}
\end{knitrout}
\end{frame}





\begin{frame}[fragile]
  \frametitle{Data, inits, and parameters}
  Put data in a named list
  \vspace{-12pt}
\begin{knitrout}\small
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{jags.data.rem3} \hlkwb{<-} \hlkwd{list}\hlstd{(}\hlkwc{y}\hlstd{=y2,} \hlkwc{streamDepth}\hlstd{=streamDepth,}
                       \hlkwc{nSites}\hlstd{=nSites)}
\end{alltt}
\end{kframe}
\end{knitrout}
\vfill
  Do MCMC
\begin{knitrout}\scriptsize
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{jags.post.rem3} \hlkwb{<-} \hlkwd{jags.basic}\hlstd{(}\hlkwc{data}\hlstd{=jags.data.rem3,} \hlkwc{inits}\hlstd{=jags.inits.rem,}
                             \hlkwc{parameters.to.save}\hlstd{=jags.pars.rem,}
                             \hlkwc{model.file}\hlstd{=}\hlstr{"removal-mod3.jag"}\hlstd{,}
                             \hlkwc{n.chains}\hlstd{=}\hlnum{3}\hlstd{,} \hlkwc{n.adapt}\hlstd{=}\hlnum{100}\hlstd{,} \hlkwc{n.burnin}\hlstd{=}\hlnum{0}\hlstd{,}
                             \hlkwc{n.iter}\hlstd{=}\hlnum{2000}\hlstd{,} \hlkwc{parallel}\hlstd{=}\hlnum{TRUE}\hlstd{)}
\end{alltt}
\end{kframe}
\end{knitrout}
\end{frame}





\begin{frame}[fragile]
  \frametitle{Summarize output}
\begin{knitrout}\tiny
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlkwd{summary}\hlstd{(jags.post.rem3[,jags.pars.rem])}
\end{alltt}
\begin{verbatim}
## 
## Iterations = 1:2000
## Thinning interval = 1 
## Number of chains = 3 
## Sample size per chain = 2000 
## 
## 1. Empirical mean and standard deviation for each variable,
##    plus standard error of the mean:
## 
##                    Mean       SD Naive SE Time-series SE
## beta0            0.8696  0.09284 0.001199       0.009818
## beta1            0.4129  0.12969 0.001674       0.019315
## alpha0           0.1792  0.20587 0.002658       0.032024
## alpha1          -1.0349  0.22008 0.002841       0.041603
## totalAbundance 272.2152 32.03041 0.413511       6.413807
## 
## 2. Quantiles for each variable:
## 
##                    2.5%       25%      50%      75%    97.5%
## beta0            0.6927   0.80653   0.8668   0.9311   1.0556
## beta1            0.1755   0.31992   0.4081   0.5037   0.6708
## alpha0          -0.2679   0.03903   0.1843   0.3310   0.5563
## alpha1          -1.4333  -1.20533  -1.0248  -0.8791  -0.6103
## totalAbundance 227.0000 247.00000 266.0000 292.0000 347.0000
\end{verbatim}
\end{kframe}
\end{knitrout}
\end{frame}




\begin{frame}[fragile]
  \frametitle{Traceplots and density plots}
\begin{knitrout}\footnotesize
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlkwd{plot}\hlstd{(jags.post.rem3[,jags.pars.rem[}\hlnum{1}\hlopt{:}\hlnum{3}\hlstd{]])}
\end{alltt}
\end{kframe}

{\centering \includegraphics[width=0.7\textwidth]{figure/bugs-plot1-rem3-1} 

}



\end{knitrout}
\end{frame}



\begin{frame}[fragile]
  \frametitle{Traceplots and density plots}
\begin{knitrout}\footnotesize
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlkwd{plot}\hlstd{(jags.post.rem3[,jags.pars.rem[}\hlnum{4}\hlopt{:}\hlnum{5}\hlstd{]])}
\end{alltt}
\end{kframe}

{\centering \includegraphics[width=0.7\textwidth]{figure/bugs-plot2-rem3-1} 

}



\end{knitrout}
\end{frame}







\begin{frame}[fragile]
  \frametitle{Marginalized $N$}
\begin{knitrout}\scriptsize
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{verbatim}
## model {
## 
## lambda.intercept ~ dunif(0, 5)
## beta0 <- log(lambda.intercept)
## beta1 ~ dnorm(0, 0.5)
## 
## alpha0 ~ dnorm(0, 0.5)  
## alpha1 ~ dnorm(0, 0.5)
## 
## for(i in 1:nSites) {
##   log(lambda[i]) <- beta0 + beta1*streamDepth[i]
##   logit(p[i]) <- alpha0 + alpha1*streamDepth[i]
##   pi[i,1] <- p[i]
##   pi[i,2] <- (1-p[i])*p[i]
##   pi[i,3] <- (1-p[i])^2*p[i]
##   y[i,1] ~ dpois(lambda[i]*pi[i,1])
##   y[i,2] ~ dpois(lambda[i]*pi[i,2])
##   y[i,3] ~ dpois(lambda[i]*pi[i,3])
## }
## 
## # totalAbundance <- sum(N[1:nSites])
## 
## }
\end{verbatim}
\end{kframe}
\end{knitrout}
\end{frame}





\begin{frame}[fragile]
  \frametitle{Data, inits, and parameters}
  Put data in a named list
  \vspace{-12pt}
\begin{knitrout}\small
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{jags.data.rem4} \hlkwb{<-} \hlkwd{list}\hlstd{(}\hlkwc{y}\hlstd{=y2,} \hlkwc{streamDepth}\hlstd{=streamDepth,}
                       \hlkwc{nSites}\hlstd{=nSites)}
\end{alltt}
\end{kframe}
\end{knitrout}
\vfill
  Do MCMC
\begin{knitrout}\scriptsize
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{jags.post.rem4} \hlkwb{<-} \hlkwd{jags.basic}\hlstd{(}\hlkwc{data}\hlstd{=jags.data.rem4,} \hlkwc{inits}\hlstd{=jags.inits.rem,}
                             \hlkwc{parameters.to.save}\hlstd{=jags.pars.rem,}
                             \hlkwc{model.file}\hlstd{=}\hlstr{"removal-mod4.jag"}\hlstd{,}
                             \hlkwc{n.chains}\hlstd{=}\hlnum{3}\hlstd{,} \hlkwc{n.adapt}\hlstd{=}\hlnum{100}\hlstd{,} \hlkwc{n.burnin}\hlstd{=}\hlnum{0}\hlstd{,}
                             \hlkwc{n.iter}\hlstd{=}\hlnum{2000}\hlstd{,} \hlkwc{parallel}\hlstd{=}\hlnum{TRUE}\hlstd{)}
\end{alltt}
\end{kframe}
\end{knitrout}
\end{frame}





\begin{frame}[fragile]
  \frametitle{Summarize output}
\begin{knitrout}\tiny
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlkwd{summary}\hlstd{(jags.post.rem4[,jags.pars.rem[}\hlnum{1}\hlopt{:}\hlnum{4}\hlstd{]])}
\end{alltt}
\begin{verbatim}
## 
## Iterations = 1:2000
## Thinning interval = 1 
## Number of chains = 3 
## Sample size per chain = 2000 
## 
## 1. Empirical mean and standard deviation for each variable,
##    plus standard error of the mean:
## 
##           Mean      SD Naive SE Time-series SE
## beta0   0.8683 0.09378 0.001211       0.002587
## beta1   0.4044 0.13100 0.001691       0.004332
## alpha0  0.1525 0.21811 0.002816       0.006146
## alpha1 -0.9959 0.22006 0.002841       0.006726
## 
## 2. Quantiles for each variable:
## 
##           2.5%      25%     50%     75%   97.5%
## beta0   0.6966  0.80419  0.8639  0.9299  1.0641
## beta1   0.1690  0.31290  0.3957  0.4846  0.6910
## alpha0 -0.3079  0.01434  0.1563  0.3025  0.5564
## alpha1 -1.4316 -1.14021 -0.9992 -0.8514 -0.5545
\end{verbatim}
\end{kframe}
\end{knitrout}
\end{frame}




\begin{frame}[fragile]
  \frametitle{Traceplots and density plots}
\begin{knitrout}\footnotesize
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlkwd{plot}\hlstd{(jags.post.rem3[,jags.pars.rem[}\hlnum{1}\hlopt{:}\hlnum{4}\hlstd{]])}
\end{alltt}
\end{kframe}

{\centering \includegraphics[width=0.7\textwidth]{figure/bugs-plot1-rem4-1} 

}



\end{knitrout}
\end{frame}





\section{Double observer sampling}

\begin{frame}
  \frametitle{Outline}
  \Large
  \tableofcontents[currentsection,currentsubsection]
\end{frame}




\begin{frame}
  \frametitle{Double observer sampling (independent)}
  \small
  Two observers sample together, working independently. \\
  \pause
  \vfill
  After each survey, they compare notes and figure out which
  individual were detected by observer A only, B only, or by both. \\
  \pause
  \vfill
  Definitions
  \begin{itemize}
    \setlength\itemsep{1pt}
    \item $y_{i1}$ -- number of individuals detected only by observer A
    \item $y_{i2}$ -- number of individuals detected only by observer B
    \item $y_{i3}$ -- number of individuals detected by observers A and B
    \item $p_1$ -- probability that observer A detects an individual 
    \item $p_2$ -- probability that observer B detects an individual 
  \end{itemize}
  \pause \vfill
  \footnotesize
  \begin{tabular}{lc}
    \hline
    \centering
    Description & Multinomial cell probability \\
    \hline
    Pr(detected by observer A but not B) & $\pi_1 = p_1(1-p_2)$ \\
    Pr(detected by observer B but not A) & $\pi_2 = (1-p_1)p_2$ \\
    Pr(detected by observers A and B) & $\pi_3 = p_1p_2$ \\
    Pr(not detected) & $\pi_4 = (1-p_1)(1-p_2)$ \\
    \hline
  \end{tabular}
\end{frame}





\begin{frame}
  \frametitle{Double observer sampling (dependent)}
  \small
  Two observers sample at the same time, but observer B only records
  what observer A missed. \\
  \pause
  \vfill
  Often used in aerial waterfowl surveys with two pilots. \\
  \pause
  \vfill
  Definitions
  \begin{itemize}
    \setlength\itemsep{1pt}
    \item $y_{i1}$ -- number of individuals detected by observer A
    \item $y_{i2}$ -- number of individuals missed by A but
      detected by B
    \item $p_1$ -- probability that observer A detects an individual 
    \item $p_2$ -- probability that observer B detects an individual 
  \end{itemize}
  \pause \vfill
  \footnotesize
  \begin{tabular}{lc}
    \hline
    \centering
    Description & Multinomial cell probability \\
    \hline
    Pr(detected by observer A) & $\pi_1 = p_1$ \\
    Pr(detected by observer B but not A) & $\pi_2 = (1-p_1)p_2$ \\
    Pr(not detected) & $\pi_3 = (1-p_1)(1-p_2)$ \\
    \hline
  \end{tabular}
\end{frame}

\subsection{Likelihood-based methods}


\subsection{Bayesian methods}



\begin{frame}[plain]
  \frametitle{Outline}
  \Large
  \tableofcontents[currentsection,currentsubsection]
\end{frame}







% \begin{frame}[fragile]
%   \frametitle{Data, inits, and parameters}
%   Put data in a named list
%   \vspace{-12pt}
% <<bugs-data,size='small'>>=
% jags.data <- list(y=y2, temp=temp,
%                   forestMixed=forestMixed,
%                   forestPine=forestPine,
%                   nSites=nSites, nOccasions=nVisits)
% @
% \pause
% \vfill
%   Initial values
%   \vspace{-12pt}
% <<bugs-inits,size='small'>>=
% jags.inits <- function() {
%     list(beta0=rnorm(1), alpha0=rnorm(1), N=maxCounts)
% }
% @ 
% \pause
% \vfill
%   Parameters to monitor
%   \vspace{-12pt}
% <<bugs-pars,size='small'>>=
% jags.pars <- c("beta0", "beta1", "beta2",
%                "alpha0", "alpha1", "totalAbundance")
% @ 
% \end{frame}





% \begin{frame}[fragile]
%   \frametitle{MCMC}
%   \small
% <<bugs-mcmc,size='scriptsize',message=FALSE,cache=TRUE>>=
% library(jagsUI)
% jags.post.samples <- jags.basic(data=jags.data, inits=jags.inits,
%                                 parameters.to.save=c(jags.pars, "N"), ## NOTE "N"!
%                                 model.file="Nmix-model-covs.jag",
%                                 n.chains=3, n.adapt=100, n.burnin=0,
%                                 n.iter=2000, parallel=TRUE)
% @ 
% \end{frame}



% \begin{frame}[fragile]
%   \frametitle{Summarize output}
% <<bugs-sum,size='tiny'>>=
% summary(jags.post.samples[,jags.pars])
% @ 
% \end{frame}


% \begin{frame}[fragile]
%   \frametitle{Local abundance}
% <<localN,out.width='70%',fig.align='center',size='scriptsize'>>=
% plot(jags.post.samples[,paste0("N[", 1:4, "]")])
% @   
% \end{frame}



% \begin{frame}[fragile]
%   \frametitle{Traceplots and density plots}
% <<bugs-plot1,size='footnotesize',out.width="0.7\\textwidth",fig.align='center'>>=
% plot(jags.post.samples[,jags.pars[1:3]])
% @ 
% \end{frame}



% \begin{frame}[fragile]
%   \frametitle{Traceplots and density plots}
% <<bugs-plot2,size='footnotesize',out.width="0.7\\textwidth",fig.align='center'>>=
% plot(jags.post.samples[,jags.pars[4:5]])
% @ 
% \end{frame}




% \begin{frame}[fragile]
%   \frametitle{Bayesian prediction}
%   \small
%   First, extract the $p$ coefficients
%   \vspace{-6pt}
% <<psi-coefs,size='scriptsize'>>=
% p.coef.post <- as.matrix(jags.post.samples[,c("alpha0","alpha1")])
% head(p.coef.post, n=4)
% @
%   \pause
%   \vfill
%   Create prediction matrix, one row for each MCMC iteration.
%   \vspace{-6pt}
% %  Columns represent covariate values. 
% <<p-predmat,size='scriptsize'>>=
% n.iter <- nrow(p.coef.post)
% temp.pred <- seq(-3, 3, length=50)
% p.post.pred <- matrix(NA, nrow=n.iter, ncol=length(temp.pred))
% @   
%   \pause
%   \vfill
%   Predict $p$ for each MCMC iteration.
%   \vspace{-6pt}
% %  using covariate values from \inr{pred.data}. 
% <<psi-pred-bayes,size='scriptsize'>>=
% for(i in 1:n.iter) {
%     p.post.pred[i,] <- plogis(p.coef.post[i,"alpha0"] +
%                               p.coef.post[i,"alpha1"]*temp.pred)
% }
% @ 
% \end{frame}





% \begin{frame}[fragile]
%   \frametitle{Bayesian prediction}
% %  Now with posterior mean and 95\% CI
% <<psi-pred-post-meanCI,size='tiny',fig.align='center',out.width='70%',fig.height=5,echo=-(1),dev='png',cache=TRUE,dpi=200>>=
% par(mai=c(0.9,0.9,0.1,0.1))  
% plot(temp.pred, p.post.pred[1,], type="l", xlab="Temperature (standardized)",
%      ylab="Detection probability", ylim=c(0, 1), col=gray(0.8))
% for(i in seq(1, n.iter, by=10)) {  ## Thin by 10
%     lines(temp.pred, p.post.pred[i,], col=gray(0.8))  }
% pred.post.mean <- colMeans(p.post.pred)
% pred.post.lower <- apply(p.post.pred, 2, quantile, prob=0.025)
% pred.post.upper <- apply(p.post.pred, 2, quantile, prob=0.975)
% lines(temp.pred, pred.post.mean, col="blue")
% lines(temp.pred, pred.post.lower, col="blue", lty=2)
% lines(temp.pred, pred.post.upper, col="blue", lty=2)
% @ 
% \end{frame}







\begin{frame}[plain]
  \frametitle{Outline}
  \Large
  \tableofcontents[currentsection,currentsubsection]
\end{frame}











% \begin{frame}[fragile]
%   \frametitle{Prior prediction}
%   \small
%   Push the prior samples through the model to predict $p$
% <<psi-coefs-prior,size='scriptsize'>>=
% p.coef.prior <- as.matrix(jags.prior.samples[,c("alpha0","alpha1")])
% p.prior.pred <- matrix(NA, nrow=n.iter, ncol=length(temp.pred))
% for(i in 1:n.iter) {
%     p.prior.pred[i,] <- plogis(p.coef.prior[i,"alpha0"] +
%                                p.coef.prior[i,"alpha1"]*temp.pred)
% }
% @ 
% \end{frame}





% \begin{frame}[fragile]
%   \frametitle{Bayesian prediction}
%   Compute prior mean and 95\% CI for $p$ predictions
% <<prior-post-pred-1,size='scriptsize'>>=
% pred.prior.mean <- colMeans(p.prior.pred)
% pred.prior.lower <- apply(p.prior.pred, 2, quantile, prob=0.025)
% pred.prior.upper <- apply(p.prior.pred, 2, quantile, prob=0.975)
% @
%   \pause
%   \vfill
%   Show credible regions using shaded polygons. Include a few prior prediction lines.
% <<prior-post-pred-2,size='scriptsize',fig.height=6,dev='png',dpi=200,fig.show='hide'>>=
% plot(temp.pred, p.post.pred[1,], type="n", xlab="Temperature (standardized)",
%      ylab="Detection probability", ylim=c(0, 1.3), col=gray(0.8))
% polygon(x=c(temp.pred, rev(temp.pred)),
%         y=c(pred.post.lower, rev(pred.post.upper)),
%         col=rgb(0,0,1,0.5), border=NA)                   # Post CI
% polygon(x=c(temp.pred, rev(temp.pred)),
%         y=c(pred.prior.lower, rev(pred.prior.upper)),
%         col=rgb(0,1,0,0.5), border=NA)                   # Prior CI
% for(i in seq(1, n.iter, by=100)) {  ## Thin by 100
%     lines(temp.pred, p.prior.pred[i,], col=gray(0.8))  } # Prior preds
% lines(temp.pred, pred.post.mean, col="blue", lwd=2)
% lines(temp.pred, pred.prior.mean, col="darkgreen", lwd=2)
% legend(-3, 1.3, c("Prior mean", "Prior samples", "Posterior mean"),
%        col=c("darkgreen", "grey", "blue"), lwd=2)
% @ 
% \end{frame}



% \begin{frame}
%   \frametitle{Prior and posterior prediction}
%   \vspace{-3pt}
%   \centering
%   \includegraphics[width=0.9\textwidth]{figure/prior-post-pred-2-1}  \\
% \end{frame}



% \begin{frame}
%   \frametitle{Prior predictive recap}
%   There are two common strategies for specifying priors:
%   \begin{enumerate}
%     \item Use uniform/flat priors to obtain results that will often be
%       similar to likelihood-based methods.
%     \item Use priors that reflect available information.
%   \end{enumerate}
%   \pause
%   \vfill
%   The second approach can be used even if there isn't much prior
%   information available. Priors can allow for the
%   possibility of being ``surprised'' by the data, but without
%   putting most of the prior weight on extreme values. \\
%   \pause
%   \vfill
%   Often, highly diffuse priors on the link scales result in most of the
%   prior weight being on extreme values on the natural scales. \\
%   \pause
%   \vfill
%   Prior predictive checks can be used to assess this possibility, and
%   should be a standard component of Bayesian analysis. \\
% \end{frame}



\section{Assignment}




\begin{frame}[fragile]
  \frametitle{Assignment}
  % \small
  \footnotesize
  Create a self-contained R script or Rmarkdown file
  to do the following:
  \vfill
  \begin{enumerate}
%    \small
    \footnotesize
    \item Using the simulated data, compare the prior and posterior
      predictive distributions of $\lambda$ for each of the 3 forest
      types. 
    \item Change the priors for $\alpha_0$ and $\alpha_1$ from
      \inr{dnorm(0,0.5)} to \inr{dnorm(0, 0.001)} and then compare the
      prior and posterior predictions of $p$ as a function of
      temperature. Make the same graph as we made above. How
      sensitive is the posterior to the prior?
    \item Fit a binomial $N$-mixture model to the Canada warbler data
      using `unmarked'. The data include: 
      \begin{itemize}
        \footnotesize
        \item Response: \texttt{cawa1, cawa2, cawa3, cawa4}
        \item Site covs: \texttt{Elevation, Wind, Noise}
      \end{itemize}
    \item Graph the predictions of $\lambda$ over the 
      elevation range, along with 95\% CIs.
  \end{enumerate}
  \vfill
  Upload your {\tt .R} or {\tt .Rmd} file to ELC before Monday. 
\end{frame}





\end{document}

