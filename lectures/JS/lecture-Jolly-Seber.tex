\documentclass[color=usenames,dvipsnames]{beamer}\usepackage[]{graphicx}\usepackage[]{xcolor}
% maxwidth is the original width if it is less than linewidth
% otherwise use linewidth (to make sure the graphics do not exceed the margin)
\makeatletter
\def\maxwidth{ %
  \ifdim\Gin@nat@width>\linewidth
    \linewidth
  \else
    \Gin@nat@width
  \fi
}
\makeatother

\definecolor{fgcolor}{rgb}{0, 0, 0}
\newcommand{\hlnum}[1]{\textcolor[rgb]{0.69,0.494,0}{#1}}%
\newcommand{\hlsng}[1]{\textcolor[rgb]{0.749,0.012,0.012}{#1}}%
\newcommand{\hlcom}[1]{\textcolor[rgb]{0.514,0.506,0.514}{\textit{#1}}}%
\newcommand{\hlopt}[1]{\textcolor[rgb]{0,0,0}{#1}}%
\newcommand{\hldef}[1]{\textcolor[rgb]{0,0,0}{#1}}%
\newcommand{\hlkwa}[1]{\textcolor[rgb]{0,0,0}{\textbf{#1}}}%
\newcommand{\hlkwb}[1]{\textcolor[rgb]{0,0.341,0.682}{#1}}%
\newcommand{\hlkwc}[1]{\textcolor[rgb]{0,0,0}{\textbf{#1}}}%
\newcommand{\hlkwd}[1]{\textcolor[rgb]{0.004,0.004,0.506}{#1}}%
\let\hlipl\hlkwb

\usepackage{framed}
\makeatletter
\newenvironment{kframe}{%
 \def\at@end@of@kframe{}%
 \ifinner\ifhmode%
  \def\at@end@of@kframe{\end{minipage}}%
  \begin{minipage}{\columnwidth}%
 \fi\fi%
 \def\FrameCommand##1{\hskip\@totalleftmargin \hskip-\fboxsep
 \colorbox{shadecolor}{##1}\hskip-\fboxsep
     % There is no \\@totalrightmargin, so:
     \hskip-\linewidth \hskip-\@totalleftmargin \hskip\columnwidth}%
 \MakeFramed {\advance\hsize-\width
   \@totalleftmargin\z@ \linewidth\hsize
   \@setminipage}}%
 {\par\unskip\endMakeFramed%
 \at@end@of@kframe}
\makeatother

\definecolor{shadecolor}{rgb}{.97, .97, .97}
\definecolor{messagecolor}{rgb}{0, 0, 0}
\definecolor{warningcolor}{rgb}{1, 0, 1}
\definecolor{errorcolor}{rgb}{1, 0, 0}
\newenvironment{knitrout}{}{} % an empty environment to be redefined in TeX

\let\hlstd\hldef
\let\hlstr\hlsng
\usepackage{alltt}
%\documentclass[color=usenames,dvipsnames,handout]{beamer}

\usepackage[roman]{../lectures}
%\usepackage[sans]{../lectures}

\mode<handout>{
  \usetheme{default}
%  \setbeamercolor{background canvas}{bg=black!5}
%  \pgfpagesuselayout{4 on 1}[letterpaper,landscape,border shrink=2.5mm]
%  \pgfpagesuselayout{2 on 1}[letterpaper,border shrink=10mm]
}


% Compile and open PDF






%% New command for inline code that isn't to be evaluated
\definecolor{inlinecolor}{rgb}{0.878, 0.918, 0.933}
\newcommand{\inr}[1]{\colorbox{inlinecolor}{\texttt{#1}}}
\IfFileExists{upquote.sty}{\usepackage{upquote}}{}
\begin{document}



\begin{frame}[plain]
  \centering
  \LARGE
  % Lecture 17 \\
  Spatio-temporal variation in %\\
  survival, \\ recruitment, movement and abundance %with the \\
%  Jolly-Seber model \\
  \vfill
  \large
  WILD(FISH) 8390 \\
%%  Estimation of Fish and Wildlife Population Parameters \\
  Inference for Models of Fish and Wildlife Population Dynamics \\
  \vfill
  Richard Chandler \\
  University of Georgia \\
\end{frame}




%\section{Intro}



\begin{frame}[plain]
  \frametitle{Topics}
  \Large
  \only<1>{\tableofcontents}%[hideallsubsections]}
%  \only<2 | handout:0>{\tableofcontents[currentsection]}%,hideallsubsections]}
\end{frame}




\section{Intro}






\begin{frame}
  \frametitle{Overview}
%  \large
  {Jolly-Seber model}
  \begin{itemize}
    \normalsize
    \item Extend CJS model to allow for recruitment
    \item We no longer ``condition on first capture''
    \item Typically, we use the robust design
  \end{itemize}
  \pause \vfill
  Bigger picture
  \begin{itemize}
    \normalsize
    \item<2-> We're interested in modeling population dynamics
    \item<3-> This framework allows for inference on \alert{all} of the
      key processes 
    \item<4-> Potential to model spatial, temporal, and individual-level
      variation vital rates
    \item<5-> Density-dependence and biotic interactions could be
      modeled too
  \end{itemize}
\end{frame}




% \begin{frame}
%   \frametitle{Spatial population dynamics}
%   \small
%   {Initial abundance at location $s$}
%   \[
%     N_{s,1} \sim \mbox{Poisson}(\lambda_{s,1})
%   \]
%   \pause \vfill
%   Survival and recruitment (local population dynamics)
%   \begin{gather*}
%     S_{s,t} \sim \mbox{Binomial}(N_{s,t-1}, \phi) \\
%     R_{s,t} \sim \mbox{Poisson}(N_{s,t-1} \gamma)
%   \end{gather*}
%   \pause \vfill
%   % {Recruitment}
%   % \[
%   %   R_{s,t} \sim \mbox{Poisson}(N_{s,t-1} \gamma)
%   % \]
%   % \pause \vfill
%   Movement (emigration and immigration)
%   \begin{gather*}
%     E_{s,t} \sim \mathrm{Binomial}(S_{s,t}+R_{s,t}, \kappa) \\
%     \{M_{1,s,t}, \dots, M_{J,s,t}\} \sim \mathrm{Multinomial}(E_{s,t}, \{\pi_1, \dots, \pi_J\}) \\
%     I_{s,t} = \sum_{j=1}^J M_{j,s,t}
%   \end{gather*}
%   % \vfill
%   % Immigration
%   % \[
%   % \]
%   % \vfill
%   \pause
%   {Abundance}
%   \[
%     N_{s,t} = S_{s,t} + R_{s,t} - E_{s,t} + I_{s,t}
%   \]
% \end{frame}



%% \begin{frame}
%%   \frametitle{Non-spatial CJS model}
%%   {\bf State model}
%%   \[
%%     z_{i,t} \sim \mbox{Bernoulli}(z_{i,t-1} \times \phi)
%%   \]
%%   \vfill
%%   {\bf Observation model}
%%   \[
%%     y_{i,t} \sim \mbox{Bernoulli}(z_{i,t} \times p)
%%   \]
%%   \pause
%%   \vfill
%%   \small
%%   where \\
%%   \begin{itemize}
%%     \item $z_{i,t}$ is ``alive state'' of individual $i$ at time $t$
%%     \item $\phi$ is ``apparent survival''. Probability of being alive and not permanently emigrating.
%%     \item $y_{i,t}=1$ if individual was encountered. $y_{i,t}=0$ otherwise.
%%   \end{itemize}
%% \end{frame}








% \section{Spatial JS}






% \begin{frame}
%   \frametitle{Spatial model}
%   \large
%   {Extensions}
%   \begin{itemize}
%     \item Individuals heterogeneity in vital rates
%     \item Spatial heterogeneity in vital rates
%     \item Density dependence
%     \item Dispersal
%   \end{itemize}
% \end{frame}




\begin{frame}
  \frametitle{\Large Individual-based spatial population dynamics}
  {Initial State}
  \begin{gather*}
    z_{i,1} \sim \mbox{Bernoulli}(\psi) \\
    {\bm s}_{i,1} \propto \lambda_1(\bs)
  \end{gather*}
  \vfill
  Survival and Recruitment
  \[
    z_{i,t} \sim
    \begin{cases}
      \mbox{Bernoulli}(z_{i,t-1}\phi) & \quad \text{if previously recruited} \\
      \mbox{Bernoulli}(\gamma'_t) & \quad \text{if not yet recruited} 
    \end{cases}
  \]
  \vfill
  Movement (Assuming random walk)
  \[
    \bsit %\sim %\mathrm{Norm}(\bsitp, \tau^2)  
    \begin{cases}
      \sim \mbox{Norm}(\bsitp, \tau^2) & \quad \text{if previously recruited} \\
      \propto \lambda_t(\bs) & \quad \text{if not yet recruited} 
    \end{cases}
  \]
  \vfill
  Abundance ($M$ is the upper bound of data augmentation)
  \[
    N_t = \sum_{i=1}^M z_{i,t}
  \]
\end{frame}





\begin{frame}[fragile]
  \frametitle{Simulating spatial JS data with robust design}
%  \scriptsize % \tiny %\small
  {Parameters and data dimensions}
\begin{knitrout}\scriptsize
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hldef{T} \hlkwb{<-} \hlnum{10}      \hlcom{# years/primary periods}
\hldef{K} \hlkwb{<-} \hlnum{3}       \hlcom{# 3 secondary sampling occasion}
\hldef{lambda} \hlkwb{<-} \hlnum{25} \hlcom{# Expected value of abundance in year 1}
\hldef{M} \hlkwb{<-} \hlnum{500}     \hlcom{# Easiest way to simulate data is using data augmentation}
\hldef{phi} \hlkwb{<-} \hlnum{0.7}   \hlcom{# Apparent survival}
\hldef{gamma} \hlkwb{<-} \hlnum{0.3} \hlcom{# Per-capital recruitment rate}
\hldef{p0} \hlkwb{<-} \hlnum{0.4}    \hlcom{# Baseline capture prob}
\hldef{sigma} \hlkwb{<-} \hlnum{0.1} \hlcom{# Scale parameter of encounter rate function}
\end{alltt}
\end{kframe}
\end{knitrout}
\pause
{Traps, activity centers, and capture probability}
\begin{knitrout}\scriptsize
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlkwd{set.seed}\hldef{(}\hlnum{340}\hldef{)}
\hldef{co} \hlkwb{<-} \hlkwd{seq}\hldef{(}\hlnum{0.25}\hldef{,} \hlnum{0.75}\hldef{,} \hlkwc{length}\hldef{=}\hlnum{5}\hldef{)}
\hldef{x} \hlkwb{<-} \hlkwd{cbind}\hldef{(}\hlkwd{rep}\hldef{(co,} \hlkwc{each}\hldef{=}\hlnum{5}\hldef{),} \hlkwd{rep}\hldef{(co,} \hlkwc{times}\hldef{=}\hlnum{5}\hldef{))}
\hldef{J} \hlkwb{<-} \hlkwd{nrow}\hldef{(x)}  \hlcom{## nTraps}
\hldef{xlim} \hlkwb{<-} \hldef{ylim} \hlkwb{<-} \hlkwd{c}\hldef{(}\hlnum{0}\hldef{,}\hlnum{1}\hldef{)}
\hlcom{## Activity centers, no dispersal}
\hldef{s} \hlkwb{<-} \hlkwd{cbind}\hldef{(}\hlkwd{runif}\hldef{(M, xlim[}\hlnum{1}\hldef{], xlim[}\hlnum{2}\hldef{]),} \hlkwd{runif}\hldef{(M, ylim[}\hlnum{1}\hldef{], ylim[}\hlnum{2}\hldef{]))}
\hldef{d} \hlkwb{<-} \hldef{p} \hlkwb{<-} \hlkwd{matrix}\hldef{(}\hlnum{NA}\hldef{, M, J)}
\hlkwa{for}\hldef{(i} \hlkwa{in} \hlnum{1}\hlopt{:}\hldef{M) \{}
    \hldef{d[i,]} \hlkwb{<-} \hlkwd{sqrt}\hldef{((s[i,}\hlnum{1}\hldef{]}\hlopt{-}\hldef{x[,}\hlnum{1}\hldef{])}\hlopt{^}\hlnum{2} \hlopt{+} \hldef{(s[i,}\hlnum{2}\hldef{]}\hlopt{-}\hldef{x[,}\hlnum{2}\hldef{])}\hlopt{^}\hlnum{2}\hldef{)}
    \hldef{p[i,]} \hlkwb{<-} \hldef{p0}\hlopt{*}\hlkwd{exp}\hldef{(}\hlopt{-}\hldef{d[i,]}\hlopt{^}\hlnum{2}\hlopt{/}\hldef{(}\hlnum{2}\hlopt{*}\hldef{sigma}\hlopt{^}\hlnum{2}\hldef{)) \}} \hlcom{# capture prob }
\end{alltt}
\end{kframe}
\end{knitrout}
\end{frame}





\begin{frame}[fragile]
  \frametitle{Simulating spatial JS data with robust design}
{Generate $z$}
%\scriptsize
\begin{knitrout}\scriptsize
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlkwd{set.seed}\hldef{(}\hlnum{034}\hldef{)}
\hldef{z} \hlkwb{<-} \hldef{recruitable} \hlkwb{<-} \hldef{died} \hlkwb{<-} \hldef{recruited} \hlkwb{<-} \hlkwd{matrix}\hldef{(}\hlnum{0}\hldef{, M, T)}
\hldef{z[,}\hlnum{1}\hldef{]} \hlkwb{<-} \hlkwd{rbinom}\hldef{(M,} \hlnum{1}\hldef{, lambda}\hlopt{/}\hldef{M)} \hlcom{# alive at t=1}
\hldef{recruitable[,}\hlnum{1}\hldef{]} \hlkwb{<-} \hlnum{1}\hlopt{-}\hldef{z[,}\hlnum{1}\hldef{]}
\hldef{N} \hlkwb{<-} \hlkwd{integer}\hldef{(T)}
\hldef{N[}\hlnum{1}\hldef{]} \hlkwb{<-} \hlkwd{sum}\hldef{(z[,}\hlnum{1}\hldef{])}
\hlkwa{for}\hldef{(t} \hlkwa{in} \hlnum{2}\hlopt{:}\hldef{T) \{}
    \hldef{ER} \hlkwb{<-} \hldef{N[t}\hlopt{-}\hlnum{1}\hldef{]}\hlopt{*}\hldef{gamma} \hlcom{# expected number of recruits}
    \hldef{prevA} \hlkwb{<-} \hlkwd{sum}\hldef{(recruitable[,t}\hlopt{-}\hlnum{1}\hldef{])} \hlcom{# Number available to be recruited}
    \hldef{gammaPrime} \hlkwb{<-} \hldef{ER}\hlopt{/}\hldef{prevA}
    \hlkwa{if}\hldef{(gammaPrime} \hlopt{>} \hlnum{1}\hldef{)} \hlkwd{stop}\hldef{(}\hlsng{"M isn't big enough"}\hldef{)}
    \hldef{z[,t]} \hlkwb{<-} \hlkwd{rbinom}\hldef{(M,} \hlnum{1}\hldef{, (}\hlnum{1}\hlopt{-}\hldef{recruitable[,t}\hlopt{-}\hlnum{1}\hldef{])}\hlopt{*}\hldef{z[,t}\hlopt{-}\hlnum{1}\hldef{]}\hlopt{*}\hldef{phi} \hlopt{+}
                          \hldef{recruitable[,t}\hlopt{-}\hlnum{1}\hldef{]}\hlopt{*}\hldef{gammaPrime)}
    \hldef{recruitable[,t]} \hlkwb{<-} \hldef{recruitable[,t}\hlopt{-}\hlnum{1}\hldef{]}\hlopt{*}\hldef{(}\hlnum{1}\hlopt{-}\hldef{z[,t])}
    \hldef{N[t]} \hlkwb{<-} \hlkwd{sum}\hldef{(z[,t])  \}}
\end{alltt}
\end{kframe}
\end{knitrout}
\pause
\vfill
{\normalsize Populaton size, mortalities, and recruits}
\begin{knitrout}\scriptsize
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hldef{died} \hlkwb{<-} \hldef{(z[,}\hlnum{1}\hlopt{:}\hldef{(T}\hlopt{-}\hlnum{1}\hldef{)]}\hlopt{==}\hlnum{1}\hldef{)} \hlopt{&} \hldef{(z[,}\hlnum{2}\hlopt{:}\hldef{T]}\hlopt{==}\hlnum{0}\hldef{)}
\hldef{recruited} \hlkwb{<-} \hldef{(z[,}\hlnum{1}\hlopt{:}\hldef{(T}\hlopt{-}\hlnum{1}\hldef{)]}\hlopt{==}\hlnum{0}\hldef{)} \hlopt{&} \hldef{(z[,}\hlnum{2}\hlopt{:}\hldef{T]}\hlopt{==}\hlnum{1}\hldef{)}
\hldef{Deaths} \hlkwb{<-} \hlkwd{colSums}\hldef{(died)}
\hldef{Recruits} \hlkwb{<-} \hlkwd{colSums}\hldef{(recruited)}
\hldef{everAlive} \hlkwb{<-} \hlkwd{sum}\hldef{(}\hlkwd{rowSums}\hldef{(z)}\hlopt{>}\hlnum{0}\hldef{)}
\end{alltt}
\end{kframe}
\end{knitrout}
\end{frame}




\begin{frame}[fragile]
  \frametitle{Visualize dynamics}
\begin{knitrout}\tiny
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlkwd{plot}\hldef{(}\hlnum{1}\hlopt{:}\hldef{T, N,} \hlkwc{type}\hldef{=}\hlsng{"b"}\hldef{,} \hlkwc{xlab}\hldef{=}\hlsng{"Year"}\hldef{,} \hlkwc{ylab}\hldef{=}\hlsng{""}\hldef{,} \hlkwc{ylim}\hldef{=}\hlkwd{c}\hldef{(}\hlnum{0}\hldef{,} \hlnum{50}\hldef{),} \hlkwc{pch}\hldef{=}\hlnum{16}\hldef{)}
\hlkwd{lines}\hldef{(}\hlnum{2}\hlopt{:}\hldef{T, Deaths,} \hlkwc{type}\hldef{=}\hlsng{"b"}\hldef{,} \hlkwc{col}\hldef{=}\hlsng{"red2"}\hldef{,} \hlkwc{pch}\hldef{=}\hlnum{16}\hldef{);} \hlkwd{lines}\hldef{(}\hlnum{2}\hlopt{:}\hldef{T, Recruits,} \hlkwc{type}\hldef{=}\hlsng{"b"}\hldef{,} \hlkwc{col}\hldef{=}\hlsng{"seagreen2"}\hldef{,} \hlkwc{pch}\hldef{=}\hlnum{16}\hldef{)}
\hlkwd{legend}\hldef{(}\hlnum{1}\hldef{,} \hlnum{50}\hldef{,} \hlkwd{c}\hldef{(}\hlsng{"Abundance"}\hldef{,}\hlsng{"Mortalities"}\hldef{,}\hlsng{"Recruits"}\hldef{),} \hlkwc{lty}\hldef{=}\hlnum{1}\hldef{,} \hlkwc{pch}\hldef{=}\hlnum{16}\hldef{,} \hlkwc{col}\hldef{=}\hlkwd{c}\hldef{(}\hlsng{"black"}\hldef{,}\hlsng{"red2"}\hldef{,}\hlsng{"seagreen2"}\hldef{))}
\end{alltt}
\end{kframe}

{\centering \includegraphics[width=0.9\linewidth]{figure/dynamics1-1} 

}


\end{knitrout}
\end{frame}






\begin{frame}[fragile]
  \frametitle{Simulating spatial JS data with robust design}
{Generate encounter histories for all $M$ individuals}
\begin{knitrout}\footnotesize
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hldef{yall.bern} \hlkwb{<-} \hlkwd{array}\hldef{(}\hlnum{NA}\hldef{,} \hlkwd{c}\hldef{(M, J, K, T))}   \hlcom{## For Bernoulli}
\hldef{yall} \hlkwb{<-} \hlkwd{array}\hldef{(}\hlnum{NA}\hldef{,} \hlkwd{c}\hldef{(M, J, T))}           \hlcom{## For Binomial}
\hlkwa{for}\hldef{(i} \hlkwa{in} \hlnum{1}\hlopt{:}\hldef{M) \{}
    \hlkwa{for}\hldef{(t} \hlkwa{in} \hlnum{1}\hlopt{:}\hldef{T) \{}
        \hlkwa{for}\hldef{(j} \hlkwa{in} \hlnum{1}\hlopt{:}\hldef{J) \{}
            \hldef{yall.bern[i,j,}\hlnum{1}\hlopt{:}\hldef{K,t]} \hlkwb{<-} \hlkwd{rbinom}\hldef{(K,} \hlnum{1}\hldef{, z[i,t]}\hlopt{*}\hldef{p[i,j])}
            \hldef{yall[i,j,t]} \hlkwb{<-} \hlkwd{rbinom}\hldef{(}\hlnum{1}\hldef{, K, z[i,t]}\hlopt{*}\hldef{p[i,j])}
        \hldef{\}}
    \hldef{\}}
\hldef{\}}
\end{alltt}
\end{kframe}
\end{knitrout}
\pause
\vfill
{\normalsize Discard individuals that were never captured}
\begin{knitrout}\footnotesize
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hldef{y.bern} \hlkwb{<-} \hldef{yall.bern[}\hlkwd{rowSums}\hldef{(yall.bern)}\hlopt{>}\hlnum{0}\hldef{,,,]}
\hldef{y} \hlkwb{<-} \hldef{yall[}\hlkwd{rowSums}\hldef{(yall)}\hlopt{>}\hlnum{0}\hldef{,,]}
\hlkwd{str}\hldef{(y)}
\end{alltt}
\begin{verbatim}
##  int [1:72, 1:25, 1:10] 0 0 0 0 0 0 0 0 0 0 ...
\end{verbatim}
\end{kframe}
\end{knitrout}
\end{frame}






% \begin{frame}[fragile]
%   \frametitle{Time series}
% %  \tiny
% <<NDR,size='tiny',out.width='60%',fig.align='center'>>=
% plot(1:T, N, ylim=c(0, 50), type="o", pch=16,
%      xlab="Year", ylab="")
% lines(2:T, Deaths[-1], col="red", type="o", pch=16)
% lines(2:T, Recruits[-1], col="blue", type="o", pch=16)
% legend(1, 50, c("Population size", "Deaths", "Recruits"),
%        col=c("black", "red", "blue"), pch=16, lty=1)
% @
% % \vspace{-3mm}
% % \begin{center}
% %   \includegraphics[width=0.8\textwidth]{Open-JS-NDR}
% % \end{center}
% \end{frame}




\section{Likelihood inference}



\begin{frame}[plain]
  \frametitle{Topics}
  \Large
  \tableofcontents[currentsection]
\end{frame}




\begin{frame}[fragile]
  \frametitle{Likelihood analysis of spatial JS model}
Begin by making a mask in `secr'
\begin{knitrout}\scriptsize
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlkwd{library}\hldef{(openpopscr)}
\hldef{trap.df} \hlkwb{<-} \hlkwd{data.frame}\hldef{(x}\hlopt{*}\hlnum{1000}\hldef{);} \hlkwd{colnames}\hldef{(trap.df)} \hlkwb{<-} \hlkwd{c}\hldef{(}\hlsng{"x"}\hldef{,}\hlsng{"y"}\hldef{)}
\hldef{traps} \hlkwb{<-} \hlkwd{read.traps}\hldef{(}\hlkwc{data}\hldef{=trap.df,} \hlkwc{detector}\hldef{=}\hlsng{"proximity"}\hldef{)}
\hldef{mask} \hlkwb{<-} \hlkwd{make.mask}\hldef{(}\hlkwc{traps}\hldef{=traps,} \hlkwc{buffer}\hldef{=}\hlnum{250}\hldef{)}
\hlkwd{plot}\hldef{(mask);} \hlkwd{points}\hldef{(traps,} \hlkwc{pch}\hldef{=}\hlnum{3}\hldef{,} \hlkwc{col}\hldef{=}\hlsng{"blue"}\hldef{,} \hlkwc{lwd}\hldef{=}\hlnum{2}\hldef{)}
\end{alltt}
\end{kframe}

{\centering \includegraphics[width=0.6\linewidth]{figure/mask-1} 

}


\end{knitrout}
\end{frame}


\begin{frame}[fragile]
  \frametitle{Likelihood analysis of spatial JS model}
Format for `secr' (with robust design)
\begin{knitrout}\scriptsize
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hldef{y.secr} \hlkwb{<-} \hldef{y.bern}
\hldef{year} \hlkwb{<-} \hlkwd{rep}\hldef{(}\hlkwd{slice.index}\hldef{(y.bern,} \hlnum{4}\hldef{), y.secr)}  \hlcom{## Primary period}
\hldef{day} \hlkwb{<-} \hlkwd{rep}\hldef{(}\hlkwd{slice.index}\hldef{(y.bern,} \hlnum{3}\hldef{), y.secr)}   \hlcom{## Secondary period }
\hldef{caps} \hlkwb{<-} \hlkwd{data.frame}\hldef{(}\hlkwc{session}\hldef{=}\hlnum{1}\hldef{,}
                   \hlkwc{animal}\hldef{=}\hlkwd{rep}\hldef{(}\hlkwd{slice.index}\hldef{(y.bern,} \hlnum{1}\hldef{), y.secr),}
                   \hlkwc{occasion}\hldef{=(year}\hlopt{-}\hlnum{1}\hldef{)}\hlopt{*}\hldef{K}\hlopt{+}\hldef{day,}
                   \hlkwc{trap}\hldef{=}\hlkwd{rep}\hldef{(}\hlkwd{slice.index}\hldef{(y.bern,} \hlnum{2}\hldef{), y.secr))}
\hldef{capthist} \hlkwb{<-} \hlkwd{make.capthist}\hldef{(}\hlkwc{captures}\hldef{=caps,} \hlkwc{traps}\hldef{=traps,} \hlkwc{noccasions}\hldef{=T}\hlopt{*}\hldef{K)}
\end{alltt}
\end{kframe}
\end{knitrout}
\vfill
Then format for `openpopscr'
\begin{knitrout}\scriptsize
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hldef{js.data} \hlkwb{<-} \hldef{ScrData}\hlopt{$}\hlkwd{new}\hldef{(capthist, mask,} \hlkwc{primary}\hldef{=}\hlkwd{rep}\hldef{(}\hlnum{1}\hlopt{:}\hldef{T,} \hlkwc{each}\hldef{=K))}
\end{alltt}
\end{kframe}
\end{knitrout}
\end{frame}


\begin{frame}[fragile]
  \frametitle{Likelihood analysis}
Create the model object and then fit it
\begin{knitrout}\scriptsize
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{start} \hlkwb{<-} \hlkwd{get_start_values}\hlstd{(js.data,} \hlkwc{model} \hlstd{=} \hlstr{"JsModel"}\hlstd{)}
\hlstd{mod} \hlkwb{<-} \hlstd{JsModel}\hlopt{$}\hlkwd{new}\hlstd{(}\hlkwd{list}\hlstd{(lambda0}\hlopt{~}\hlnum{1}\hlstd{, sigma}\hlopt{~}\hlnum{1}\hlstd{, D}\hlopt{~}\hlnum{1}\hlstd{, phi}\hlopt{~}\hlnum{1}\hlstd{, beta}\hlopt{~}\hlnum{1}\hlstd{), js.data,}
                   \hlkwc{start}\hlstd{=start)}
\hlstd{mod}\hlopt{$}\hlkwd{fit}\hlstd{()}
\end{alltt}
\end{kframe}
\end{knitrout}
Back-transform
\begin{knitrout}\tiny
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hldef{mod}\hlopt{$}\hlkwd{get_par}\hldef{(}\hlsng{"lambda0"}\hldef{,} \hlkwc{k} \hldef{=} \hlnum{1}\hldef{,} \hlkwc{j} \hldef{=} \hlnum{1}\hldef{)} \hlcom{## Baseline capture probability}
\end{alltt}
\begin{verbatim}
## [1] 0.449656
\end{verbatim}
\begin{alltt}
\hldef{mod}\hlopt{$}\hlkwd{get_par}\hldef{(}\hlsng{"sigma"}\hldef{,} \hlkwc{k} \hldef{=} \hlnum{1}\hldef{,} \hlkwc{j} \hldef{=} \hlnum{1}\hldef{)}   \hlcom{## Scale parameter of the detection function}
\end{alltt}
\begin{verbatim}
## [1] 96.1884
\end{verbatim}
\begin{alltt}
\hldef{mod}\hlopt{$}\hlkwd{get_par}\hldef{(}\hlsng{"D"}\hldef{)}                     \hlcom{## Superpopulation density}
\end{alltt}
\begin{verbatim}
## [1] 96.00797
\end{verbatim}
\begin{alltt}
\hldef{mod}\hlopt{$}\hlkwd{get_par}\hldef{(}\hlsng{"beta"}\hldef{,} \hlkwc{k} \hldef{=} \hlnum{1}\hldef{,} \hlkwc{m}\hldef{=}\hlnum{1}\hldef{)}      \hlcom{## Per-capita recruitment}
\end{alltt}
\begin{verbatim}
## [1] 0.2811347
\end{verbatim}
\begin{alltt}
\hldef{mod}\hlopt{$}\hlkwd{get_par}\hldef{(}\hlsng{"phi"}\hldef{,} \hlkwc{k} \hldef{=} \hlnum{1}\hldef{,} \hlkwc{m}\hldef{=}\hlnum{1}\hldef{)}       \hlcom{## Survival}
\end{alltt}
\begin{verbatim}
## [1] 0.6503956
\end{verbatim}
\end{kframe}
\end{knitrout}
\end{frame}



\begin{frame}[fragile]
  \frametitle{Density estimates}
\begin{knitrout}\small
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hldef{mod}\hlopt{$}\hlkwd{estimates}\hldef{()}\hlopt{$}\hldef{D}
\end{alltt}
\begin{verbatim}
##    Estimate       SE      LCL      UCL
## 1  26.99117 6.592624 17.04979 42.72918
## 2  25.22347 4.412889 18.03533 35.27651
## 3  24.07377 3.582891 18.06686 32.07786
## 4  23.32600 3.441197 17.54839 31.00584
## 5  22.83966 3.534214 16.95278 30.77077
## 6  22.52335 3.663363 16.47433 30.79343
## 7  22.31762 3.770463 16.13495 30.86939
## 8  22.18381 3.847131 15.90660 30.93820
## 9  22.09679 3.898544 15.75686 30.98765
## 10 22.04018 3.931822 15.66004 31.01970
\end{verbatim}
\end{kframe}
\end{knitrout}
\end{frame}



\section{Bayesian inference}




\begin{frame}[plain]
  \frametitle{Topics}
  \Large
  \tableofcontents[currentsection]
\end{frame}



\begin{frame}[fragile]
  \frametitle{Spatial JS model in \jags}
%  \vspace{-3mm}
%  \tiny \fbox{\parbox{\linewidth}{\verbatiminput{JS-spatial.jag}}}
%  \tiny {\parbox{\linewidth}{\pagecolor{ProcessBlue}\verbatiminput{JS-spatial.jag}}}
  \tiny
\begin{knitrout}\tiny
\definecolor{shadecolor}{rgb}{0.678, 0.847, 0.902}\color{fgcolor}\begin{kframe}
\begin{verbatim}
model {
phi ~ dunif(0,1)      ## Survival
gamma ~ dunif(0, 5)   ## Per-capita recruitment rate
p0 ~ dunif(0,1)       ## Baseline capture probability
sigma ~ dunif(0, 2)   ## Scale parameter of capture function
psi ~ dunif(0,1)    
for(t in 1:T) {
  N[t] <- sum(z[,t])      ## Abundance
  ER[t] <- N[t]*gamma     ## Expected number of recruits in year t
  totalAvail[t] <- sum(recruitable[,t])  ## nAvailable to be recruited
  gammaPrime[t] <- ER[t]/totalAvail[t] } ## Pr(recruited in year t|available)
for(i in 1:M) {
  z[i,1] ~ dbern(psi)              ## Alive/dead state in year 1
  recruitable[i,1] <- 1 - z[i,1]   ## Recruitable next year if not recruited yet
  s[i,1] ~ dunif(xlim[1], xlim[2]) ## static activity centers
  s[i,2] ~ dunif(ylim[1], ylim[2])
  for(j in 1:J) {
    d[i,j] <- sqrt((s[i,1] - x[j,1])^2 + (s[i,2] - x[j,2])^2) ## Distance
    p[i,j] <- p0*exp(-d[i,j]^2/(2*sigma^2))                   ## Cap prob
    y[i,j,1] ~ dbin(z[i,1]*p[i,j], K)  }                      ## Data in year 1
  for(t in 2:T) {
    z[i,t] ~ dbern(z[i,t-1]*phi + recruitable[i,t-1]*gammaPrime[t-1]) ## Alive/dead state 
    died[i,t] <- (z[i,t-1]==1) && (z[i,t]==0)                 ## Did this guy die?
    recruited[i,t] <- (z[i,t-1]==0) && (z[i,t]==1)            ## Or was it recruited?
    recruitable[i,t] <- recruitable[i,t-1]*(1-z[i,t])
    for(j in 1:J) {
      y[i,j,t] ~ dbin(z[i,t]*p[i,j], K) }  }                  ## Data in year t
  everAlive[i] <- sum(z[i,]) > 0  }
for(t in 2:T) {
  Deaths[t-1] <- sum(died[,t])             ## Total deaths each year
  Recruits[t-1] <- sum(recruited[,t]) }    ## Total recruits each year
Ntot <- sum(everAlive)                     ## Super-population size
}
\end{verbatim}
\end{kframe}
\end{knitrout}
\end{frame}






\begin{frame}[fragile]
  \frametitle{Bayesian analysis}
%  \footnotesize
  {Data augmentation}
\begin{knitrout}\scriptsize
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hldef{M} \hlkwb{<-} \hlkwd{nrow}\hldef{(y)} \hlopt{+} \hlnum{50}   \hlcom{## Trial and error}
\hldef{yz} \hlkwb{<-} \hlkwd{array}\hldef{(}\hlnum{0}\hldef{,} \hlkwd{c}\hldef{(M, J, T))}
\hldef{yz[}\hlnum{1}\hlopt{:}\hlkwd{nrow}\hldef{(y),,]} \hlkwb{<-} \hldef{y}
\hldef{jags.data1} \hlkwb{<-} \hlkwd{list}\hldef{(}\hlkwc{y}\hldef{=yz,} \hlkwc{M}\hldef{=M,} \hlkwc{x}\hldef{=x,} \hlkwc{J}\hldef{=J,} \hlkwc{K}\hldef{=K,} \hlkwc{T}\hldef{=T,} \hlkwc{xlim}\hldef{=xlim,} \hlkwc{ylim}\hldef{=ylim)}
\end{alltt}
\end{kframe}
\end{knitrout}
\pause
\vfill
  {\normalsize Initial values and parameters to monitor}
\begin{knitrout}\scriptsize
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hldef{zi} \hlkwb{<-} \hlkwd{matrix}\hldef{(}\hlnum{0}\hldef{, M, T)}
\hldef{zi[}\hlnum{1}\hlopt{:}\hlkwd{nrow}\hldef{(y),]} \hlkwb{<-} \hlnum{1}
\hldef{ji1} \hlkwb{<-} \hlkwa{function}\hldef{()} \hlkwd{list}\hldef{(}\hlkwc{phi}\hldef{=}\hlnum{0.01}\hldef{,} \hlkwc{gamma}\hldef{=}\hlnum{0.001}\hldef{,} \hlkwc{z}\hldef{=zi)}
\hldef{jp1} \hlkwb{<-} \hlkwd{c}\hldef{(}\hlsng{"phi"}\hldef{,} \hlsng{"gamma"}\hldef{,} \hlsng{"p0"}\hldef{,} \hlsng{"sigma"}\hldef{,} \hlsng{"N"}\hldef{,} \hlsng{"Deaths"}\hldef{,} \hlsng{"Recruits"}\hldef{,} \hlsng{"Ntot"}\hldef{)}
\end{alltt}
\end{kframe}
\end{knitrout}
\pause
\vfill
  {\normalsize Fit the model}
\begin{knitrout}\scriptsize
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlkwd{library}\hlstd{(jagsUI)}
\hlstd{jags.post.samples1} \hlkwb{<-} \hlkwd{jags.basic}\hlstd{(}\hlkwc{data}\hlstd{=jags.data1,} \hlkwc{inits}\hlstd{=ji1,}
                                 \hlkwc{parameters.to.save}\hlstd{=jp1,}
                                 \hlkwc{model.file}\hlstd{=}\hlstr{"JS-spatial.jag"}\hlstd{,}
                                 \hlkwc{n.chains}\hlstd{=}\hlnum{3}\hlstd{,} \hlkwc{n.adapt}\hlstd{=}\hlnum{100}\hlstd{,} \hlkwc{n.burnin}\hlstd{=}\hlnum{0}\hlstd{,}
                                 \hlkwc{n.iter}\hlstd{=}\hlnum{2000}\hlstd{,} \hlkwc{parallel}\hlstd{=}\hlnum{TRUE}\hlstd{)}
\end{alltt}
\end{kframe}
\end{knitrout}
\end{frame}




\begin{frame}[fragile]
  \frametitle{Is $M$ high enough?}
\begin{knitrout}\tiny
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlkwd{hist}\hldef{(}\hlkwd{as.matrix}\hldef{(jags.post.samples1[,}\hlsng{"Ntot"}\hldef{]),} \hlkwc{xlab}\hldef{=}\hlsng{"Total population size"}\hldef{,}
     \hlkwc{ylab}\hldef{=}\hlsng{""}\hldef{,} \hlkwc{main}\hldef{=}\hlsng{""}\hldef{,} \hlkwc{freq}\hldef{=}\hlnum{FALSE}\hldef{,} \hlkwc{xlim}\hldef{=}\hlkwd{c}\hldef{(}\hlkwd{nrow}\hldef{(y), M))}
\hlkwd{abline}\hldef{(}\hlkwc{v}\hldef{=M,} \hlkwc{lwd}\hldef{=}\hlnum{3}\hldef{,} \hlkwc{col}\hldef{=}\hlsng{"blue"}\hldef{)}
\end{alltt}
\end{kframe}

{\centering \includegraphics[width=0.7\linewidth]{figure/Ntot-1} 

}


\end{knitrout}
\end{frame}






\begin{frame}[fragile]
  \frametitle{Posterior distributions}
\begin{knitrout}\scriptsize
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlkwd{plot}\hldef{(jags.post.samples1[,}\hlkwd{c}\hldef{(}\hlsng{"phi"}\hldef{,} \hlsng{"gamma"}\hldef{,} \hlsng{"p0"}\hldef{,} \hlsng{"sigma"}\hldef{)])}
\end{alltt}
\end{kframe}

{\centering \includegraphics[width=0.6\linewidth]{figure/jc1-1} 

}


\end{knitrout}
% \begin{center}
%   \fbox{\includegraphics[width=0.7\textwidth]{Open-JS-jc1}}
% \end{center}
\end{frame}






\begin{frame}[fragile]
  \frametitle{Posterior distributions}


\begin{center}
  \fbox{\includegraphics[width=0.45\textwidth]{figure/jcN1-4-1}}
  \fbox{\includegraphics[width=0.45\textwidth]{figure/jcN5-8-1}}
\end{center}
\end{frame}





\begin{frame}[fragile]
  \frametitle{Actual and estimated abundance}
  Extract and summarize posterior samples of $N_t$
\begin{knitrout}\scriptsize
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hldef{Npost} \hlkwb{<-} \hlkwd{as.matrix}\hldef{(jags.post.samples1[,}\hlkwd{paste}\hldef{(}\hlsng{"N["}\hldef{,} \hlnum{1}\hlopt{:}\hlnum{10}\hldef{,} \hlsng{"]"}\hldef{,} \hlkwc{sep}\hldef{=}\hlsng{""}\hldef{)])}
\hldef{Nmed} \hlkwb{<-} \hlkwd{apply}\hldef{(Npost,} \hlnum{2}\hldef{, median)}
\hldef{Nupper} \hlkwb{<-} \hlkwd{apply}\hldef{(Npost,} \hlnum{2}\hldef{, quantile,} \hlkwc{prob}\hldef{=}\hlnum{0.975}\hldef{)}
\hldef{Nlower} \hlkwb{<-} \hlkwd{apply}\hldef{(Npost,} \hlnum{2}\hldef{, quantile,} \hlkwc{prob}\hldef{=}\hlnum{0.025}\hldef{)}
\end{alltt}
\end{kframe}
\end{knitrout}
  \pause
  \vfill
  Plot
\begin{knitrout}\scriptsize
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlkwd{plot}\hldef{(}\hlnum{1}\hlopt{:}\hldef{T, N,} \hlkwc{type}\hldef{=}\hlsng{"b"}\hldef{,} \hlkwc{ylim}\hldef{=}\hlkwd{c}\hldef{(}\hlnum{0}\hldef{,} \hlnum{60}\hldef{),} \hlkwc{xlab}\hldef{=}\hlsng{"Time"}\hldef{,}
     \hlkwc{ylab}\hldef{=}\hlsng{"Abundance"}\hldef{,} \hlkwc{pch}\hldef{=}\hlnum{16}\hldef{)}
\hlkwd{arrows}\hldef{(}\hlnum{1}\hlopt{:}\hldef{T, Nlower,} \hlnum{1}\hlopt{:}\hldef{T, Nupper,} \hlkwc{angle}\hldef{=}\hlnum{90}\hldef{,} \hlkwc{code}\hldef{=}\hlnum{3}\hldef{,}
       \hlkwc{length}\hldef{=}\hlnum{0.05}\hldef{,} \hlkwc{col}\hldef{=}\hlkwd{gray}\hldef{(}\hlnum{0.7}\hldef{))}
\hlkwd{points}\hldef{(}\hlnum{1}\hlopt{:}\hldef{T, Nmed,} \hlkwc{pch}\hldef{=}\hlnum{16}\hldef{,} \hlkwc{col}\hldef{=}\hlkwd{gray}\hldef{(}\hlnum{0.7}\hldef{))}
\hlkwd{legend}\hldef{(}\hlnum{1}\hldef{,} \hlnum{60}\hldef{,} \hlkwd{c}\hldef{(}\hlsng{"Actual"}\hldef{,} \hlsng{"Estimated"}\hldef{),}
       \hlkwc{col}\hldef{=}\hlkwd{c}\hldef{(}\hlsng{"black"}\hldef{,} \hlkwd{gray}\hldef{(}\hlnum{0.7}\hldef{)),} \hlkwc{lty}\hldef{=}\hlkwd{c}\hldef{(}\hlnum{NA}\hldef{,}\hlnum{1}\hldef{),} \hlkwc{pch}\hldef{=}\hlkwd{c}\hldef{(}\hlnum{16}\hldef{,}\hlnum{16}\hldef{))}
\end{alltt}
\end{kframe}
\end{knitrout}
\end{frame}





\begin{frame}
  \frametitle{Actual and estimated abundance}
%  \vspace{-4mm}
  \begin{center}
    \includegraphics[width=\textwidth]{figure/Npost-1}
  \end{center}
\end{frame}






\begin{frame}[fragile]
  \frametitle{Actual and estimated recruits}
  Extract and summarize posterior samples of $R_t$
\begin{knitrout}\scriptsize
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hldef{Rpost} \hlkwb{<-} \hlkwd{as.matrix}\hldef{(jags.post.samples1[,}\hlkwd{paste}\hldef{(}\hlsng{"Recruits["}\hldef{,}\hlnum{1}\hlopt{:}\hlnum{9}\hldef{,}\hlsng{"]"}\hldef{,}\hlkwc{sep}\hldef{=}\hlsng{""}\hldef{)])}
\hldef{Rmed} \hlkwb{<-} \hlkwd{apply}\hldef{(Rpost,} \hlnum{2}\hldef{, median)}
\hldef{Rupper} \hlkwb{<-} \hlkwd{apply}\hldef{(Rpost,} \hlnum{2}\hldef{, quantile,} \hlkwc{prob}\hldef{=}\hlnum{0.975}\hldef{)}
\hldef{Rlower} \hlkwb{<-} \hlkwd{apply}\hldef{(Rpost,} \hlnum{2}\hldef{, quantile,} \hlkwc{prob}\hldef{=}\hlnum{0.025}\hldef{)}
\end{alltt}
\end{kframe}
\end{knitrout}
  \pause
  \vfill
  Plot
\begin{knitrout}\scriptsize
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlkwd{plot}\hldef{(}\hlnum{1}\hlopt{:}\hldef{(T}\hlopt{-}\hlnum{1}\hldef{), Recruits,} \hlkwc{type}\hldef{=}\hlsng{"b"}\hldef{,} \hlkwc{ylim}\hldef{=}\hlkwd{c}\hldef{(}\hlnum{0}\hldef{,} \hlnum{30}\hldef{),} \hlkwc{xlab}\hldef{=}\hlsng{"Time"}\hldef{,}
     \hlkwc{ylab}\hldef{=}\hlsng{"Recruits"}\hldef{,} \hlkwc{pch}\hldef{=}\hlnum{16}\hldef{,} \hlkwc{col}\hldef{=}\hlsng{"seagreen2"}\hldef{)}
\hlkwd{arrows}\hldef{(}\hlnum{1}\hlopt{:}\hldef{(T}\hlopt{-}\hlnum{1}\hldef{), Rlower,} \hlnum{1}\hlopt{:}\hldef{(T}\hlopt{-}\hlnum{1}\hldef{), Rupper,} \hlkwc{angle}\hldef{=}\hlnum{90}\hldef{,} \hlkwc{code}\hldef{=}\hlnum{3}\hldef{,}
       \hlkwc{length}\hldef{=}\hlnum{0.05}\hldef{,} \hlkwc{col}\hldef{=}\hlkwd{gray}\hldef{(}\hlnum{0.7}\hldef{))}
\hlkwd{points}\hldef{(}\hlnum{1}\hlopt{:}\hldef{(T}\hlopt{-}\hlnum{1}\hldef{), Rmed,} \hlkwc{pch}\hldef{=}\hlnum{16}\hldef{,} \hlkwc{col}\hldef{=}\hlkwd{gray}\hldef{(}\hlnum{0.7}\hldef{))}
\hlkwd{legend}\hldef{(}\hlnum{1}\hldef{,} \hlnum{30}\hldef{,} \hlkwd{c}\hldef{(}\hlsng{"Actual"}\hldef{,} \hlsng{"Estimated"}\hldef{),}
       \hlkwc{col}\hldef{=}\hlkwd{c}\hldef{(}\hlsng{"seagreen2"}\hldef{,} \hlkwd{gray}\hldef{(}\hlnum{0.7}\hldef{)),} \hlkwc{lty}\hldef{=}\hlkwd{c}\hldef{(}\hlnum{NA}\hldef{,}\hlnum{1}\hldef{),} \hlkwc{pch}\hldef{=}\hlkwd{c}\hldef{(}\hlnum{16}\hldef{,}\hlnum{16}\hldef{))}
\end{alltt}
\end{kframe}
\end{knitrout}
\end{frame}





\begin{frame}
  \frametitle{Actual and estimated recruits}
%  \vspace{-4mm}
  \begin{center}
    \includegraphics[width=\textwidth]{figure/Rpost-1}
  \end{center}
\end{frame}




\begin{frame}[fragile]
  \frametitle{Actual and estimated mortalities}
  Extract and summarize posterior samples of $D_t=N_t-S_t$
\begin{knitrout}\scriptsize
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hldef{Dpost} \hlkwb{<-} \hlkwd{as.matrix}\hldef{(jags.post.samples1[,}\hlkwd{paste}\hldef{(}\hlsng{"Deaths["}\hldef{,} \hlnum{1}\hlopt{:}\hlnum{9}\hldef{,} \hlsng{"]"}\hldef{,} \hlkwc{sep}\hldef{=}\hlsng{""}\hldef{)])}
\hldef{Dmed} \hlkwb{<-} \hlkwd{apply}\hldef{(Dpost,} \hlnum{2}\hldef{, median)}
\hldef{Dupper} \hlkwb{<-} \hlkwd{apply}\hldef{(Dpost,} \hlnum{2}\hldef{, quantile,} \hlkwc{prob}\hldef{=}\hlnum{0.975}\hldef{)}
\hldef{Dlower} \hlkwb{<-} \hlkwd{apply}\hldef{(Dpost,} \hlnum{2}\hldef{, quantile,} \hlkwc{prob}\hldef{=}\hlnum{0.025}\hldef{)}
\end{alltt}
\end{kframe}
\end{knitrout}
  \pause
  \vfill
  Plot
\begin{knitrout}\scriptsize
\definecolor{shadecolor}{rgb}{0.878, 0.918, 0.933}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlkwd{plot}\hldef{(}\hlnum{1}\hlopt{:}\hldef{(T}\hlopt{-}\hlnum{1}\hldef{), Deaths,} \hlkwc{type}\hldef{=}\hlsng{"b"}\hldef{,} \hlkwc{ylim}\hldef{=}\hlkwd{c}\hldef{(}\hlnum{0}\hldef{,} \hlnum{30}\hldef{),} \hlkwc{xlab}\hldef{=}\hlsng{"Time"}\hldef{,}
     \hlkwc{ylab}\hldef{=}\hlsng{"Mortalities"}\hldef{,} \hlkwc{pch}\hldef{=}\hlnum{16}\hldef{,} \hlkwc{col}\hldef{=}\hlsng{"red2"}\hldef{)}
\hlkwd{arrows}\hldef{(}\hlnum{1}\hlopt{:}\hldef{(T}\hlopt{-}\hlnum{1}\hldef{), Dlower,} \hlnum{1}\hlopt{:}\hldef{(T}\hlopt{-}\hlnum{1}\hldef{), Dupper,} \hlkwc{angle}\hldef{=}\hlnum{90}\hldef{,} \hlkwc{code}\hldef{=}\hlnum{3}\hldef{,}
       \hlkwc{length}\hldef{=}\hlnum{0.05}\hldef{,} \hlkwc{col}\hldef{=}\hlkwd{gray}\hldef{(}\hlnum{0.7}\hldef{))}
\hlkwd{points}\hldef{(}\hlnum{1}\hlopt{:}\hldef{(T}\hlopt{-}\hlnum{1}\hldef{), Dmed,} \hlkwc{pch}\hldef{=}\hlnum{16}\hldef{,} \hlkwc{col}\hldef{=}\hlkwd{gray}\hldef{(}\hlnum{0.7}\hldef{))}
\hlkwd{legend}\hldef{(}\hlnum{1}\hldef{,} \hlnum{30}\hldef{,} \hlkwd{c}\hldef{(}\hlsng{"Actual"}\hldef{,} \hlsng{"Estimated"}\hldef{),}
       \hlkwc{col}\hldef{=}\hlkwd{c}\hldef{(}\hlsng{"red2"}\hldef{,} \hlkwd{gray}\hldef{(}\hlnum{0.7}\hldef{)),} \hlkwc{lty}\hldef{=}\hlkwd{c}\hldef{(}\hlnum{NA}\hldef{,}\hlnum{1}\hldef{),} \hlkwc{pch}\hldef{=}\hlkwd{c}\hldef{(}\hlnum{16}\hldef{,}\hlnum{16}\hldef{))}
\end{alltt}
\end{kframe}
\end{knitrout}
\end{frame}





\begin{frame}
  \frametitle{Actual and estimated mortalities}
%  \vspace{-4mm}
  \begin{center}
    \includegraphics[width=\textwidth]{figure/Dpost-1}
  \end{center}
\end{frame}








\begin{frame}
  \frametitle{Summary}
  This is perhaps the most general approach to modeling population
  dynamics, especially when the model includes a movement process. \\
  \pause \vfill
  Requires a lot of data on marked individuals, but it should be no
  surprise that we need a lot of data to understand complex
  processes. \\ 
  \pause \vfill
  Integrated population models can be used to draw inferences using
  this model and a combination of data on marked and unmarked
  individuals. \\ 
\end{frame}




\end{document}





% \section{Spatial JS with density-dependence}







% \begin{frame}
%   \frametitle{Density-dependent recruitment}
%   \large
%   {Logistic}
%   \[
%      \gamma_t = \gamma_{max}(1 - N_{t-1}/K)
%   \]
%   \vfill
%   {Log-linear}
%   \[
%      \gamma_t = \nu_0\exp(-\nu_1 N_{t-1})
%   \]
%   \vfill
%   {Log-linear (alt version)}
%   \[
%     \log(\gamma_t) = \nu_0 + \nu_1 N_{t-1}
%   \]
% \end{frame}






% \begin{frame}[fragile]
%   \frametitle{Density-dependent recruitment}
%   \tiny
% <<dd1,fig.height=5,out.width='90%',fig.align='center'>>=
% N <- 0:50
% nu0 <- 2
% nu1 <- 0.05
% plot(N, nu0*exp(-nu1*N), type="l", ylim=c(0,2), ylab="Per-capita Recruitment")
% @
% %\vspace{-4mm}
% %\begin{center}
% %  \includegraphics[width=\textwidth]{figure/dd1-1}
% %\end{center}
% \end{frame}




% \begin{frame}[fragile]
%   \frametitle{Simulating spatial JS data with robust design}
%   \scriptsize % \tiny %\small
%   {Parameters and data dimensions}
% <<sim-pars-robust>>=
% T <- 10      # years/primary periods
% K <- 3       # 3 secondary sampling occasion
% ## Is it necessary to be far from equilibrium to detect density-dependence?
% ## Equilibrium here is where (1-phi) == gamma, where gamma is function of N
% N0 <- 10     # Abundance in year 1
% M <- 500     # Easiest way to simulate data is using data augmentation
% phi <- 0.7   # Apparent survival
% ##gamma <- 0.3 # Per-capital recruitment rate
% nu0 <- 2
% nu1 <- 0.05
% p0 <- 0.4
% sigma <- 0.1
% @
% \pause
% {Traps, activity centers, and detection probability}
% <<sim-p-robust>>=
% set.seed(3479)
% co <- seq(0.25, 0.75, length=5)
% x <- cbind(rep(co, each=5), rep(co, times=5))
% J <- nrow(x)
% xlim <- ylim <- c(0,1)
% s <- cbind(runif(M, xlim[1], xlim[2]), runif(M, ylim[1], ylim[2]))
% d <- p <- matrix(NA, M, J)
% for(i in 1:M) {
%     d[i,] <- sqrt((s[i,1]-x[,1])^2 + (s[i,2]-x[,2])^2)
%     p[i,] <- p0*exp(-d[i,]^2/(2*sigma^2))
% }
% @
% \end{frame}





% \begin{frame}[fragile]
%   \frametitle{Simulating spatial JS data with robust design}
% {Generate $z$}
% \scriptsize
% <<sim-RS-robust>>=
% set.seed(3401)
% z2 <- recruitable <- died <- recruited <- matrix(0, M, T)
% z2[1:N0,1] <- 1 # First N0 are alive
% recruitable[(N0+1):M,1] <- 1
% for(t in 2:T) {
%     prevN <- sum(z2[,t-1]) # number alive at t-1
%     gamma <- nu0*exp(-nu1*prevN) ## Density dependent recruitment rate
%     ER <- prevN*gamma # expected number of recruits
%     prevA <- sum(recruitable[,t-1]) # Number available to be recruited
%     gammaPrime <- ER/prevA
%     if(gammaPrime > 1)
%         stop("M isn't big enough")
%     for(i in 1:M) {
%         z2[i,t] <- rbinom(1, 1, z2[i,t-1]*phi + recruitable[i,t-1]*gammaPrime)
%         recruitable[i,t] <- 1 - max(z2[i,1:(t)]) # to be recruited
%         died[i,t] <- z2[i,t-1]==1 & z2[i,t]==0
%         recruited[i,t] <- z2[i,t]==1 & z2[i,t-1]==0
%     }
% }
% @
% \pause
% \vfill
% {\normalsize Populaton size, mortalities, and recruits}
% <<sim-N-robust>>=
% N2 <- colSums(z2) # Population size
% Deaths2 <- colSums(died)
% Recruits2 <- colSums(recruited)
% everAlive2 <- sum(rowSums(z2)>0)
% @
% \end{frame}









% \begin{frame}[fragile]
%   \frametitle{Simulating spatial JS data with robust design}
% {Generate encounter histories for all $M$ individuals}
% \footnotesize
% <<sim-yall-robust>>=
% yall <- array(NA, c(M, J, K, T))
% for(i in 1:M) {
%     for(t in 1:T) {
%         for(j in 1:J) {
%             yall[i,j,1:K,t] <- rbinom(K, 1, z2[i,t]*p[i,j])
%         }
%     }
% }
% @
% \pause
% \vfill
% {\normalsize Discard individuals that were never captured}
% <<sim-y-robust>>=
% detected <- rowSums(yall) > 0
% y2 <- yall[detected,,,]
% str(y2)
% @
% \end{frame}






% \begin{frame}[fragile]
%   \frametitle{Time series}
%   \tiny
% <<NDR-DD,include=FALSE,echo=FALSE,fig.width=8,fig.height=6>>=
% plot(1:T, N2, ylim=c(0, 50), type="o", pch=16,
%      xlab="Year", ylab="")
% lines(2:T, Deaths2[-1], col="red", type="o", pch=16)
% lines(2:T, Recruits2[-1], col="blue", type="o", pch=16)
% legend(1, 50, c("Population size", "Deaths", "Recruits"),
%        col=c("black", "red", "blue"), pch=16, lty=1)
% @
% \vspace{-3mm}
% \begin{center}
%   \includegraphics[width=\textwidth]{figure/NDR-DD-1}
% \end{center}
% \end{frame}



% \begin{frame}[fragile]
%   \frametitle{Spatial CJS model in \jags}
%   \vspace{-5mm}
%   \tiny \fbox{\parbox{\linewidth}{\verbatiminput{JS-spatial-DD.jag}}}
% \end{frame}





% \begin{frame}[fragile]
%   \frametitle{\jags}
% %  \footnotesize
%   {Data augmentation}
%   \scriptsize
% <<aug-robust>>=
% M2 <- nrow(y2) + 75
% yz2 <- array(0, c(M2, J, K, T))
% yz2[1:nrow(y2),,,] <- y2
% @
% \pause
% \vfill
%   {\normalsize Initial values for $z$ matrix}
% <<zi-robust>>=
% zi <- matrix(0, M2, T)
% ##zi[1:nrow(y2),] <- 1
% zi[1:nrow(y2),] <- z2[detected,] ## cheating
% ji2 <- function() list(phi=0.01, z=zi)
% @
% \pause
% \vfill
%   {\normalsize Fit the model}
% <<jags-run-robust,results='hide',cache=TRUE>>=
% jd2 <- list(y=yz2, M=M2, x=x,
%             J=J, K=K, T=T, xlim=xlim, ylim=ylim)
% jp2 <- c("phi", "nu0", "nu1", "p0", "sigma", "N", "Deaths", "Recruits", "Ntot")
% library(rjags)
% jm2 <- jags.model("JS-spatial-DD.jag", jd2, ji2, n.chains=1, n.adapt=2)
% jc2 <- coda.samples(jm2, jp2, 5)
% ##jc2.2 <- coda.samples(jm2, jp2, 15000)
% @
% \end{frame}




% \begin{frame}[fragile]
%   \frametitle{Posterior distributions}
% <<jc2,include=FALSE,echo=FALSE>>=
% plot(jc2[,c("phi", "nu0", "nu1")])
% @
% \begin{center}
%   \fbox{\includegraphics[width=0.7\textwidth]{figure/jc2-1}}
% \end{center}
% \end{frame}










% \begin{frame}[fragile]
%   \frametitle{Actual and estimated abundance}
%   {Extract and summarize posterior samples of $N_t$}
%   \footnotesize
% <<N-post-samples>>=
% Npost <- as.matrix(jc2[,paste("N[", 1:10, "]", sep="")])
% Nmed <- apply(Npost, 2, median)
% Nupper <- apply(Npost, 2, quantile, prob=0.975)
% Nlower <- apply(Npost, 2, quantile, prob=0.025)
% @
%   \pause
%   \vfill
%   {\normalsize Plot}
% <<Npost,include=FALSE>>=
% plot(1:T, N2, type="o", col="blue", ylim=c(0, 100), xlab="Time",
%      ylab="Abundance")
% points(1:T, Nmed)
% arrows(1:T, Nlower, 1:T, Nupper, angle=90, code=3, length=0.05)
% legend(1, 100, c("Actual abundance", "Estimated abundance"),
%        col=c("blue", "black"), lty=c(1,1), pch=c(1,1))
% @
% \end{frame}





% \begin{frame}
%   \frametitle{Actual and estimated abundance}
%   \vspace{-4mm}
%   \begin{center}
%     \includegraphics[width=0.8\textwidth]{figure/Npost-1}
%   \end{center}
% \end{frame}










\begin{frame}
  \frametitle{Summary}
  \large
  {Key points}
  \begin{itemize}[<+->]
    \item Spatial Jolly-Seber models make it possible to fit
      spatio-temporal models of population dynamics to standard data
    \item We could have movement just like we did with CJS models
    \item Lots of tricks for speeding up MCMC
    \begin{itemize}
      \item Replace \inr{ER[t] <- N[t]*gamma} with \inr{ER[t] <- EN[t]*gamma} where \inr{EN} is the expected value of $N$.
      \item Repalce \inr{recruitable[i,t-1]*gammaPrime[t-1]} with \inr{Erecruitable[i,t-1]*gammaPrime[t-1]}, which again is expected value rather than the realized value
      \item These tricks result in approximations, but they should be very close to desired inferences. 
    \end{itemize}
  \end{itemize}
\end{frame}



% \begin{frame}
%   \frametitle{Assignment}
%   {\large For next week}
%   \begin{enumerate}[\bf (1)]
%     \item Work on analysis of your own data and your final paper, which should include:
%       \begin{itemize}
%         \item Introduction
%         \item Methods (including model description)
%         \item Results
%         \item Discussion
%       \end{itemize}
%     \item Paper should be a minimum of 4 pages, single-spaced, 12-pt font
%   \end{enumerate}
% \end{frame}






\end{document}








